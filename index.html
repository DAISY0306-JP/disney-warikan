<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        .header h1 { color: #333; font-size: 28px; margin-bottom: 10px; }
        .header p { color: #666; font-size: 14px; }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .action-buttons button, .action-buttons label {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-export { background: #48bb78; color: white; }
        .btn-import { background: #3182ce; color: white; }
        .btn-settlement { background: #ed8936; color: white; }
        .btn-screenshot { background: #9f7aea; color: white; }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .input-group { margin-bottom: 15px; }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .member-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .member-item {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .member-item input { flex: 1; }
        .member-item button {
            padding: 8px 12px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
        }
        .btn-add {
            background: #3182ce;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
        }
        .btn-secondary {
            background: #48bb78;
            color: white;
            margin-right: 10px;
        }
        .btn-danger {
            background: #f56565;
            color: white;
        }
        .expense-list { max-height: 400px; overflow-y: auto; }
        .expense-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .expense-title { font-weight: 600; color: #333; font-size: 16px; }
        .expense-amount { font-weight: 700; color: #667eea; font-size: 18px; }
        .expense-details { font-size: 13px; color: #666; margin-bottom: 5px; }
        .expense-actions { display: flex; gap: 10px; margin-top: 10px; }
        .expense-actions button { padding: 6px 12px; font-size: 12px; }
        .category-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
            background: #e2e8f0;
            color: #2d3748;
        }
        .settlement-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .settlement-text { color: #333; font-size: 14px; }
        .settlement-amount { font-weight: 700; color: #f56565; font-size: 16px; }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .summary-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .summary-label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .summary-value { font-size: 20px; font-weight: 700; color: #667eea; }
        .currency-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            background: #f7fafc;
            padding: 5px;
            border-radius: 8px;
        }
        .currency-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
        }
        .currency-btn.active { background: #667eea; color: white; }
        .receipt-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content { max-width: 90%; max-height: 90%; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .empty-state svg { width: 64px; height: 64px; margin-bottom: 15px; opacity: 0.3; }
        .category-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .category-tag {
            background: #e2e8f0;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .category-tag button {
            background: none;
            border: none;
            color: #f56565;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
        }
        .settlement-modal {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
        }
        .close-modal {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        .deposit-section {
            background: #fffbeb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #fbbf24;
        }
        .deposit-label { font-weight: 600; color: #92400e; }
        .deposit-value { font-weight: 700; color: #d97706; font-size: 16px; }
        input[type="file"] { display: none; }
        .info-text {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</h1>
            <p>ã‚°ãƒ«ãƒ¼ãƒ—ã®æ”¯å‡ºã‚’ç°¡å˜ç®¡ç†</p>
            <div class="action-buttons">
                <button class="btn-export" onclick="exportData()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
                <label for="importFile" class="btn-import" style="display: inline-block;">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿èª­è¾¼</label>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                <button class="btn-settlement" onclick="showSettlementModal()">ğŸ’³ ç²¾ç®—ç”»é¢</button>
                <button class="btn-screenshot" onclick="downloadSettlement()">ğŸ“¸ ç”»åƒä¿å­˜</button>
            </div>
        </div>

```
    <div class="main-content">
        <div class="card">
            <h2>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š</h2>
            <div class="member-list" id="memberList"></div>
            <button class="btn btn-add" onclick="addMember()">+ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>
        </div>

        <div class="card">
            <h2>ğŸ’µ é ã‹ã‚Šé‡‘ï¼ˆäº‹å‰é›†é‡‘ï¼‰</h2>
            <div class="info-text">
                äº‹å‰ã«é›†ã‚ãŸãŠé‡‘ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚é ã‹ã£ãŸäººã®è² æ‹…ãŒå¢—ãˆã€é ã‘ãŸäººã®è² æ‹…ãŒæ¸›ã‚Šã¾ã™ã€‚
            </div>
            <div class="input-group">
                <label>èª°ãŒé ã‹ã£ãŸï¼Ÿ</label>
                <select id="depositHolder"><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select>
            </div>
            <div class="input-group">
                <label>èª°ã‹ã‚‰é ã‹ã£ãŸï¼Ÿ</label>
                <select id="depositFrom"><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select>
            </div>
            <div class="input-group">
                <label>é‡‘é¡</label>
                <input type="number" id="depositAmount" placeholder="0" min="0">
            </div>
            <div class="currency-toggle">
                <button class="currency-btn active" onclick="setDepositCurrency('JPY')">å†† (JPY)</button>
                <button class="currency-btn" onclick="setDepositCurrency('USD')">ãƒ‰ãƒ« (USD)</button>
            </div>
            <button class="btn btn-primary" onclick="addDeposit()">é ã‹ã‚Šé‡‘ã‚’è¨˜éŒ²</button>
            <div id="depositsList" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 20px;">
        <h2>ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªç®¡ç†</h2>
        <div class="category-list" id="categoryList"></div>
        <div class="input-group">
            <input type="text" id="newCategory" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªå">
        </div>
        <button class="btn btn-add" onclick="addCategory()">+ ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button>
    </div>

    <div class="card" style="margin-bottom: 20px;">
        <h2>ğŸ’° æ”¯æ‰•ã„è¨˜éŒ²ã‚’è¿½åŠ </h2>
        <div class="currency-toggle">
            <button class="currency-btn active" onclick="setCurrency('JPY')">å†† (JPY)</button>
            <button class="currency-btn" onclick="setCurrency('USD')">ãƒ‰ãƒ« (USD)</button>
        </div>
        <div class="input-group">
            <label>é …ç›®å</label>
            <input type="text" id="expenseName" placeholder="ä¾‹: ãƒ©ãƒ³ãƒä»£">
        </div>
        <div class="input-group">
            <label>é‡‘é¡</label>
            <input type="number" id="expenseAmount" placeholder="0" min="0" step="0.01">
        </div>
        <div class="input-group">
            <label>ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="expenseCategory"></select>
        </div>
        <div class="input-group">
            <label>æ”¯æ‰•ã£ãŸäºº</label>
            <select id="paidBy"><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select>
        </div>
        <div class="input-group">
            <label>å‚åŠ è€…ï¼ˆã“ã®æ”¯æ‰•ã„ã‚’å‰²ã‚Šå‹˜ã™ã‚‹äººï¼‰</label>
            <div class="checkbox-group" id="participantsCheckbox"></div>
        </div>
        <div class="input-group">
            <label>ãƒ¬ã‚·ãƒ¼ãƒˆå†™çœŸï¼ˆä»»æ„ï¼‰</label>
            <input type="file" id="receiptImage" accept="image/*">
        </div>
        <div class="input-group">
            <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="expenseMemo" rows="2" placeholder="è¿½åŠ ãƒ¡ãƒ¢"></textarea>
        </div>
        <button class="btn btn-primary" onclick="addExpense()">æ”¯æ‰•ã„ã‚’è¿½åŠ </button>
    </div>

    <div class="card">
        <h2>ğŸ“ æ”¯æ‰•ã„ä¸€è¦§</h2>
        <div class="expense-list" id="expenseList">
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p>ã¾ã æ”¯æ‰•ã„è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </div>
    </div>

    <div class="main-content" style="margin-top: 20px;">
        <div class="card">
            <h2>ğŸ’³ ç²¾ç®—æƒ…å ±</h2>
            <div id="depositSummary"></div>
            <div class="summary-grid" id="summaryGrid"></div>
            <div id="settlementList" class="settlement-list"></div>
        </div>
        <div class="card">
            <h2>ğŸ“Š çµ±è¨ˆ</h2>
            <div id="statistics"></div>
        </div>
    </div>
</div>

<div class="modal" id="imageModal" onclick="closeModal()">
    <img class="modal-content" id="modalImage">
</div>

<div class="modal" id="settlementModal" onclick="closeSettlementModal(event)">
    <div class="settlement-modal" id="settlementContent" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="closeSettlementModal()">&times;</span>
        <div id="settlementDisplay"></div>
    </div>
</div>

<script>
    let members=[];let expenses=[];let deposits=[];let categories=['é£Ÿäº‹','ãƒã‚±ãƒƒãƒˆ','ãŠåœŸç”£','äº¤é€šè²»','ãã®ä»–'];
    let currentCurrency='JPY';let currentDepositCurrency='JPY';let editingIndex=-1;
    window.onload=()=>{loadData();initializeMembers();updateDisplay()};
    function initializeMembers(){if(!members.length)members=[''];updateMemberList();updateMemberSelects();updateCategoryList();updateCategorySelect()}
    function addMember(){members.push('');updateMemberList();updateMemberSelects();saveData()}
    function removeMember(i){if(members.length<=1){alert('æœ€ä½1äººã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå¿…è¦ã§ã™');return}if(confirm('ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){members.splice(i,1);updateMemberList();updateMemberSelects();saveData();updateDisplay()}}
    function updateMemberName(i,v){members[i]=v;updateMemberSelects();saveData();updateDisplay()}
    function updateMemberList(){document.getElementById('memberList').innerHTML=members.map((m,i)=>`<div class="member-item"><input type="text" value="${m}" placeholder="ãƒ¡ãƒ³ãƒãƒ¼${i+1}" onchange="updateMemberName(${i},this.value)">${members.length>1?`<button onclick="removeMember(${i})">å‰Šé™¤</button>`:''}</div>`).join('')}
    function updateMemberSelects(){const opts='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>'+members.map((m,i)=>`<option value="${i}">${m||'ãƒ¡ãƒ³ãƒãƒ¼'+(i+1)}</option>`).join('');['paidBy','depositHolder','depositFrom'].forEach(id=>document.getElementById(id).innerHTML=opts);document.getElementById('participantsCheckbox').innerHTML=members.map((m,i)=>`<div class="checkbox-item"><input type="checkbox" id="participant${i}" value="${i}" checked><label for="participant${i}">${m||'ãƒ¡ãƒ³ãƒãƒ¼'+(i+1)}</label></div>`).join('')}
    function addCategory(){const c=document.getElementById('newCategory').value.trim();if(!c){alert('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return}if(categories.includes(c)){alert('ã“ã®ã‚«ãƒ†ã‚´ãƒªã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');return}categories.push(c);document.getElementById('newCategory').value='';updateCategoryList();updateCategorySelect();saveData()}
    function removeCategory(c){if(confirm(`ã‚«ãƒ†ã‚´ãƒªã€Œ${c}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)){categories=categories.filter(x=>x!==c);updateCategoryList();updateCategorySelect();saveData()}}
    function updateCategoryList(){document.getElementById('categoryList').innerHTML=categories.map(c=>`<div class="category-tag">${c}<button onclick="removeCategory('${c}')">&times;</button></div>`).join('')}
    function updateCategorySelect(){document.getElementById('expenseCategory').innerHTML=categories.map(c=>`<option value="${c}">${c}</option>`).join('')}
    function setCurrency(c){currentCurrency=c;document.querySelectorAll('.card:nth-of-type(3) .currency-toggle .currency-btn').forEach((b,i)=>{b.classList.remove('active');if((c==='JPY'&&i===0)||(c==='USD'&&i===1))b.classList.add('active')})}
    function setDepositCurrency(c){currentDepositCurrency=c;document.querySelectorAll('.main-content .card:nth-child(2) .currency-toggle .currency-btn').forEach((b,i)=>{b.classList.remove('active');if((c==='JPY'&&i===0)||(c==='USD'&&i===1))b.classList.add('active')})}
    function addDeposit(){const h=parseInt(document.getElementById('depositHolder').value);const f=parseInt(document.getElementById('depositFrom').value);const a=parseFloat(document.getElementById('depositAmount').value);if(isNaN(h)||isNaN(f)||!a||a<=0){alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return}if(h===f){alert('é ã‹ã£ãŸäººã¨é ã‘ãŸäººã¯åˆ¥ã®äººã‚’é¸æŠã—ã¦ãã ã•ã„');return}deposits.push({holder:h,from:f,amount:a,currency:currentDepositCurrency,timestamp:new Date().toISOString()});document.getElementById('depositHolder').value='';document.getElementById('depositFrom').value='';document.getElementById('depositAmount').value='';saveData();updateDisplay();displayDeposits()}
    function deleteDeposit(i){if(confirm('ã“ã®é ã‹ã‚Šé‡‘è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){deposits.splice(i,1);saveData();updateDisplay();displayDeposits()}}
    function displayDeposits(){const d=document.getElementById('depositsList');if(!deposits.length){d.innerHTML='';return}d.innerHTML='<h3 style="margin-bottom:10px;font-size:14px;">é ã‹ã‚Šé‡‘ä¸€è¦§</h3>'+deposits.map((dep,i)=>{const h=members[dep.holder]||'ãƒ¡ãƒ³ãƒãƒ¼'+(dep.holder+1);const f=members[dep.from]||'ãƒ¡ãƒ³ãƒãƒ¼'+(dep.from+1);const a=dep.currency==='JPY'?`Â¥${dep.amount.toLocaleString()}`:`$${dep.amount.toFixed(2)}`;return`<div class="settlement-item" style="margin-bottom:8px;"><span>${h} ãŒ ${f} ã‹ã‚‰é ã‹ã£ãŸ</span><div style="display:flex;align-items:center;gap:10px;"><span style="font-weight:700;color:#d97706;">${a}</span><button class="btn btn-danger" style="padding:4px 8px;font-size:11px;" onclick="deleteDeposit(${i})">å‰Šé™¤</button></div></div>`}).join('')}
    async function addExpense(){const n=document.getElementById('expenseName').value.trim();const a=parseFloat(document.getElementById('expenseAmount').value);const c=document.getElementById('expenseCategory').value;const p=parseInt(document.getElementById('paidBy').value);const m=document.getElementById('expenseMemo').value.trim();const f=document.getElementById('receiptImage').files[0];if(!n||!a||a<=0||isNaN(p)){alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return}const pts=[];members.forEach((_,i)=>{const cb=document.getElementById(`participant${i}`);if(cb&&cb.checked)pts.push(i)});if(!pts.length){alert('å°‘ãªãã¨ã‚‚1äººã®å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');return}let img=null;if(f)img=await readFileAsDataURL(f);const exp={name:n,amount:a,currency:currentCurrency,category:c,paidBy:p,participants:pts,memo:m,image:img,timestamp:new Date().toISOString()};if(editingIndex>=0){expenses[editingIndex]=exp;editingIndex=-1}else{expenses.push(exp)}saveData();clearForm();updateDisplay()}
    function readFileAsDataURL(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=rej;r.readAsDataURL(f)})}
    function clearForm(){document.getElementById('expenseName').value='';document.getElementById('expenseAmount').value='';document.getElementById('expenseCategory').value=categories[0];document.getElementById('paidBy').value='';document.getElementById('expenseMemo').value='';document.getElementById('receiptImage').value='';members.forEach((_,i)=>{const cb=document.getElementById(`participant${i}`);if(cb)cb.checked=true})}
    function editExpense(i){const e=expenses[i];editingIndex=i;document.getElementById('expenseName').value=e.name;document.getElementById('expenseAmount').value=e.amount;document.getElementById('expenseCategory').value=e.category;document.getElementById('paidBy').value=e.paidBy;document.getElementById('expenseMemo').value=e.memo||'';currentCurrency=e.currency;setCurrency(e.currency);members.forEach((_,idx)=>{const cb=document.getElementById(`participant${idx}`);if(cb)cb.checked=e.participants.includes(idx)});window.scrollTo({top:0,behavior:'smooth'})}
    function deleteExpense(i){if(confirm('ã“ã®æ”¯æ‰•ã„è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){expenses.splice(i,1);saveData();updateDisplay()}}
    function updateDisplay(){displayExpenses();calculateSettlement();displayStatistics();displayDeposits()}
    function displayExpenses(){const l=document.getElementById('expenseList');if(!expenses.length){l.innerHTML='<div class="empty-state"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><p>ã¾ã æ”¯æ‰•ã„è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';return}l.innerHTML=expenses.map((e,i)=>{const pts=e.participants.map(idx=>members[idx]||'ãƒ¡ãƒ³ãƒãƒ¼'+(idx+1)).join(', ');const amt=e.currency==='JPY'?`Â¥${e.amount.toLocaleString()}`:`$${e.amount.toFixed(2)}`;const pby=members[e.paidBy]||'ãƒ¡ãƒ³ãƒãƒ¼'+(e.paidBy+1);return`<div class="expense-item"><div class="expense-header"><div class="expense-title">${e.name}</div><div class="expense-amount">${amt}</div></div><div class="expense-details"><span class="category-badge">${e.category}</span>æ”¯æ‰•ã„: ${pby}</div><div class="expense-details">å‚åŠ è€…: ${pts}</div>${e.memo?`<div class="expense-details">ãƒ¡ãƒ¢: ${e.memo}</div>`:''}${e.image?`<img src="${e.image}" class="receipt-preview" onclick="showImage('${e.image}')">`:''}  <div class="expense-actions"><button class="btn btn-secondary" onclick="editExpense(${i})">ç·¨é›†</button><button class="btn btn-danger" onclick="deleteExpense(${i})">å‰Šé™¤</button></div></div>`}).join('')}
    function showImage(s){document.getElementById('modalImage').src=s;document.getElementById('imageModal').classList.add('active')}
    function closeModal(){document.getElementById('imageModal').classList.remove('active')}
    function calculateSettlement(){if(!members.length){document.getElementById('summaryGrid').innerHTML='';document.getElementById('settlementList').innerHTML='';document.getElementById('depositSummary').innerHTML='';return}const bj=Array(members.length).fill(0);const bu=Array(members.length).fill(0);const dj=Array(members.length).fill(0);const du=Array(members.length).fill(0);deposits.forEach(d=>{if(d.currency==='JPY'){dj[d.holder]+=d.amount;dj[d.from]-=d.amount}else{du[d.holder]+=d.amount;du[d.from]-=d.amount}});expenses.forEach(e=>{const pp=e.amount/e.participants.length;const b=e.currency==='JPY'?bj:bu;b[e.paidBy]+=e.amount;e.participants.forEach(i=>b[i]-=pp)});for(let i=0;i<members.length;i++){bj[i]-=dj[i];bu[i]-=du[i]}displayDepositSummary(dj,du);const sg=document.getElementById('summaryGrid');sg.innerHTML=members.map((m,i)=>{const j=bj[i];const u=bu[i];const db=j!==0?`Â¥${Math.round(j).toLocaleString()}`:u!==0?`$${u.toFixed(2)}`:'Â¥0';return`<div class="summary-card"><div class="summary-label">${m||'ãƒ¡ãƒ³ãƒãƒ¼'+(i+1)}</div><div class="summary-value">${db}</div></div>`}).join('');const sl=document.getElementById('settlementList');let sh='<h3 style="margin-top:20px;margin-bottom:15px;color:#333;">ç²¾ç®—æ–¹æ³•</h3>';const sj=calculateSettlementTransactions(bj);if(sj.length){sh+='<div style="margin-bottom:15px;font-weight:600;color:#667eea;">å†† (JPY)</div>';sj.forEach(s=>{const fn=members[s.from]||'ãƒ¡ãƒ³ãƒãƒ¼'+(s.from+1);const tn=members[s.to]||'ãƒ¡ãƒ³ãƒãƒ¼'+(s.to+1);sh+=`<div class="settlement-item"><div class="settlement-text">${fn} â†’ ${tn}</div><div class="settlement-amount">Â¥${Math.round(s.amount).toLocaleString()}</div></div>`})}const su=calculateSettlementTransactions(bu);if(su.length){sh+='<div style="margin-top:20px;margin-bottom:15px;font-weight:600;color:#667eea;">ãƒ‰ãƒ« (USD)</div>';su.forEach(s=>{const fn=members[s.from]||'ãƒ¡ãƒ³ãƒãƒ¼'+(s.from+1);const tn=members[s.to]||'ãƒ¡ãƒ³ãƒãƒ¼'+(s.to+1);sh+=`<div class="settlement-item"><div class="settlement-text">${fn} â†’ ${tn}</div><div class="settlement-amount">$${s.amount.toFixed(2)}</div></div>`})}if(!sj.length&&!su.length)sh+='<p style="text-align:center;color:#999;padding:20px;">ç²¾ç®—ã®å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“</p>';sl.innerHTML=sh}
    function displayDepositSummary(dj,du){const d=document.getElementById('depositSummary');if(!deposits.length){d.innerHTML='';return}let h='<div class="deposit-section"><h3 style="margin-bottom:10px;color:#92400e;">ğŸ’µ äº‹å‰é›†é‡‘ã®å½±éŸ¿</h3>';members.forEach((m,i)=>{if(Math.abs(dj[i])>0.01||Math.abs(du[i])>0.01){const mn=m||'ãƒ¡ãƒ³ãƒãƒ¼'+(i+1);const lb=dj[i]>0||du[i]>0?'è¿”ã™ç¾©å‹™':'å—ã‘å–ã‚‹æ¨©åˆ©';h+=`<div class="deposit-item"><span class="deposit-label">${mn} (${lb})</span><div>`;if(Math.abs(dj[i])>0.01)h+=`<div class="deposit-value">Â¥${Math.abs(dj[i]).toLocaleString()}</div>`;if(Math.abs(du[i])>0.01)h+=`<div class="deposit-value">$${Math.abs(du[i]).toFixed(2)}</div>`;h+='</div></div>'}});h+='</div>';d.innerHTML=h}
    function calculateSettlementTransactions(b){const t=[];const c=[];const d=[];b.forEach((bal,i)=>{if(bal>0.01)c.push({idx:i,amount:bal});else if(bal<-0.01)d.push({idx:i,amount:-bal})});let i=0,j=0;while(i<c.length&&j<d.length){const cr=c[i];const db=d[j];const a=Math.min(cr.amount,db.amount);t.push({from:db.idx,to:cr.idx,amount:a});cr.amount-=a;db.amount-=a;if(cr.amount<0.01)i++;if(db.amount<0.01)j++}return t}
    function displayStatistics(){const s=document.getElementById('statistics');if(!expenses.length){s.innerHTML='<p style="text-align:center;color:#999;padding:20px;">çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';return}const ct={};categories.forEach(c=>ct[c]={jpy:0,usd:0});let tj=0,tu=0;expenses.forEach(e=>{if(!ct[e.category])ct[e.category]={jpy:0,usd:0};if(e.currency==='JPY'){ct[e.category].jpy+=e.amount;tj+=e.amount}else{ct[e.category].usd+=e.amount;tu+=e.amount}});let h='<div style="margin-bottom:20px;"><h3 style="margin-bottom:15px;color:#333;">ç·æ”¯å‡º</h3>';if(tj>0)h+=`<div class="summary-card" style="margin-bottom:10px;"><div class="summary-label">å†† (JPY)</div><div class="summary-value">Â¥${tj.toLocaleString()}</div></div>`;if(tu>0)h+=`<div class="summary-card"><div class="summary-label">ãƒ‰ãƒ« (USD)</div><div class="summary-value">$${tu.toFixed(2)}</div></div>`;h+='</div><h3 style="margin-bottom:15px;color:#333;">ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡º</h3>';for(const[k,v]of Object.entries(ct)){if(v.jpy>0||v.usd>0){h+=`<div class="settlement-item" style="margin-bottom:8px;"><div class="settlement-text">${k}</div><div>`;if(v.jpy>0)h+=`<div style="font-weight:600;color:#667eea;">Â¥${v.jpy.toLocaleString()}</div>`;if(v.usd>0)h+=`<div style="font-weight:600;color:#667eea;">$${v.usd.toFixed(2)}</div>`;h+='</div></div>'}}s.innerHTML=h}
    function showSettlementModal(){const m=document.getElementById('settlementModal');const d=document.getElementById('settlementDisplay');let h='<h2 style="margin-bottom:20px;">ğŸ’³ ç²¾ç®—æƒ…å ±</h2>';h+=document.getElementById('depositSummary').innerHTML;h+='<div class="summary-grid">'+document.getElementById('summaryGrid').innerHTML+'</div>';h+=document.getElementById('settlementList').innerHTML;d.innerHTML=h;m.classList.add('active')}
    function closeSettlementModal(e){if(!e||e.target.id==='settlementModal'||e.target.classList.contains('close-modal'))document.getElementById('settlementModal').classList.remove('active')}
    function downloadSettlement(){showSettlementModal();setTimeout(()=>{const c=document.getElementById('settlementContent');const cb=c.querySelector('.close-modal');if(cb)cb.style.display='none';html2canvas(c,{scale:2,backgroundColor:'#ffffff',logging:false}).then(cv=>{const l=document.createElement('a');l.download='ç²¾ç®—æƒ…å ±_'+new Date().toISOString().split('T')[0]+'.png';l.href=cv.toDataURL();l.click();if(cb)cb.style.display='block'}).catch(err=>{console.error(err);alert('ç”»åƒä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');if(cb)cb.style.display='block'})},100)}
    function exportData(){const d={members,expenses,deposits,categories,exportDate:new Date().toISOString()};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const l=document.createElement('a');l.href=u;l.download='warikan_data_'+new Date().toISOString().split('T')[0]+'.json';l.click();URL.revokeObjectURL(u)}
    function importData(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=function(ev){try{const d=JSON.parse(ev.target.result);if(d.members)members=d.members;if(d.expenses)expenses=d.expenses;if(d.deposits)deposits=d.deposits;if(d.categories)categories=d.categories;saveData();updateMemberList();updateMemberSelects();updateCategoryList();updateCategorySelect();updateDisplay();alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ')}catch(err){alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');console.error(err)}};r.readAsText(f);e.target.value=''}
    function saveData(){localStorage.setItem('warikanMembers',JSON.stringify(members));localStorage.setItem('warikanExpenses',JSON.stringify(expenses));localStorage.setItem('warikanDeposits',JSON.stringify(deposits));localStorage.setItem('warikanCategories',JSON.stringify(categories))}
    function loadData(){const sm=localStorage.getItem('warikanMembers');const se=localStorage.getItem('warikanExpenses');const sd=localStorage.getItem('warikanDeposits');const sc=localStorage.getItem('warikanCategories');if(sm)members=JSON.parse(sm);if(se)expenses=JSON.parse(se);if(sd)deposits=JSON.parse(sd);if(sc)categories=JSON.parse(sc)}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
```

</body>
</html>