<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼æ—…è¡Œ å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .header {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        text-align: center;
    }

    .header h1 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
    }

    .header p {
        color: #666;
        font-size: 14px;
    }

    .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
        }
    }

    .card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
        color: #333;
        font-size: 20px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
    }

    .member-setup {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }

    @media (max-width: 768px) {
        .member-setup {
            grid-template-columns: 1fr;
        }
    }

    .input-group {
        margin-bottom: 15px;
    }

    .input-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-size: 14px;
        font-weight: 500;
    }

    .input-group input,
    .input-group select,
    .input-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .input-group input:focus,
    .input-group select:focus,
    .input-group textarea:focus {
        outline: none;
        border-color: #667eea;
    }

    .checkbox-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .checkbox-item label {
        cursor: pointer;
        color: #555;
        font-size: 14px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #667eea;
        color: white;
        width: 100%;
    }

    .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
        background: #48bb78;
        color: white;
        margin-right: 10px;
    }

    .btn-secondary:hover {
        background: #38a169;
    }

    .btn-danger {
        background: #f56565;
        color: white;
    }

    .btn-danger:hover {
        background: #e53e3e;
    }

    .expense-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .expense-item {
        background: #f7fafc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
    }

    .expense-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .expense-title {
        font-weight: 600;
        color: #333;
        font-size: 16px;
    }

    .expense-amount {
        font-weight: 700;
        color: #667eea;
        font-size: 18px;
    }

    .expense-details {
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
    }

    .expense-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .expense-actions button {
        padding: 6px 12px;
        font-size: 12px;
    }

    .category-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-right: 8px;
    }

    .category-food { background: #fef5e7; color: #d68910; }
    .category-ticket { background: #ebf5fb; color: #2874a6; }
    .category-souvenir { background: #f4ecf7; color: #7d3c98; }
    .category-transport { background: #eafaf1; color: #229954; }
    .category-other { background: #fef9e7; color: #b9770e; }

    .settlement-list {
        margin-top: 20px;
    }

    .settlement-item {
        background: #f7fafc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .settlement-text {
        color: #333;
        font-size: 14px;
    }

    .settlement-amount {
        font-weight: 700;
        color: #f56565;
        font-size: 16px;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 20px;
    }

    .summary-card {
        background: #f7fafc;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }

    .summary-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
    }

    .summary-value {
        font-size: 20px;
        font-weight: 700;
        color: #667eea;
    }

    .currency-toggle {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        background: #f7fafc;
        padding: 5px;
        border-radius: 8px;
    }

    .currency-btn {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 6px;
        background: transparent;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .currency-btn.active {
        background: #667eea;
        color: white;
    }

    .receipt-preview {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        margin-top: 10px;
        cursor: pointer;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        max-width: 90%;
        max-height: 90%;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 15px;
        opacity: 0.3;
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ° ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼æ—…è¡Œ å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</h1>
            <p>ã‚¢ãƒ¡ãƒªã‚«ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼4äººæ—…ã®æ”¯å‡ºã‚’ç°¡å˜ç®¡ç†</p>
        </div>

```
    <div class="main-content">
        <!-- ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š -->
        <div class="card">
            <h2>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š</h2>
            <div class="member-setup">
                <div class="input-group">
                    <label>ãƒ¡ãƒ³ãƒãƒ¼1</label>
                    <input type="text" id="member1" placeholder="åå‰ã‚’å…¥åŠ›">
                </div>
                <div class="input-group">
                    <label>ãƒ¡ãƒ³ãƒãƒ¼2</label>
                    <input type="text" id="member2" placeholder="åå‰ã‚’å…¥åŠ›">
                </div>
                <div class="input-group">
                    <label>ãƒ¡ãƒ³ãƒãƒ¼3</label>
                    <input type="text" id="member3" placeholder="åå‰ã‚’å…¥åŠ›">
                </div>
                <div class="input-group">
                    <label>ãƒ¡ãƒ³ãƒãƒ¼4</label>
                    <input type="text" id="member4" placeholder="åå‰ã‚’å…¥åŠ›">
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveMembers()">ãƒ¡ãƒ³ãƒãƒ¼ã‚’ä¿å­˜</button>
        </div>

        <!-- æ”¯æ‰•ã„è¿½åŠ  -->
        <div class="card">
            <h2>ğŸ’° æ”¯æ‰•ã„è¨˜éŒ²ã‚’è¿½åŠ </h2>
            
            <div class="currency-toggle">
                <button class="currency-btn active" onclick="setCurrency('JPY')">å†† (JPY)</button>
                <button class="currency-btn" onclick="setCurrency('USD')">ãƒ‰ãƒ« (USD)</button>
            </div>

            <div class="input-group">
                <label>é …ç›®å</label>
                <input type="text" id="expenseName" placeholder="ä¾‹: ãƒ©ãƒ³ãƒä»£">
            </div>

            <div class="input-group">
                <label>é‡‘é¡</label>
                <input type="number" id="expenseAmount" placeholder="0" min="0" step="0.01">
            </div>

            <div class="input-group">
                <label>ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="expenseCategory">
                    <option value="food">ğŸ” é£Ÿäº‹</option>
                    <option value="ticket">ğŸ« ãƒã‚±ãƒƒãƒˆ</option>
                    <option value="souvenir">ğŸ ãŠåœŸç”£</option>
                    <option value="transport">ğŸš— äº¤é€šè²»</option>
                    <option value="other">ğŸ“¦ ãã®ä»–</option>
                </select>
            </div>

            <div class="input-group">
                <label>æ”¯æ‰•ã£ãŸäºº</label>
                <select id="paidBy">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
            </div>

            <div class="input-group">
                <label>å‚åŠ è€…ï¼ˆã“ã®æ”¯æ‰•ã„ã‚’å‰²ã‚Šå‹˜ã™ã‚‹äººï¼‰</label>
                <div class="checkbox-group" id="participantsCheckbox">
                </div>
            </div>

            <div class="input-group">
                <label>ãƒ¬ã‚·ãƒ¼ãƒˆå†™çœŸï¼ˆä»»æ„ï¼‰</label>
                <input type="file" id="receiptImage" accept="image/*">
            </div>

            <div class="input-group">
                <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                <textarea id="expenseMemo" rows="2" placeholder="è¿½åŠ ãƒ¡ãƒ¢"></textarea>
            </div>

            <button class="btn btn-primary" onclick="addExpense()">æ”¯æ‰•ã„ã‚’è¿½åŠ </button>
        </div>
    </div>

    <!-- æ”¯æ‰•ã„ä¸€è¦§ -->
    <div class="card">
        <h2>ğŸ“ æ”¯æ‰•ã„ä¸€è¦§</h2>
        <div class="expense-list" id="expenseList">
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p>ã¾ã æ”¯æ‰•ã„è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </div>
    </div>

    <!-- ç²¾ç®— -->
    <div class="main-content">
        <div class="card">
            <h2>ğŸ’³ ç²¾ç®—æƒ…å ±</h2>
            <div class="summary-grid" id="summaryGrid">
            </div>
            <div class="settlement-list" id="settlementList">
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“Š çµ±è¨ˆ</h2>
            <div id="statistics"></div>
        </div>
    </div>
</div>

<!-- ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="imageModal" onclick="closeModal()">
    <img class="modal-content" id="modalImage">
</div>

<script>
    let members = [];
    let expenses = [];
    let currentCurrency = 'JPY';
    let editingIndex = -1;

    // åˆæœŸåŒ–
    window.onload = function() {
        loadData();
        updateMemberSelects();
        updateDisplay();
    };

    // é€šè²¨è¨­å®š
    function setCurrency(currency) {
        currentCurrency = currency;
        document.querySelectorAll('.currency-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    };

    // ãƒ¡ãƒ³ãƒãƒ¼ä¿å­˜
    function saveMembers() {
        members = [
            document.getElementById('member1').value.trim(),
            document.getElementById('member2').value.trim(),
            document.getElementById('member3').value.trim(),
            document.getElementById('member4').value.trim()
        ].filter(m => m !== '');

        if (members.length === 0) {
            alert('å°‘ãªãã¨ã‚‚1äººã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        saveData();
        updateMemberSelects();
        alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    };

    // ãƒ¡ãƒ³ãƒãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°
    function updateMemberSelects() {
        const paidBySelect = document.getElementById('paidBy');
        const participantsDiv = document.getElementById('participantsCheckbox');
        
        paidBySelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        participantsDiv.innerHTML = '';

        members.forEach((member, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = member;
            paidBySelect.appendChild(option);

            const checkboxItem = document.createElement('div');
            checkboxItem.className = 'checkbox-item';
            checkboxItem.innerHTML = `
                <input type="checkbox" id="participant${index}" value="${index}" checked>
                <label for="participant${index}">${member}</label>
            `;
            participantsDiv.appendChild(checkboxItem);
        });
    };

    // æ”¯æ‰•ã„è¿½åŠ 
    async function addExpense() {
        if (members.length === 0) {
            alert('å…ˆã«ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„');
            return;
        }

        const name = document.getElementById('expenseName').value.trim();
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        const category = document.getElementById('expenseCategory').value;
        const paidBy = parseInt(document.getElementById('paidBy').value);
        const memo = document.getElementById('expenseMemo').value.trim();
        const imageFile = document.getElementById('receiptImage').files[0];

        if (!name || !amount || amount <= 0 || isNaN(paidBy)) {
            alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        const participants = [];
        members.forEach((_, index) => {
            if (document.getElementById(`participant${index}`).checked) {
                participants.push(index);
            }
        });

        if (participants.length === 0) {
            alert('å°‘ãªãã¨ã‚‚1äººã®å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        let imageData = null;
        if (imageFile) {
            imageData = await readFileAsDataURL(imageFile);
        }

        const expense = {
            name,
            amount,
            currency: currentCurrency,
            category,
            paidBy,
            participants,
            memo,
            image: imageData,
            timestamp: new Date().toISOString()
        };

        if (editingIndex >= 0) {
            expenses[editingIndex] = expense;
            editingIndex = -1;
        } else {
            expenses.push(expense);
        }

        saveData();
        clearForm();
        updateDisplay();
    };

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’DataURLã¨ã—ã¦èª­ã¿è¾¼ã‚€
    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    };

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
    function clearForm() {
        document.getElementById('expenseName').value = '';
        document.getElementById('expenseAmount').value = '';
        document.getElementById('expenseCategory').value = 'food';
        document.getElementById('paidBy').value = '';
        document.getElementById('expenseMemo').value = '';
        document.getElementById('receiptImage').value = '';
        
        members.forEach((_, index) => {
            const checkbox = document.getElementById(`participant${index}`);
            if (checkbox) checkbox.checked = true;
        });
    };

    // æ”¯æ‰•ã„ç·¨é›†
    function editExpense(index) {
        const expense = expenses[index];
        editingIndex = index;

        document.getElementById('expenseName').value = expense.name;
        document.getElementById('expenseAmount').value = expense.amount;
        document.getElementById('expenseCategory').value = expense.category;
        document.getElementById('paidBy').value = expense.paidBy;
        document.getElementById('expenseMemo').value = expense.memo || '';

        currentCurrency = expense.currency;
        document.querySelectorAll('.currency-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.includes(expense.currency)) {
                btn.classList.add('active');
            }
        });

        members.forEach((_, idx) => {
            const checkbox = document.getElementById(`participant${idx}`);
            if (checkbox) {
                checkbox.checked = expense.participants.includes(idx);
            }
        });

        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // æ”¯æ‰•ã„å‰Šé™¤
    function deleteExpense(index) {
        if (confirm('ã“ã®æ”¯æ‰•ã„è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            expenses.splice(index, 1);
            saveData();
            updateDisplay();
        }
    };

    // è¡¨ç¤ºæ›´æ–°
    function updateDisplay() {
        displayExpenses();
        calculateSettlement();
        displayStatistics();
    };

    // æ”¯æ‰•ã„ä¸€è¦§è¡¨ç¤º
    function displayExpenses() {
        const listDiv = document.getElementById('expenseList');
        
        if (expenses.length === 0) {
            listDiv.innerHTML = `
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>ã¾ã æ”¯æ‰•ã„è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            `;
            return;
        }

        listDiv.innerHTML = expenses.map((exp, index) => {
            const categoryNames = {
                food: 'ğŸ” é£Ÿäº‹',
                ticket: 'ğŸ« ãƒã‚±ãƒƒãƒˆ',
                souvenir: 'ğŸ ãŠåœŸç”£',
                transport: 'ğŸš— äº¤é€šè²»',
                other: 'ğŸ“¦ ãã®ä»–'
            };

            const participantNames = exp.participants.map(idx => members[idx]).join(', ');
            const amountDisplay = exp.currency === 'JPY' 
                ? `Â¥${exp.amount.toLocaleString()}` 
                : `$${exp.amount.toFixed(2)}`;

            return `
                <div class="expense-item">
                    <div class="expense-header">
                        <div class="expense-title">${exp.name}</div>
                        <div class="expense-amount">${amountDisplay}</div>
                    </div>
                    <div class="expense-details">
                        <span class="category-badge category-${exp.category}">${categoryNames[exp.category]}</span>
                        æ”¯æ‰•ã„: ${members[exp.paidBy]}
                    </div>
                    <div class="expense-details">
                        å‚åŠ è€…: ${participantNames}
                    </div>
                    ${exp.memo ? `<div class="expense-details">ãƒ¡ãƒ¢: ${exp.memo}</div>` : ''}
                    ${exp.image ? `<img src="${exp.image}" class="receipt-preview" onclick="showImage('${exp.image}')">` : ''}
                    <div class="expense-actions">
                        <button class="btn btn-secondary" onclick="editExpense(${index})">ç·¨é›†</button>
                        <button class="btn btn-danger" onclick="deleteExpense(${index})">å‰Šé™¤</button>
                    </div>
                </div>
            `;
        }).join('');
    };

    // ç”»åƒè¡¨ç¤º
    function showImage(src) {
        document.getElementById('modalImage').src = src;
        document.getElementById('imageModal').classList.add('active');
    };

    function closeModal() {
        document.getElementById('imageModal').classList.remove('active');
    };

    // ç²¾ç®—è¨ˆç®—
    function calculateSettlement() {
        if (members.length === 0) {
            document.getElementById('summaryGrid').innerHTML = '';
            document.getElementById('settlementList').innerHTML = '';
            return;
        }

        // é€šè²¨åˆ¥ã«é›†è¨ˆ
        const balanceJPY = Array(members.length).fill(0);
        const balanceUSD = Array(members.length).fill(0);

        expenses.forEach(exp => {
            const perPerson = exp.amount / exp.participants.length;
            const balance = exp.currency === 'JPY' ? balanceJPY : balanceUSD;

            balance[exp.paidBy] += exp.amount;
            exp.participants.forEach(idx => {
                balance[idx] -= perPerson;
            });
        });

        // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        const summaryDiv = document.getElementById('summaryGrid');
        summaryDiv.innerHTML = members.map((member, idx) => {
            const jpy = balanceJPY[idx];
            const usd = balanceUSD[idx];
            const displayBalance = jpy !== 0 
                ? `Â¥${Math.round(jpy).toLocaleString()}` 
                : usd !== 0 ? `$${usd.toFixed(2)}` : 'Â¥0';
            
            return `
                <div class="summary-card">
                    <div class="summary-label">${member}</div>
                    <div class="summary-value">${displayBalance}</div>
                </div>
            `;
        }).join('');

        // ç²¾ç®—ãƒªã‚¹ãƒˆä½œæˆï¼ˆé€šè²¨åˆ¥ï¼‰
        const settlementDiv = document.getElementById('settlementList');
        let settlementHTML = '<h3 style="margin-top: 20px; margin-bottom: 15px; color: #333;">ç²¾ç®—æ–¹æ³•</h3>';

        // JPYç²¾ç®—
        const settlementsJPY = calculateSettlementTransactions(balanceJPY);
        if (settlementsJPY.length > 0) {
            settlementHTML += '<div style="margin-bottom: 15px; font-weight: 600; color: #667eea;">å†† (JPY)</div>';
            settlementsJPY.forEach(s => {
                settlementHTML += `
                    <div class="settlement-item">
                        <div class="settlement-text">
                            ${members[s.from]} â†’ ${members[s.to]}
                        </div>
                        <div class="settlement-amount">Â¥${Math.round(s.amount).toLocaleString()}</div>
                    </div>
                `;
            });
        }

        // USDç²¾ç®—
        const settlementsUSD = calculateSettlementTransactions(balanceUSD);
        if (settlementsUSD.length > 0) {
            settlementHTML += '<div style="margin-top: 20px; margin-bottom: 15px; font-weight: 600; color: #667eea;">ãƒ‰ãƒ« (USD)</div>';
            settlementsUSD.forEach(s => {
                settlementHTML += `
                    <div class="settlement-item">
                        <div class="settlement-text">
                            ${members[s.from]} â†’ ${members[s.to]}
                        </div>
                        <div class="settlement-amount">$${s.amount.toFixed(2)}</div>
                    </div>
                `;
            });
        }

        if (settlementsJPY.length === 0 && settlementsUSD.length === 0) {
            settlementHTML += '<p style="text-align: center; color: #999; padding: 20px;">ç²¾ç®—ã®å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }

        settlementDiv.innerHTML = settlementHTML;
    };

    // ç²¾ç®—ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç®—
    function calculateSettlementTransactions(balances) {
        const transactions = [];
        const creditors = [];
        const debtors = [];

        balances.forEach((balance, idx) => {
            if (balance > 0.01) {
                creditors.push({ idx, amount: balance });
            } else if (balance < -0.01) {
                debtors.push({ idx, amount: -balance });
            }
        });

        let i = 0, j = 0;
        while (i < creditors.length && j < debtors.length) {
            const creditor = creditors[i];
            const debtor = debtors[j];
            const amount = Math.min(creditor.amount, debtor.amount);

            transactions.push({
                from: debtor.idx,
                to: creditor.idx,
                amount: amount
            });

            creditor.amount -= amount;
            debtor.amount -= amount;

            if (creditor.amount < 0.01) i++;
            if (debtor.amount < 0.01) j++;
        }

        return transactions;
    };

    // çµ±è¨ˆè¡¨ç¤º
    function displayStatistics() {
        const statsDiv = document.getElementById('statistics');
        
        if (expenses.length === 0) {
            statsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }

        // ã‚«ãƒ†ã‚´ãƒªåˆ¥é›†è¨ˆ
        const categoryTotals = {
            food: { jpy: 0, usd: 0 },
            ticket: { jpy: 0, usd: 0 },
            souvenir: { jpy: 0, usd: 0 },
            transport: { jpy: 0, usd: 0 },
            other: { jpy: 0, usd: 0 }
        };

        let totalJPY = 0;
        let totalUSD = 0;

        expenses.forEach(exp => {
            if (exp.currency === 'JPY') {
                categoryTotals[exp.category].jpy += exp.amount;
                totalJPY += exp.amount;
            } else {
                categoryTotals[exp.category].usd += exp.amount;
                totalUSD += exp.amount;
            }
        });

        const categoryNames = {
            food: 'ğŸ” é£Ÿäº‹',
            ticket: 'ğŸ« ãƒã‚±ãƒƒãƒˆ',
            souvenir: 'ğŸ ãŠåœŸç”£',
            transport: 'ğŸš— äº¤é€šè²»',
            other: 'ğŸ“¦ ãã®ä»–'
        };

        let html = '<div style="margin-bottom: 20px;">';
        html += `<h3 style="margin-bottom: 15px; color: #333;">ç·æ”¯å‡º</h3>`;
        if (totalJPY > 0) {
            html += `<div class="summary-card" style="margin-bottom: 10px;"><div class="summary-label">å†† (JPY)</div><div class="summary-value">Â¥${totalJPY.toLocaleString()}</div></div>`;
        }
        if (totalUSD > 0) {
            html += `<div class="summary-card"><div class="summary-label">ãƒ‰ãƒ« (USD)</div><div class="summary-value">$${totalUSD.toFixed(2)}</div></div>`;
        }
        html += '</div>';

        html += '<h3 style="margin-bottom: 15px; color: #333;">ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡º</h3>';
        
        for (const [key, value] of Object.entries(categoryTotals)) {
            if (value.jpy > 0 || value.usd > 0) {
                html += `<div class="settlement-item" style="margin-bottom: 8px;">`;
                html += `<div class="settlement-text">${categoryNames[key]}</div>`;
                html += `<div>`;
                if (value.jpy > 0) {
                    html += `<div style="font-weight: 600; color: #667eea;">Â¥${value.jpy.toLocaleString()}</div>`;
                }
                if (value.usd > 0) {
                    html += `<div style="font-weight: 600; color: #667eea;">$${value.usd.toFixed(2)}</div>`;
                }
                html += `</div></div>`;
            }
        }

        statsDiv.innerHTML = html;
    };

    // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    function saveData() {
        localStorage.setItem('disneyMembers', JSON.stringify(members));
        localStorage.setItem('disneyExpenses', JSON.stringify(expenses));
    };

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadData() {
        const savedMembers = localStorage.getItem('disneyMembers');
        const savedExpenses = localStorage.getItem('disneyExpenses');

        if (savedMembers) {
            members = JSON.parse(savedMembers);
            members.forEach((member, idx) => {
                document.getElementById(`member${idx + 1}`).value = member;
            });
        }

        if (savedExpenses) {
            expenses = JSON.parse(savedExpenses);
        }
    };
</script>
```

</body>
</html>
