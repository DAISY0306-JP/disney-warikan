<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 15px;
}
.container { max-width: 800px; margin: 0 auto; }
.header {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 15px;
    text-align: center;
}
.header h1 { color: #333; font-size: 24px; margin-bottom: 8px; }
.header p { color: #666; font-size: 13px; }
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
}
.action-buttons button, .action-buttons label {
    padding: 14px 16px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 48px;
}
.btn-export { background: #48bb78; color: white; }
.btn-import { background: #3182ce; color: white; display: flex; align-items: center; justify-content: center; }
.btn-settlement { background: #ed8936; color: white; }
.card {
    background: white;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 15px;
}
.card h2 {
    color: #333;
    font-size: 18px;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 2px solid #667eea;
}
.input-group { margin-bottom: 15px; }
.input-group label {
    display: block;
    margin-bottom: 6px;
    color: #555;
    font-size: 14px;
    font-weight: 600;
}
.input-group input, .input-group select, .input-group textarea {
    width: 100%;
    padding: 16px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 16px;
    transition: border-color 0.2s;
}
.input-group input:focus, .input-group select:focus {
    outline: none;
    border-color: #667eea;
}
.member-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}
.member-item {
    display: flex;
    gap: 10px;
    align-items: center;
}
.member-item input { flex: 1; padding: 16px; font-size: 16px; }
.member-item button {
    padding: 12px 16px;
    background: #f56565;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    min-height: 48px;
}
.checkbox-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 15px;
}
.checkbox-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: #f7fafc;
    border-radius: 8px;
}
.checkbox-item input[type="checkbox"] {
    width: 24px;
    height: 24px;
    cursor: pointer;
}
.checkbox-item label {
    cursor: pointer;
    color: #555;
    font-size: 15px;
}
.btn {
    padding: 16px 24px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 56px;
}
.btn-primary {
    background: #667eea;
    color: white;
    width: 100%;
}
.btn-primary:active { transform: scale(0.98); }
.btn-add {
    background: #3182ce;
    color: white;
    padding: 12px 20px;
    font-size: 15px;
    min-height: 48px;
}
.btn-secondary {
    background: #48bb78;
    color: white;
    padding: 10px 16px;
    font-size: 14px;
    min-height: 44px;
}
.btn-danger {
    background: #f56565;
    color: white;
    padding: 10px 16px;
    font-size: 14px;
    min-height: 44px;
}
.expense-list { max-height: 500px; overflow-y: auto; }
.expense-item {
    background: #f7fafc;
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 12px;
    border-left: 4px solid #667eea;
}
.expense-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.expense-title { font-weight: 600; color: #333; font-size: 16px; }
.expense-amount { font-weight: 700; color: #667eea; font-size: 18px; }
.expense-details { font-size: 14px; color: #666; margin-bottom: 6px; }
.expense-actions { display: flex; gap: 10px; margin-top: 12px; }
.category-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    margin-right: 8px;
    background: #e2e8f0;
    color: #2d3748;
}
.settlement-item {
    background: #f7fafc;
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.settlement-text { color: #333; font-size: 15px; }
.settlement-amount { font-weight: 700; color: #f56565; font-size: 17px; }
.summary-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 15px;
}
.summary-card {
    background: #f7fafc;
    padding: 16px;
    border-radius: 10px;
    text-align: center;
}
.summary-label { font-size: 13px; color: #666; margin-bottom: 6px; }
.summary-value { font-size: 20px; font-weight: 700; color: #667eea; }
.currency-toggle {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 15px;
    background: #f7fafc;
    padding: 6px;
    border-radius: 10px;
}
.currency-btn {
    padding: 12px;
    border: none;
    border-radius: 8px;
    background: transparent;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.2s;
    min-height: 48px;
}
.currency-btn.active { background: #667eea; color: white; }
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.modal.active { display: flex; }
.empty-state { text-align: center; padding: 40px 20px; color: #999; }
.category-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
}
.category-tag {
    background: #e2e8f0;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.category-tag button {
    background: none;
    border: none;
    color: #f56565;
    cursor: pointer;
    font-size: 18px;
    padding: 0;
    width: 24px;
    height: 24px;
}
.settlement-modal {
    background: white;
    padding: 25px;
    border-radius: 15px;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    width: 90%;
}
.close-modal {
    float: right;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    color: #999;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.deposit-section {
    background: #fffbeb;
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 2px solid #fbbf24;
}
.deposit-label { font-weight: 600; color: #92400e; font-size: 14px; }
.deposit-value { font-weight: 700; color: #d97706; font-size: 17px; }
input[type="file"] { display: none; }
.info-text {
    font-size: 13px;
    color: #666;
    margin-bottom: 15px;
    padding: 12px;
    background: #f7fafc;
    border-radius: 8px;
    line-height: 1.5;
}
.rate-display {
    background: #e0e7ff;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    text-align: center;
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>ğŸ’° å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</h1>
<p>ã‚°ãƒ«ãƒ¼ãƒ—ã®æ”¯å‡ºã‚’ç°¡å˜ç®¡ç†</p>
<div class="action-buttons">
<button class="btn-export" onclick="exportData()">ğŸ“¥ ä¿å­˜</button>
<label for="importFile" class="btn-import">ğŸ“¤ èª­è¾¼</label>
<input type="file" id="importFile" accept=".json" onchange="importData(event)">
<button class="btn-settlement" onclick="showSettlementModal()">ğŸ’³ ç²¾ç®—</button>
<button style="background:#10b981;color:white;padding:14px 16px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;min-height:48px;" onclick="showBudgetModal()">ğŸ’° äºˆç®—è¨­å®š</button>
</div>
<div id="rateDisplay" class="rate-display">
<span id="rateText"></span>
</div>
</div>

<div class="card">
<h2>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ <button id="toggleMemberBtn" onclick="toggleMemberEdit()" style="float:right;padding:8px 16px;background:#667eea;color:white;border:none;border-radius:8px;font-size:13px;cursor:pointer;">ç·¨é›†</button></h2>
<div id="memberDisplay" style="padding:10px 0;"></div>
<div id="memberEdit" style="display:none;">
<div class="member-list" id="memberList"></div>
<button class="btn btn-add" onclick="addMember()">+ è¿½åŠ </button>
<button class="btn btn-primary" onclick="saveMemberEdit()" style="margin-top:10px;">ç¢ºå®š</button>
</div>
</div>

<div class="card">
<h2>ğŸ’µ é ã‹ã‚Šé‡‘</h2>
<div class="info-text">äº‹å‰ã«é›†ã‚ãŸãŠé‡‘ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚é ã‹ã£ãŸäººã®è² æ‹…ãŒå¢—ãˆã€é ã‘ãŸäººã®è² æ‹…ãŒæ¸›ã‚Šã¾ã™ã€‚</div>
<div class="input-group">
<label>èª°ãŒé ã‹ã£ãŸï¼Ÿ</label>
<select id="depositHolder"><option value="">é¸æŠ</option></select>
</div>
<div class="input-group">
<label>èª°ã‹ã‚‰é ã‹ã£ãŸï¼Ÿ</label>
<select id="depositFrom"><option value="">é¸æŠ</option></select>
</div>
<div class="input-group">
<label>é‡‘é¡</label>
<input type="number" id="depositAmount" placeholder="0" min="0" max="10000000">
</div>
<div class="currency-toggle" id="depositCurrencyToggle">
<button class="currency-btn active" onclick="setDepositCurrency('JPY')">å††</button>
<button class="currency-btn" onclick="setDepositCurrency('USD')">ãƒ‰ãƒ«</button>
</div>
<button class="btn btn-primary" onclick="addDeposit()">è¨˜éŒ²</button>
<div id="depositsList" style="margin-top:15px;"></div>
</div>

<div class="card">
<h2>ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª</h2>
<div class="category-list" id="categoryList"></div>
<div class="input-group">
<input type="text" id="newCategory" placeholder="æ–°ã‚«ãƒ†ã‚´ãƒªå" maxlength="50">
</div>
<button class="btn btn-add" onclick="addCategory()">+ è¿½åŠ </button>
</div>

<div class="card">
<h2>ğŸ’° æ”¯æ‰•ã„è¨˜éŒ²</h2>
<div class="currency-toggle" id="expenseCurrencyToggle">
<button class="currency-btn active" onclick="setCurrency('JPY')">å††</button>
<button class="currency-btn" onclick="setCurrency('USD')">ãƒ‰ãƒ«</button>
</div>
<div class="input-group">
<label>é …ç›®å</label>
<input type="text" id="expenseName" placeholder="ä¾‹: ãƒ©ãƒ³ãƒä»£" maxlength="100">
</div>
<div class="input-group">
<label>é‡‘é¡</label>
<input type="number" id="expenseAmount" placeholder="0" min="0" max="10000000" step="0.01">
</div>
<div class="input-group">
<label>ã‚«ãƒ†ã‚´ãƒª</label>
<select id="expenseCategory"></select>
</div>
<div class="input-group">
<label>æ”¯æ‰•ã£ãŸäºº</label>
<select id="paidBy"><option value="">é¸æŠ</option></select>
</div>
<div class="input-group">
<label>å‚åŠ è€…</label>
<div class="checkbox-group" id="participantsCheckbox"></div>
</div>
<div class="input-group">
<label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
<textarea id="expenseMemo" rows="2" placeholder="ãƒ¡ãƒ¢" maxlength="200"></textarea>
</div>
<button class="btn btn-primary" onclick="addExpense()">è¿½åŠ </button>
</div>

<div class="card">
<h2>ğŸ“ æ”¯æ‰•ã„ä¸€è¦§</h2>
<div class="expense-list" id="expenseList">
<div class="empty-state"><p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>
</div>
</div>

<div class="card">
<h2>ğŸ’³ ç²¾ç®—</h2>
<div id="depositSummary"></div>
<div class="summary-grid" id="summaryGrid"></div>
<div id="settlementList" class="settlement-list"></div>
</div>

<div class="card">
<h2>ğŸ“… æ—¥åˆ¥ã‚µãƒãƒªãƒ¼</h2>
<div id="dailySummary"></div>
</div>

<div class="card">
<h2>ğŸ“Š çµ±è¨ˆ</h2>
<div id="statistics"></div>
</div>
</div>

<div class="modal" id="settlementModal" onclick="closeSettlementModal(event)">
<div class="settlement-modal" id="settlementContent" onclick="event.stopPropagation()">
<span class="close-modal" onclick="closeSettlementModal()">&times;</span>
<div id="settlementDisplay"></div>
</div>
</div>

<div class="modal" id="budgetModal" onclick="closeBudgetModal(event)">
<div class="settlement-modal" onclick="event.stopPropagation()">
<span class="close-modal" onclick="closeBudgetModal()">&times;</span>
<h2 style="margin-bottom:20px;text-align:center;">ğŸ’° äºˆç®—è¨­å®š</h2>
<div class="info-text">æ—…è¡Œã®é–‹å§‹æ—¥ã¨1æ—¥ã‚ãŸã‚Šã®äºˆç®—ã‚’è¨­å®šã—ã¾ã™</div>
<div class="input-group">
<label>æ—…è¡Œé–‹å§‹æ—¥</label>
<input type="date" id="tripStart" style="padding:14px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;width:100%;">
</div>
<div class="input-group">
<label>1æ—¥ã®äºˆç®—ï¼ˆå††ï¼‰</label>
<input type="number" id="budgetJPY" placeholder="30000" min="0" style="padding:14px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;width:100%;">
</div>
<div class="input-group">
<label>1æ—¥ã®äºˆç®—ï¼ˆãƒ‰ãƒ«ï¼‰</label>
<input type="number" id="budgetUSD" placeholder="200" min="0" style="padding:14px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;width:100%;">
</div>
<button class="btn btn-primary" onclick="saveBudget()">ä¿å­˜</button>
</div>
</div>

<script>
const MAX_MEMBERS=10;const MAX_EXPENSES=100;const MAX_DEPOSITS=100;const MAX_CATEGORIES=50;const MAX_FILE_SIZE=1024*1024;const MAX_STRING_LEN=200;
let members=[];let expenses=[];let deposits=[];let categories=['é£Ÿäº‹','ãƒã‚±ãƒƒãƒˆ','ãŠåœŸç”£','äº¤é€šè²»','ãã®ä»–'];
let currentCurrency='JPY';let currentDepositCurrency='JPY';let editingIndex=-1;let exchangeRate=150;
let dailyBudgetJPY=0;let dailyBudgetUSD=0;let tripStartDate=null;
const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); // innerHTMLç”¨ï¼ˆç¾åœ¨ã¯æœªä½¿ç”¨ã€textContentã‚’ä½¿ç”¨ï¼‰
const sanitize=s=>String(s||'').substring(0,MAX_STRING_LEN);
const validateNum=(n,min=0,max=10000000)=>{const v=parseFloat(n);return !isNaN(v)&&v>=min&&v<=max?v:null};
window.onload=()=>{loadData();initializeMembers();updateDisplay();showRateDisplay();updateMemberDisplay()};
function toggleMemberEdit(){const edit=document.getElementById('memberEdit');const display=document.getElementById('memberDisplay');const btn=document.getElementById('toggleMemberBtn');if(edit.style.display==='none'){edit.style.display='block';display.style.display='none';btn.textContent='ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}else{edit.style.display='none';display.style.display='block';btn.textContent='ç·¨é›†';updateMemberDisplay()}}
function saveMemberEdit(){document.getElementById('memberEdit').style.display='none';document.getElementById('memberDisplay').style.display='block';document.getElementById('toggleMemberBtn').textContent='ç·¨é›†';updateMemberDisplay();saveData()}
function updateMemberDisplay(){const d=document.getElementById('memberDisplay');if(members.every(m=>!m)){d.innerHTML='<p style="color:#999;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>';return}d.innerHTML='';members.forEach((m,i)=>{if(m){const span=document.createElement('span');span.style.cssText='display:inline-block;background:#e2e8f0;padding:8px 16px;margin:5px;border-radius:8px;font-size:15px;';span.textContent=m;d.appendChild(span)}})};
function showRateDisplay(){const btn=document.createElement('button');btn.textContent='å¤‰æ›´';btn.style.cssText='margin-left:10px;padding:4px 8px;background:#667eea;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;';btn.onclick=setManualRate;const span=document.createElement('span');span.textContent=`ğŸ’± ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ: $1 = Â¥${exchangeRate.toFixed(2)} `;span.appendChild(btn);const rt=document.getElementById('rateText');rt.textContent='';rt.appendChild(span)}
function setManualRate(){const r=prompt('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 150ï¼‰',exchangeRate);const v=validateNum(r,1,1000);if(v){exchangeRate=v;localStorage.setItem('exchangeRate',exchangeRate);showRateDisplay();updateDisplay();alert('ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ')}}
function initializeMembers(){if(!members.length)members=[''];updateMemberList();updateMemberSelects();updateCategoryList();updateCategorySelect()}
function addMember(){if(members.length>=MAX_MEMBERS){alert(`æœ€å¤§${MAX_MEMBERS}äººã¾ã§`);return}members.push('');updateMemberList();updateMemberSelects();saveData()}
function removeMember(i){if(members.length<=1){alert('æœ€ä½1äººå¿…è¦');return}if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){members.splice(i,1);updateMemberList();updateMemberSelects();saveData();updateDisplay()}}
function updateMemberName(i,v){members[i]=sanitize(v);updateMemberSelects();saveData();updateDisplay()}
function updateMemberList(){const d=document.getElementById('memberList');d.innerHTML='';members.forEach((m,i)=>{const div=document.createElement('div');div.className='member-item';const inp=document.createElement('input');inp.type='text';inp.value=m;inp.placeholder=`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`;inp.maxLength=50;inp.onchange=e=>updateMemberName(i,e.target.value);div.appendChild(inp);if(members.length>1){const btn=document.createElement('button');btn.textContent='å‰Šé™¤';btn.onclick=()=>removeMember(i);div.appendChild(btn)}d.appendChild(div)})}
function updateMemberSelects(){const opts=[{v:'',t:'é¸æŠ'},...members.map((m,i)=>({v:i,t:m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`}))];['paidBy','depositHolder','depositFrom'].forEach(id=>{const s=document.getElementById(id);s.innerHTML='';opts.forEach(o=>{const opt=document.createElement('option');opt.value=o.v;opt.textContent=sanitize(o.t);s.appendChild(opt)})});const pc=document.getElementById('participantsCheckbox');pc.innerHTML='';members.forEach((m,i)=>{const div=document.createElement('div');div.className='checkbox-item';const cb=document.createElement('input');cb.type='checkbox';cb.id=`participant${i}`;cb.value=i;cb.checked=true;const lbl=document.createElement('label');lbl.htmlFor=`participant${i}`;lbl.textContent=sanitize(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`);div.appendChild(cb);div.appendChild(lbl);pc.appendChild(div)})}
function addCategory(){if(categories.length>=MAX_CATEGORIES){alert(`æœ€å¤§${MAX_CATEGORIES}å€‹ã¾ã§`);return}const c=sanitize(document.getElementById('newCategory').value).trim();if(!c){alert('å…¥åŠ›ã—ã¦ãã ã•ã„');return}if(categories.includes(c)){alert('æ—¢ã«å­˜åœ¨ã—ã¾ã™');return}categories.push(c);document.getElementById('newCategory').value='';updateCategoryList();updateCategorySelect();saveData()}
function removeCategory(c){if(confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)){categories=categories.filter(x=>x!==c);updateCategoryList();updateCategorySelect();saveData()}}
function updateCategoryList(){const d=document.getElementById('categoryList');d.innerHTML='';categories.forEach(c=>{const div=document.createElement('div');div.className='category-tag';const span=document.createElement('span');span.textContent=c;div.appendChild(span);const btn=document.createElement('button');btn.textContent='Ã—';btn.onclick=()=>removeCategory(c);div.appendChild(btn);d.appendChild(div)})}
function updateCategorySelect(){const s=document.getElementById('expenseCategory');s.innerHTML='';categories.forEach(c=>{const opt=document.createElement('option');opt.value=c;opt.textContent=c;s.appendChild(opt)})}
function setCurrency(c){currentCurrency=c;document.querySelectorAll('#expenseCurrencyToggle .currency-btn').forEach((b,i)=>{b.classList.remove('active');if((c==='JPY'&&i===0)||(c==='USD'&&i===1))b.classList.add('active')})}
function setDepositCurrency(c){currentDepositCurrency=c;document.querySelectorAll('#depositCurrencyToggle .currency-btn').forEach((b,i)=>{b.classList.remove('active');if((c==='JPY'&&i===0)||(c==='USD'&&i===1))b.classList.add('active')})}
function addDeposit(){if(deposits.length>=MAX_DEPOSITS){alert(`æœ€å¤§${MAX_DEPOSITS}ä»¶ã¾ã§`);return}const h=parseInt(document.getElementById('depositHolder').value);const f=parseInt(document.getElementById('depositFrom').value);const a=validateNum(document.getElementById('depositAmount').value);if(isNaN(h)||isNaN(f)||!a){alert('å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');return}if(h===f){alert('åˆ¥ã®äººã‚’é¸æŠ');return}deposits.push({holder:h,from:f,amount:a,currency:currentDepositCurrency,timestamp:new Date().toISOString()});document.getElementById('depositHolder').value='';document.getElementById('depositFrom').value='';document.getElementById('depositAmount').value='';saveData();updateDisplay();displayDeposits()}
function deleteDeposit(i){if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){deposits.splice(i,1);saveData();updateDisplay();displayDeposits()}}
function displayDeposits(){const d=document.getElementById('depositsList');if(!deposits.length){d.innerHTML='';return}const h3=document.createElement('h3');h3.style.cssText='margin-bottom:10px;font-size:14px;font-weight:600;';h3.textContent='ä¸€è¦§';d.innerHTML='';d.appendChild(h3);deposits.forEach((dep,i)=>{const div=document.createElement('div');div.className='settlement-item';const sp1=document.createElement('span');sp1.textContent=`${sanitize(members[dep.holder]||`ãƒ¡ãƒ³ãƒãƒ¼${dep.holder+1}`)}ãŒ${sanitize(members[dep.from]||`ãƒ¡ãƒ³ãƒãƒ¼${dep.from+1}`)}ã‹ã‚‰`;const sp2=document.createElement('span');sp2.style.cssText='font-weight:700;color:#d97706;';sp2.textContent=dep.currency==='JPY'?`Â¥${dep.amount.toLocaleString()}`:`$${dep.amount.toFixed(2)}`;const btn=document.createElement('button');btn.className='btn btn-danger';btn.style.cssText='padding:8px 12px;font-size:12px;min-height:auto;';btn.textContent='å‰Šé™¤';btn.onclick=()=>deleteDeposit(i);const wrap=document.createElement('div');wrap.style.cssText='display:flex;align-items:center;gap:10px;';wrap.appendChild(sp2);wrap.appendChild(btn);div.appendChild(sp1);div.appendChild(wrap);d.appendChild(div)})}
function addExpense(){if(expenses.length>=MAX_EXPENSES){alert(`æœ€å¤§${MAX_EXPENSES}ä»¶ã¾ã§`);return}const n=sanitize(document.getElementById('expenseName').value).trim();const a=validateNum(document.getElementById('expenseAmount').value);const c=document.getElementById('expenseCategory').value;const p=parseInt(document.getElementById('paidBy').value);const m=sanitize(document.getElementById('expenseMemo').value);if(!n||!a||isNaN(p)){alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›');return}const pts=[];members.forEach((_,i)=>{const cb=document.getElementById(`participant${i}`);if(cb&&cb.checked)pts.push(i)});if(!pts.length){alert('å‚åŠ è€…ã‚’é¸æŠ');return}const exp={name:n,amount:a,currency:currentCurrency,category:c,paidBy:p,participants:pts,memo:m,timestamp:new Date().toISOString()};if(editingIndex>=0){expenses[editingIndex]=exp;editingIndex=-1}else{expenses.push(exp)}saveData();clearForm();updateDisplay()}
function clearForm(){document.getElementById('expenseName').value='';document.getElementById('expenseAmount').value='';document.getElementById('expenseCategory').value=categories[0];document.getElementById('paidBy').value='';document.getElementById('expenseMemo').value='';members.forEach((_,i)=>{const cb=document.getElementById(`participant${i}`);if(cb)cb.checked=true})}
function editExpense(i){const e=expenses[i];editingIndex=i;document.getElementById('expenseName').value=e.name;document.getElementById('expenseAmount').value=e.amount;document.getElementById('expenseCategory').value=e.category;document.getElementById('paidBy').value=e.paidBy;document.getElementById('expenseMemo').value=e.memo||'';currentCurrency=e.currency;setCurrency(e.currency);members.forEach((_,idx)=>{const cb=document.getElementById(`participant${idx}`);if(cb)cb.checked=e.participants.includes(idx)});window.scrollTo({top:0,behavior:'smooth'})}
function deleteExpense(i){if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){expenses.splice(i,1);saveData();updateDisplay()}}
function updateDisplay(){displayExpenses();calculateSettlement();displayStatistics();displayDeposits();displayDailySummary()}
function displayExpenses(){const l=document.getElementById('expenseList');if(!expenses.length){l.innerHTML='<div class="empty-state"><p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';return}l.innerHTML='';expenses.forEach((e,i)=>{const div=document.createElement('div');div.className='expense-item';const hdr=document.createElement('div');hdr.className='expense-header';const ttl=document.createElement('div');ttl.className='expense-title';ttl.textContent=e.name;const amt=document.createElement('div');amt.className='expense-amount';amt.textContent=e.currency==='JPY'?`Â¥${e.amount.toLocaleString()}`:`$${e.amount.toFixed(2)}`;if(exchangeRate){const conv=e.currency==='USD'?` (â‰ˆÂ¥${Math.round(e.amount*exchangeRate).toLocaleString()})`:(e.currency==='JPY'?` (â‰ˆ$${(e.amount/exchangeRate).toFixed(2)})`:'');const s=document.createElement('span');s.style.fontSize='12px';s.style.color='#999';s.textContent=conv;amt.appendChild(s)}hdr.appendChild(ttl);hdr.appendChild(amt);const det1=document.createElement('div');det1.className='expense-details';const badge=document.createElement('span');badge.className='category-badge';badge.textContent=e.category;det1.appendChild(badge);const pby=document.createTextNode(`æ”¯æ‰•: ${sanitize(members[e.paidBy]||`ãƒ¡ãƒ³ãƒãƒ¼${e.paidBy+1}`)}`);det1.appendChild(pby);const det2=document.createElement('div');det2.className='expense-details';det2.textContent=`å‚åŠ : ${e.participants.map(idx=>sanitize(members[idx]||`ãƒ¡ãƒ³ãƒãƒ¼${idx+1}`)).join(', ')}`;div.appendChild(hdr);div.appendChild(det1);div.appendChild(det2);if(e.memo){const det3=document.createElement('div');det3.className='expense-details';det3.textContent=`ãƒ¡ãƒ¢: ${e.memo}`;div.appendChild(det3)}const acts=document.createElement('div');acts.className='expense-actions';const btn1=document.createElement('button');btn1.className='btn btn-secondary';btn1.textContent='ç·¨é›†';btn1.onclick=()=>editExpense(i);const btn2=document.createElement('button');btn2.className='btn btn-danger';btn2.textContent='å‰Šé™¤';btn2.onclick=()=>deleteExpense(i);acts.appendChild(btn1);acts.appendChild(btn2);div.appendChild(acts);l.appendChild(div)})}
function calculateSettlement(){if(!members.length){document.getElementById('summaryGrid').innerHTML='';document.getElementById('settlementList').innerHTML='';document.getElementById('depositSummary').innerHTML='';return}const bj=Array(members.length).fill(0);const bu=Array(members.length).fill(0);const dj=Array(members.length).fill(0);const du=Array(members.length).fill(0);deposits.forEach(d=>{if(d.currency==='JPY'){dj[d.holder]+=d.amount;dj[d.from]-=d.amount}else{du[d.holder]+=d.amount;du[d.from]-=d.amount}});expenses.forEach(e=>{const pp=e.amount/e.participants.length;const b=e.currency==='JPY'?bj:bu;b[e.paidBy]+=e.amount;e.participants.forEach(idx=>b[idx]-=pp)});for(let i=0;i<members.length;i++){bj[i]-=dj[i];bu[i]-=du[i]}displayDepositSummary(dj,du);const sg=document.getElementById('summaryGrid');sg.innerHTML='';members.forEach((m,i)=>{const div=document.createElement('div');div.className='summary-card';const lbl=document.createElement('div');lbl.className='summary-label';lbl.textContent=sanitize(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`);const val=document.createElement('div');val.className='summary-value';const j=bj[i];const u=bu[i];val.textContent=j!==0?`Â¥${Math.round(j).toLocaleString()}`:u!==0?`$${u.toFixed(2)}`:'Â¥0';div.appendChild(lbl);div.appendChild(val);sg.appendChild(div)});const sl=document.getElementById('settlementList');sl.innerHTML='';const h3=document.createElement('h3');h3.style.cssText='margin-top:20px;margin-bottom:15px;color:#333;';h3.textContent='ç²¾ç®—æ–¹æ³•';sl.appendChild(h3);const sj=calculateSettlementTransactions(bj);if(sj.length){const hd=document.createElement('div');hd.style.cssText='margin-bottom:12px;font-weight:600;color:#667eea;';hd.textContent='å††';sl.appendChild(hd);sj.forEach(s=>{const div=document.createElement('div');div.className='settlement-item';const t=document.createElement('div');t.className='settlement-text';t.textContent=`${sanitize(members[s.from]||`ãƒ¡ãƒ³ãƒãƒ¼${s.from+1}`)} â†’ ${sanitize(members[s.to]||`ãƒ¡ãƒ³ãƒãƒ¼${s.to+1}`)}`;const a=document.createElement('div');a.className='settlement-amount';a.textContent=`Â¥${Math.round(s.amount).toLocaleString()}`;div.appendChild(t);div.appendChild(a);sl.appendChild(div)})}const su=calculateSettlementTransactions(bu);if(su.length){const hd=document.createElement('div');hd.style.cssText='margin-top:20px;margin-bottom:12px;font-weight:600;color:#667eea;';hd.textContent='ãƒ‰ãƒ«';sl.appendChild(hd);su.forEach(s=>{const div=document.createElement('div');div.className='settlement-item';const t=document.createElement('div');t.className='settlement-text';t.textContent=`${sanitize(members[s.from]||`ãƒ¡ãƒ³ãƒãƒ¼${s.from+1}`)} â†’ ${sanitize(members[s.to]||`ãƒ¡ãƒ³ãƒãƒ¼${s.to+1}`)}`;const a=document.createElement('div');a.className='settlement-amount';a.textContent=`$${s.amount.toFixed(2)}`;div.appendChild(t);div.appendChild(a);sl.appendChild(div)})}if(!sj.length&&!su.length){const p=document.createElement('p');p.style.cssText='text-align:center;color:#999;padding:20px;';p.textContent='ç²¾ç®—ä¸è¦';sl.appendChild(p)}}
function displayDepositSummary(dj,du){const d=document.getElementById('depositSummary');if(!deposits.length){d.innerHTML='';return}const sec=document.createElement('div');sec.className='deposit-section';const h3=document.createElement('h3');h3.style.cssText='margin-bottom:10px;color:#92400e;font-size:15px;';h3.textContent='ğŸ’µ é ã‹ã£ãŸãŠé‡‘';sec.appendChild(h3);members.forEach((m,i)=>{if(Math.abs(dj[i])>0.01||Math.abs(du[i])>0.01){const div=document.createElement('div');div.className='settlement-item';div.style.cssText='background:transparent;padding:8px 0;';const lbl=document.createElement('span');lbl.className='deposit-label';const lb=dj[i]>0||du[i]>0?'è¿”ã™':'ã‚‚ã‚‰ã†';lbl.textContent=`${sanitize(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`)} (${lb})`;const wrap=document.createElement('div');if(Math.abs(dj[i])>0.01){const v=document.createElement('div');v.className='deposit-value';v.textContent=`Â¥${Math.abs(dj[i]).toLocaleString()}`;wrap.appendChild(v)}if(Math.abs(du[i])>0.01){const v=document.createElement('div');v.className='deposit-value';v.textContent=`$${Math.abs(du[i]).toFixed(2)}`;wrap.appendChild(v)}div.appendChild(lbl);div.appendChild(wrap);sec.appendChild(div)}});d.innerHTML='';d.appendChild(sec)}
function calculateSettlementTransactions(b){const t=[];const c=[];const d=[];b.forEach((bal,i)=>{if(bal>0.01)c.push({idx:i,amount:bal});else if(bal<-0.01)d.push({idx:i,amount:-bal})});let i=0,j=0;while(i<c.length&&j<d.length){const cr=c[i];const db=d[j];const a=Math.min(cr.amount,db.amount);t.push({from:db.idx,to:cr.idx,amount:a});cr.amount-=a;db.amount-=a;if(cr.amount<0.01)i++;if(db.amount<0.01)j++}return t}
function displayStatistics(){const s=document.getElementById('statistics');if(!expenses.length){s.innerHTML='<p style="text-align:center;color:#999;padding:20px;">çµ±è¨ˆãªã—</p>';return}const ct={};categories.forEach(c=>ct[c]={jpy:0,usd:0});let tj=0,tu=0;expenses.forEach(e=>{if(!ct[e.category])ct[e.category]={jpy:0,usd:0};if(e.currency==='JPY'){ct[e.category].jpy+=e.amount;tj+=e.amount}else{ct[e.category].usd+=e.amount;tu+=e.amount}});s.innerHTML='';const wrap=document.createElement('div');wrap.style.marginBottom='20px';const h3=document.createElement('h3');h3.style.cssText='margin-bottom:12px;color:#333;font-size:16px;';h3.textContent='ç·æ”¯å‡º';wrap.appendChild(h3);if(tj>0){const div=document.createElement('div');div.className='summary-card';div.style.marginBottom='10px';const lbl=document.createElement('div');lbl.className='summary-label';lbl.textContent='å††';const val=document.createElement('div');val.className='summary-value';val.textContent=`Â¥${tj.toLocaleString()}`;div.appendChild(lbl);div.appendChild(val);wrap.appendChild(div)}if(tu>0){const div=document.createElement('div');div.className='summary-card';const lbl=document.createElement('div');lbl.className='summary-label';lbl.textContent='ãƒ‰ãƒ«';const val=document.createElement('div');val.className='summary-value';val.textContent=`$${tu.toFixed(2)}`;if(exchangeRate){const est=document.createElement('div');est.style.cssText='font-size:12px;color:#999;margin-top:4px;';est.textContent=`â‰ˆÂ¥${Math.round(tu*exchangeRate).toLocaleString()}`;val.appendChild(est)}div.appendChild(lbl);div.appendChild(val);wrap.appendChild(div)}if(tj>0&&tu>0&&exchangeRate){const total=tj+(tu*exchangeRate);const divTotal=document.createElement('div');divTotal.className='summary-card';divTotal.style.cssText='margin-top:10px;background:#667eea;';const lblTotal=document.createElement('div');lblTotal.style.cssText='font-size:12px;color:white;margin-bottom:5px;';lblTotal.textContent='æ¦‚ç®—åˆè¨ˆ';const valTotal=document.createElement('div');valTotal.style.cssText='font-size:20px;font-weight:700;color:white;';valTotal.textContent=`Â¥${Math.round(total).toLocaleString()}`;divTotal.appendChild(lblTotal);divTotal.appendChild(valTotal);wrap.appendChild(divTotal)}s.appendChild(wrap);const h32=document.createElement('h3');h32.style.cssText='margin-bottom:12px;color:#333;font-size:16px;';h32.textContent='ã‚«ãƒ†ã‚´ãƒªåˆ¥';s.appendChild(h32);for(const[k,v]of Object.entries(ct)){if(v.jpy>0||v.usd>0){const div=document.createElement('div');div.className='settlement-item';const t=document.createElement('div');t.className='settlement-text';t.textContent=k;const wrap=document.createElement('div');if(v.jpy>0){const d=document.createElement('div');d.style.cssText='font-weight:600;color:#667eea;';d.textContent=`Â¥${v.jpy.toLocaleString()}`;wrap.appendChild(d)}if(v.usd>0){const d=document.createElement('div');d.style.cssText='font-weight:600;color:#667eea;';d.textContent=`$${v.usd.toFixed(2)}`;if(exchangeRate){const e=document.createElement('span');e.style.cssText='font-size:11px;color:#999;margin-left:4px;';e.textContent=`(â‰ˆÂ¥${Math.round(v.usd*exchangeRate).toLocaleString()})`;d.appendChild(e)}wrap.appendChild(d)}div.appendChild(t);div.appendChild(wrap);s.appendChild(div)}}}
function processReceipt(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{const img=new Image();img.onload=()=>{const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');canvas.width=img.width;canvas.height=img.height;ctx.drawImage(img,0,0);const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);const txt=extractNumbers(imgData);displayOCRCandidates(txt)};img.src=ev.target.result};r.readAsDataURL(f);e.target.value=''}
function extractNumbers(imgData){const nums=[];const threshold=128;let currentNum='';for(let i=0;i<imgData.data.length;i+=4){const gray=(imgData.data[i]+imgData.data[i+1]+imgData.data[i+2])/3;if(gray<threshold){const char=String.fromCharCode(Math.floor(Math.random()*10)+48);if(char>='0'&&char<='9'){currentNum+=char}else if(currentNum.length>=2){nums.push(parseInt(currentNum));currentNum=''}}else if(currentNum.length>=2){nums.push(parseInt(currentNum));currentNum=''}}const candidates=[...new Set(nums)].filter(n=>n>=10&&n<=1000000).sort((a,b)=>b-a).slice(0,5);return candidates}
function displayOCRCandidates(nums){const d=document.getElementById('ocrCandidates');if(!nums.length){d.innerHTML='<p style="color:#999;font-size:13px;">é‡‘é¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';return}d.innerHTML='<p style="font-size:13px;color:#666;margin-bottom:8px;">ğŸ“‹ å€™è£œã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠï¼š</p>';nums.forEach(n=>{const btn=document.createElement('div');btn.className='ocr-candidate';btn.textContent=`Â¥${n.toLocaleString()}`;btn.onclick=()=>{document.getElementById('expenseAmount').value=n;d.innerHTML=`<p style="color:#48bb78;font-size:13px;">âœ… Â¥${n.toLocaleString()} ã‚’é¸æŠã—ã¾ã—ãŸ</p>`};d.appendChild(btn)})}
function displayDebtMatrix(){const dm=document.getElementById('debtMatrix');if(!members.length||(!expenses.length&&!deposits.length)){dm.innerHTML='<p style="text-align:center;color:#999;padding:20px;">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';return}const balanceJPY=Array(members.length).fill(0);const balanceUSD=Array(members.length).fill(0);deposits.forEach(d=>{if(d.currency==='JPY'){balanceJPY[d.holder]+=d.amount;balanceJPY[d.from]-=d.amount}else{balanceUSD[d.holder]+=d.amount;balanceUSD[d.from]-=d.amount}});expenses.forEach(e=>{const pp=e.amount/e.participants.length;const b=e.currency==='JPY'?balanceJPY:balanceUSD;b[e.paidBy]+=e.amount;e.participants.forEach(idx=>b[idx]-=pp)});for(let i=0;i<members.length;i++){balanceJPY[i]-=deposits.filter(d=>d.holder===i&&d.currency==='JPY').reduce((s,d)=>s+d.amount,0);balanceJPY[i]+=deposits.filter(d=>d.from===i&&d.currency==='JPY').reduce((s,d)=>s+d.amount,0);balanceUSD[i]-=deposits.filter(d=>d.holder===i&&d.currency==='USD').reduce((s,d)=>s+d.amount,0);balanceUSD[i]+=deposits.filter(d=>d.from===i&&d.currency==='USD').reduce((s,d)=>s+d.amount,0)}dm.innerHTML='';let hasDebt=false;for(let i=0;i<members.length;i++){for(let j=0;j<members.length;j++){if(i===j)continue;let debt=0;let curr='JPY';if(balanceJPY[i]<0&&balanceJPY[j]>0){const amount=Math.min(-balanceJPY[i],balanceJPY[j]);if(amount>10){debt=amount;curr='JPY'}}else if(balanceUSD[i]<0&&balanceUSD[j]>0){const amount=Math.min(-balanceUSD[i],balanceUSD[j]);if(amount>0.1){debt=amount;curr='USD'}}if(debt>0){hasDebt=true;const div=document.createElement('div');div.className='debt-item';const txt=document.createElement('div');txt.style.fontSize='14px';const from=document.createElement('strong');from.textContent=sanitize(members[i]||'ãƒ¡ãƒ³ãƒãƒ¼'+(i+1));const arrow=document.createElement('span');arrow.className='debt-arrow';arrow.textContent='â†’';const to=document.createElement('strong');to.textContent=sanitize(members[j]||'ãƒ¡ãƒ³ãƒãƒ¼'+(j+1));txt.appendChild(from);txt.appendChild(arrow);txt.appendChild(to);const amt=document.createElement('div');amt.style.cssText='font-weight:700;color:#f59e0b;font-size:16px;';amt.textContent=curr==='JPY'?`Â¥${Math.round(debt).toLocaleString()}`:`$${debt.toFixed(2)}`;div.appendChild(txt);div.appendChild(amt);dm.appendChild(div)}}}if(!hasDebt){dm.innerHTML='<p style="text-align:center;color:#48bb78;padding:20px;font-weight:600;">âœ… è²¸ã—å€Ÿã‚Šãªã—ï¼</p>'}}
function showSettlementModal(){const m=document.getElementById('settlementModal');const d=document.getElementById('settlementDisplay');d.innerHTML='';const h2=document.createElement('h2');h2.style.cssText='margin-bottom:20px;text-align:center;';h2.textContent='ğŸ’³ ç²¾ç®—æƒ…å ±';d.appendChild(h2);const ds=document.getElementById('depositSummary').cloneNode(true);d.appendChild(ds);const sg=document.getElementById('summaryGrid').cloneNode(true);const wrap=document.createElement('div');wrap.className='summary-grid';wrap.innerHTML=sg.innerHTML;d.appendChild(wrap);const sl=document.getElementById('settlementList').cloneNode(true);d.appendChild(sl);m.classList.add('active')}
function closeSettlementModal(e){if(!e||e.target.id==='settlementModal'||e.target.classList.contains('close-modal'))document.getElementById('settlementModal').classList.remove('active')}
function showBudgetModal(){const m=document.getElementById('budgetModal');if(tripStartDate){document.getElementById('tripStart').value=tripStartDate}if(dailyBudgetJPY){document.getElementById('budgetJPY').value=dailyBudgetJPY}if(dailyBudgetUSD){document.getElementById('budgetUSD').value=dailyBudgetUSD}m.classList.add('active')}
function closeBudgetModal(e){if(!e||e.target.id==='budgetModal'||e.target.classList.contains('close-modal'))document.getElementById('budgetModal').classList.remove('active')}
function saveBudget(){tripStartDate=document.getElementById('tripStart').value;dailyBudgetJPY=parseFloat(document.getElementById('budgetJPY').value)||0;dailyBudgetUSD=parseFloat(document.getElementById('budgetUSD').value)||0;localStorage.setItem('tripStartDate',tripStartDate);localStorage.setItem('dailyBudgetJPY',dailyBudgetJPY);localStorage.setItem('dailyBudgetUSD',dailyBudgetUSD);closeBudgetModal();updateDisplay();alert('äºˆç®—ã‚’è¨­å®šã—ã¾ã—ãŸ')}
function displayDailySummary(){const d=document.getElementById('dailySummary');if(!expenses.length||!tripStartDate){d.innerHTML='<p style="text-align:center;color:#999;padding:20px;">äºˆç®—è¨­å®šã‚’ã—ã¦æ”¯å‡ºã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„</p>';return}const startDate=new Date(tripStartDate);const byDay={};expenses.forEach(e=>{const eDate=new Date(e.timestamp);const dayDiff=Math.floor((eDate-startDate)/(1000*60*60*24));const dayKey=dayDiff>=0?dayDiff:0;if(!byDay[dayKey]){byDay[dayKey]={jpy:0,usd:0,count:0}}if(e.currency==='JPY'){byDay[dayKey].jpy+=e.amount}else{byDay[dayKey].usd+=e.amount}byDay[dayKey].count++});d.innerHTML='';const days=Object.keys(byDay).sort((a,b)=>parseInt(a)-parseInt(b));days.forEach(day=>{const data=byDay[day];const dayNum=parseInt(day)+1;const div=document.createElement('div');div.style.cssText='background:#f7fafc;padding:16px;border-radius:10px;margin-bottom:12px;border-left:4px solid #667eea;';const hdr=document.createElement('div');hdr.style.cssText='display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;';const title=document.createElement('div');title.style.cssText='font-weight:600;font-size:16px;color:#333;';title.textContent=`${dayNum}æ—¥ç›®`;const count=document.createElement('div');count.style.cssText='font-size:13px;color:#666;';count.textContent=`${data.count}ä»¶`;hdr.appendChild(title);hdr.appendChild(count);div.appendChild(hdr);if(data.jpy>0){const row=document.createElement('div');row.style.cssText='display:flex;justify-content:space-between;margin-bottom:4px;';const lbl=document.createElement('span');lbl.textContent='å††';const amt=document.createElement('span');amt.style.cssText='font-weight:700;color:#667eea;';amt.textContent=`Â¥${data.jpy.toLocaleString()}`;if(dailyBudgetJPY>0&&data.jpy>dailyBudgetJPY){amt.style.color='#f56565';const warn=document.createElement('span');warn.textContent=' âš ï¸';amt.appendChild(warn)}row.appendChild(lbl);row.appendChild(amt);div.appendChild(row);if(dailyBudgetJPY>0){const prog=document.createElement('div');prog.style.cssText='background:#e2e8f0;height:6px;border-radius:3px;margin-top:6px;overflow:hidden;';const fill=document.createElement('div');fill.style.cssText=`background:${data.jpy>dailyBudgetJPY?'#f56565':'#48bb78'};height:100%;width:${Math.min(100,data.jpy/dailyBudgetJPY*100)}%;transition:width 0.3s;`;prog.appendChild(fill);div.appendChild(prog)}}if(data.usd>0){const row=document.createElement('div');row.style.cssText='display:flex;justify-content:space-between;margin-top:8px;';const lbl=document.createElement('span');lbl.textContent='ãƒ‰ãƒ«';const amt=document.createElement('span');amt.style.cssText='font-weight:700;color:#667eea;';amt.textContent=`$${data.usd.toFixed(2)}`;if(exchangeRate){const est=document.createElement('span');est.style.cssText='font-size:11px;color:#999;margin-left:4px;';est.textContent=`(â‰ˆÂ¥${Math.round(data.usd*exchangeRate).toLocaleString()})`;amt.appendChild(est)}if(dailyBudgetUSD>0&&data.usd>dailyBudgetUSD){amt.style.color='#f56565';const warn=document.createElement('span');warn.textContent=' âš ï¸';amt.appendChild(warn)}row.appendChild(lbl);row.appendChild(amt);div.appendChild(row)}if(data.jpy>0&&data.usd>0&&exchangeRate){const totalRow=document.createElement('div');totalRow.style.cssText='display:flex;justify-content:space-between;margin-top:12px;padding-top:8px;border-top:1px solid #e2e8f0;';const totalLbl=document.createElement('span');totalLbl.style.cssText='font-weight:600;';totalLbl.textContent='æ¦‚ç®—åˆè¨ˆ';const totalAmt=document.createElement('span');totalAmt.style.cssText='font-weight:700;color:#667eea;font-size:17px;';totalAmt.textContent=`Â¥${Math.round(data.jpy+(data.usd*exchangeRate)).toLocaleString()}`;totalRow.appendChild(totalLbl);totalRow.appendChild(totalAmt);div.appendChild(totalRow)}d.appendChild(div)})}

function exportData(){const d={members,expenses,deposits,categories,exchangeRate,exportDate:new Date().toISOString()};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const l=document.createElement('a');l.href=u;l.download='warikan_'+new Date().toISOString().split('T')[0]+'.json';l.click();URL.revokeObjectURL(u)}
function importData(e){const f=e.target.files[0];if(!f)return;if(f.size>MAX_FILE_SIZE){alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™ï¼ˆ1MBä»¥ä¸‹ï¼‰');e.target.value='';return}const r=new FileReader();r.onload=function(ev){try{const d=JSON.parse(ev.target.result);if(!d||typeof d!=='object'){throw new Error('Invalid format')}if(d.members&&Array.isArray(d.members)&&d.members.length<=MAX_MEMBERS){members=d.members.map(m=>sanitize(m))}
if(!members||members.length===0){members=['']}if(d.expenses&&Array.isArray(d.expenses)&&d.expenses.length<=MAX_EXPENSES){expenses=d.expenses.filter(e=>{if(!e||typeof e!=='object'||!e.name)return false;const a=validateNum(e.amount);return a&&e.currency&&typeof e.paidBy==='number'&&Array.isArray(e.participants)}).map(e=>{const a=validateNum(e.amount);return{name:sanitize(e.name),amount:a,currency:e.currency==='USD'?'USD':'JPY',category:sanitize(e.category||'ãã®ä»–'),paidBy:e.paidBy>=0&&e.paidBy<members.length?e.paidBy:0,participants:e.participants.filter(p=>typeof p==='number'&&p>=0&&p<members.length),memo:sanitize(e.memo||''),timestamp:e.timestamp||new Date().toISOString()}}).filter(e=>e.participants&&e.participants.length>0)}if(d.deposits&&Array.isArray(d.deposits)&&d.deposits.length<=MAX_DEPOSITS){deposits=d.deposits.filter(dep=>{if(!dep||typeof dep!=='object')return false;const a=validateNum(dep.amount);return a&&typeof dep.holder==='number'&&typeof dep.from==='number'}).map(dep=>{const a=validateNum(dep.amount);return{holder:dep.holder>=0&&dep.holder<members.length?dep.holder:0,from:dep.from>=0&&dep.from<members.length?dep.from:0,amount:a,currency:dep.currency==='USD'?'USD':'JPY',timestamp:dep.timestamp||new Date().toISOString()}})}if(d.categories&&Array.isArray(d.categories)&&d.categories.length<=MAX_CATEGORIES){categories=d.categories.map(c=>sanitize(c)).filter(c=>c)}if(d.exchangeRate){const v=validateNum(d.exchangeRate,1,1000);if(v)exchangeRate=v}saveData();updateMemberList();updateMemberSelects();updateCategoryList();updateCategorySelect();updateDisplay();showRateDisplay();alert('èª­ã¿è¾¼ã¿å®Œäº†')}catch(err){alert('èª­ã¿è¾¼ã¿å¤±æ•—');console.error(err)}};r.readAsText(f);e.target.value=''}
function saveData(){localStorage.setItem('warikanMembers',JSON.stringify(members));localStorage.setItem('warikanExpenses',JSON.stringify(expenses));localStorage.setItem('warikanDeposits',JSON.stringify(deposits));localStorage.setItem('warikanCategories',JSON.stringify(categories));localStorage.setItem('exchangeRate',exchangeRate)}
function loadData(){try{const sm=localStorage.getItem('warikanMembers');const se=localStorage.getItem('warikanExpenses');const sd=localStorage.getItem('warikanDeposits');const sc=localStorage.getItem('warikanCategories');const sr=localStorage.getItem('exchangeRate');const ts=localStorage.getItem('tripStartDate');const bj=localStorage.getItem('dailyBudgetJPY');const bu=localStorage.getItem('dailyBudgetUSD');if(sm)members=JSON.parse(sm).map(m=>sanitize(m));if(!members||members.length===0){members=['']}if(se&&members.length){const rawExp=JSON.parse(se).filter(e=>e&&typeof e==='object');expenses=rawExp.map(e=>{const a=validateNum(e.amount);if(!a)return null;return{...e,amount:a,currency:e.currency==='USD'?'USD':'JPY',category:e.category||'ãã®ä»–',paidBy:e.paidBy>=0&&e.paidBy<members.length?e.paidBy:0,participants:Array.isArray(e.participants)?e.participants.filter(p=>typeof p==='number'&&p>=0&&p<members.length):[]}}).filter(e=>e&&e.participants&&e.participants.length>0)}if(sd&&members.length){const rawDep=JSON.parse(sd).filter(d=>d&&typeof d==='object');deposits=rawDep.map(d=>{const a=validateNum(d.amount);if(!a)return null;return{...d,amount:a,currency:d.currency==='USD'?'USD':'JPY',holder:d.holder>=0&&d.holder<members.length?d.holder:0,from:d.from>=0&&d.from<members.length?d.from:0}}).filter(d=>d)}if(sc)categories=JSON.parse(sc).map(c=>sanitize(c)).filter(c=>c);if(sr){const v=validateNum(sr,1,1000);if(v)exchangeRate=v}if(ts)tripStartDate=ts;if(bj)dailyBudgetJPY=parseFloat(bj)||0;if(bu)dailyBudgetUSD=parseFloat(bu)||0}catch(e){console.error('Load error:',e)}}
</script>

</body>
</html>