<!DOCTYPE html>

<html lang="ja"><head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</title>

<style>
:root{
  color-scheme: light;
  --bg:#f4f2f7;
  --surface:#ffffff;
  --surface-2:#fbfaff;
  --line:#e4e0ef;
  --text:#4e4a63;
  --muted:#7a768f;
  --accent:#b9b3cc;
  --accent-2:#d7d2e6;
  --accent-3:#ebe7f4;
  --accent-bluegray:#8c93aa;
  --success:#8bb8a8;
  --info:#93a7d6;
  --danger:#d98c8c;
  --shadow:0 10px 24px rgba(28,25,41,.08);
  --radius:18px;
  --footer-h:84px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);min-height:100vh;padding:14px;padding-bottom:calc(var(--footer-h) + env(safe-area-inset-bottom) + 28px);color:var(--text);}
.container{max-width:820px;margin:0 auto;}

.header{background:var(--surface);padding:24px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:14px;text-align:center;border:1px solid var(--line);}
.header h1{color:var(--text);font-size:24px;margin-bottom:8px;letter-spacing:.2px;}
.header p{color:var(--muted);font-size:13px;}

.action-buttons{display:flex;flex-direction:column;gap:10px;margin-top:14px;}
.action-buttons button,.action-buttons label{padding:14px 16px;border:none;border-radius:14px;font-size:14px;font-weight:800;cursor:pointer;transition:transform .05s ease,filter .2s ease,opacity .2s;min-height:50px;}
.action-buttons button:active,.action-buttons label:active{transform:scale(.99);}
.btn-export{background:rgba(140,147,170,.18);color:var(--text);border:1px solid rgba(140,147,170,.35);}
.btn-import{background:rgba(185,179,204,.20);color:var(--text);border:1px solid rgba(185,179,204,.45);display:flex;align-items:center;justify-content:center;}

.card{background:var(--surface);padding:0;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:14px;border:1px solid var(--line);overflow:hidden;}
.card-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:18px 20px;cursor:pointer;user-select:none;gap:10px;
  border-bottom:3px solid var(--accent);
}
.card-header:hover{background:var(--surface-2);}
.card-header h2{color:var(--text);font-size:18px;margin:0;border:none;padding:0;flex:1;}
.card-chevron{font-size:14px;color:var(--muted);transition:transform .25s ease;flex-shrink:0;line-height:1;}
.card-chevron.open{transform:rotate(90deg);}
.card-body{padding:20px;display:block;}
.card-body.collapsed{display:none;}
/* ãƒ¡ãƒ³ãƒãƒ¼ãƒœã‚¿ãƒ³ç¾¤ */
.member-btn-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:14px;}
.member-btn{
  padding:14px 10px;border:2px solid var(--line);border-radius:16px;
  background:var(--surface-2);color:var(--text);font-size:15px;font-weight:900;
  cursor:pointer;transition:background .15s,border-color .15s;text-align:center;
}
.member-btn.active{
  background:rgba(140,147,170,.20);border-color:rgba(140,147,170,.55);
  color:var(--text);
}
@media(max-width:400px){.member-btn-grid{grid-template-columns:1fr;}}

.input-group{margin-bottom:14px;}
.input-group label{display:block;margin-bottom:6px;color:var(--muted);font-size:14px;font-weight:800;}
.input-group input,.input-group select,.input-group textarea{width:100%;padding:16px;border:2px solid var(--line);border-radius:14px;font-size:16px;transition:border-color .2s,box-shadow .2s;background:var(--surface-2);color:var(--text);}
.input-group input:focus,.input-group select:focus,.input-group textarea:focus{outline:none;border-color:rgba(140,147,170,.65);box-shadow:0 0 0 4px rgba(140,147,170,.12);}

.member-list{display:flex;flex-direction:column;gap:10px;margin-bottom:14px;}
.member-item{display:flex;gap:10px;align-items:center;}
.member-item input{flex:1;padding:16px;font-size:16px;}
.member-item button{padding:12px 16px;background:rgba(217,140,140,.25);color:var(--text);border:1px solid rgba(217,140,140,.35);border-radius:12px;cursor:pointer;font-size:13px;min-height:48px;}

.checkbox-group{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
.checkbox-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--surface-2);border-radius:12px;border:1px solid var(--line);}
.checkbox-item input[type="checkbox"]{width:24px;height:24px;cursor:pointer;}
.checkbox-item label{cursor:pointer;color:var(--text);font-size:15px;}

.btn{padding:16px 24px;border:none;border-radius:16px;font-size:16px;font-weight:900;cursor:pointer;transition:transform .05s ease,filter .2s ease;min-height:56px;}
.btn:active{transform:scale(.99);}
.btn-primary{background:rgba(140,147,170,.20);color:var(--text);border:1px solid rgba(140,147,170,.35);width:100%;}
.btn-add{background:rgba(185,179,204,.28);color:var(--text);padding:12px 20px;font-size:15px;min-height:48px;border:1px solid rgba(185,179,204,.45);}
.btn-danger{background:rgba(217,140,140,.25);color:var(--text);padding:10px 16px;font-size:14px;min-height:44px;border:1px solid rgba(217,140,140,.35);border-radius:16px;font-weight:900;cursor:pointer;}
/* â˜… ãƒ–ãƒ«ãƒ¼ã‚°ãƒ¬ãƒ¼ç·¨é›†ãƒœã‚¿ãƒ³ */
.btn-edit{background:rgba(140,147,170,.20);color:var(--text);padding:10px 16px;font-size:14px;min-height:44px;border:1px solid rgba(140,147,170,.40);border-radius:16px;font-weight:900;cursor:pointer;transition:transform .05s,filter .2s;}
.btn-edit:active{transform:scale(.99);}
/* â˜… ãƒ˜ãƒƒãƒ€ãƒ¼ç³»ãƒ–ãƒ«ãƒ¼ã‚°ãƒ¬ãƒ¼å°ãƒœã‚¿ãƒ³ï¼ˆå¤‰æ›´ãƒ»ç·¨é›†ï¼‰ */
.btn-bluegray-sm{padding:8px 16px;font-size:13px;font-weight:800;cursor:pointer;border-radius:8px;background:rgba(140,147,170,.22);color:var(--text);border:1px solid rgba(140,147,170,.42);}

.expense-list{max-height:560px;overflow-y:auto;}
.expense-item{
  background:var(--surface);border-radius:18px;border:1px solid var(--line);
  box-shadow:0 2px 8px rgba(28,25,41,.05);margin-bottom:10px;
}
.expense-item.is-editing{outline:2px solid rgba(140,147,170,.50);}
.expense-color-bar{height:4px;border-radius:18px 18px 0 0;background:linear-gradient(90deg,rgba(140,147,170,.6),rgba(185,179,204,.4));}
.expense-item.is-editing .expense-color-bar{background:linear-gradient(90deg,var(--accent-bluegray),rgba(147,167,214,.6));}
.expense-body{padding:14px 16px 12px;}
.expense-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:8px;}
.expense-title{font-weight:900;color:var(--text);font-size:16px;line-height:1.3;}
.expense-amount{font-weight:900;color:var(--accent-bluegray);font-size:17px;white-space:nowrap;text-align:right;}
.expense-meta{display:flex;gap:8px;flex-wrap:wrap;}
.expense-meta-chip{display:inline-flex;align-items:center;gap:4px;background:var(--surface-2);border:1px solid var(--line);border-radius:999px;padding:5px 11px;font-size:12px;color:var(--muted);font-weight:700;}
.expense-meta-chip b{color:var(--text);font-weight:900;}
.expense-actions{display:flex;border-top:1px solid var(--line);}
.expense-actions button{flex:1;padding:12px 10px;border:none;background:transparent;font-size:13px;font-weight:800;cursor:pointer;transition:background .15s;}
.expense-actions button:first-child{border-right:1px solid var(--line);}
.expense-actions button:hover{background:var(--surface-2);}
.expense-action-edit{color:var(--accent-bluegray) !important;}
.expense-action-delete{color:var(--danger) !important;}

/* ç·¨é›†ä¸­ãƒãƒŠãƒ¼ */
.edit-banner{display:none;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;background:rgba(140,147,170,.12);border:1.5px solid rgba(140,147,170,.38);border-radius:14px;padding:12px 16px;margin-bottom:14px;}
.edit-banner.visible{display:flex;}
.edit-banner-text{font-size:13px;font-weight:800;color:var(--accent-bluegray);}
.edit-banner-cancel{padding:6px 14px;background:rgba(217,140,140,.22);color:var(--text);border:1px solid rgba(217,140,140,.38);border-radius:10px;font-size:13px;font-weight:800;cursor:pointer;}

.settlement-item{background:var(--surface);padding:14px 16px;border-radius:16px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;gap:16px;border:1px solid var(--line);box-shadow:0 1px 4px rgba(28,25,41,.04);}
.settlement-text{color:var(--text);font-size:16px;font-weight:800;flex:1;min-width:0;}
.settlement-amount{font-weight:900;color:var(--danger);font-size:17px;white-space:nowrap;flex-shrink:0;}
.settlement-amount-sub{font-weight:700;color:var(--danger);font-size:13px;opacity:.75;white-space:nowrap;}

/* ã‚·ã‚§ã‚¢ãƒãƒ¼ */
.share-bar{
  display:flex;gap:8px;margin-bottom:16px;
}
.share-btn{
  flex:1;display:flex;align-items:center;justify-content:center;gap:6px;
  padding:13px 10px;border:none;border-radius:16px;
  font-size:14px;font-weight:900;cursor:pointer;
  transition:transform .05s,filter .15s;
}
.share-btn:active{transform:scale(.98);}
.share-btn-copy{background:rgba(140,147,170,.20);color:var(--text);border:1px solid rgba(140,147,170,.38);}
.share-btn-share{background:rgba(139,184,168,.28);color:var(--text);border:1px solid rgba(139,184,168,.42);}

/* å€‹äººåˆ¥æ˜ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.detail-group{margin-bottom:18px;}
.detail-section{margin-bottom:8px;}
.detail-section-header{
  display:flex;align-items:center;gap:8px;
  padding:8px 4px 6px;
  border-bottom:2px solid var(--line);
  margin-bottom:8px;
}
.detail-section-badge{font-size:16px;line-height:1;}
.detail-section-title{font-size:12px;font-weight:900;color:var(--muted);letter-spacing:.3px;text-transform:uppercase;}
.detail-section-ccy{
  margin-left:auto;font-size:11px;font-weight:900;
  padding:3px 8px;border-radius:999px;
  background:rgba(140,147,170,.15);color:var(--accent-bluegray);
  border:1px solid rgba(140,147,170,.28);
}
.detail-tx-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:11px 14px;background:var(--surface);
  border-radius:14px;border:1px solid var(--line);
  margin-bottom:7px;gap:10px;
}
.detail-tx-from{font-size:14px;font-weight:900;color:var(--text);}
.detail-tx-arrow{font-size:13px;color:var(--muted);margin:0 4px;flex-shrink:0;}
.detail-tx-to{font-size:14px;font-weight:900;color:var(--text);}
.detail-tx-route{display:flex;align-items:center;flex:1;min-width:0;}
.detail-tx-amount{font-size:16px;font-weight:900;color:var(--danger);white-space:nowrap;flex-shrink:0;}
.detail-none{text-align:center;color:var(--muted);font-size:13px;padding:10px 0 4px;font-weight:700;}

.summary-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:14px;}
.summary-card{
  background:var(--surface);border-radius:18px;border:1px solid var(--line);
  overflow:hidden;box-shadow:0 2px 8px rgba(28,25,41,.05);
}
.summary-card-header{
  padding:10px 14px 8px;border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;gap:6px;
}
.summary-card-name{font-size:13px;font-weight:900;color:var(--text);}
.summary-card-body{padding:10px 14px 12px;display:flex;flex-direction:column;gap:7px;}
.summary-row{display:flex;align-items:baseline;justify-content:space-between;gap:6px;}
.summary-ccy{font-size:10px;font-weight:900;color:var(--muted);letter-spacing:.3px;min-width:28px;}
.summary-num{font-size:15px;font-weight:900;line-height:1.2;text-align:right;}
.summary-num .estimate{font-size:10px;font-weight:700;color:var(--muted);display:block;line-height:1.3;}
.summary-num-pos{color:#3d7a6a;}
.summary-num-neg{color:#8a3535;}
.summary-num-zero{color:var(--muted);}

.currency-toggle{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;background:var(--surface-2);padding:6px;border-radius:16px;border:1px solid var(--line);}
.currency-btn{padding:12px;border:none;border-radius:14px;background:transparent;cursor:pointer;font-weight:900;font-size:15px;transition:background .2s,color .2s;min-height:48px;color:var(--muted);}
.currency-btn.active{background:rgba(140,147,170,.20);color:var(--text);border:1px solid rgba(140,147,170,.30);}

.deposit-section{background:rgba(185,179,204,.14);padding:16px;border-radius:16px;margin-bottom:18px;border:1px solid rgba(185,179,204,.35);}
.deposit-label{font-weight:900;color:var(--text);font-size:14px;}
.deposit-value{font-weight:900;color:var(--accent-bluegray);font-size:17px;}

input[type="file"]{display:none;}
.info-text{font-size:13px;color:var(--muted);margin-bottom:14px;padding:12px;background:var(--surface-2);border-radius:14px;line-height:1.6;border:1px solid var(--line);}
.hr{height:1px;background:var(--line);margin:12px 0;}
.small{font-size:12px;color:var(--muted);}
.pill{display:inline-block;padding:6px 10px;background:rgba(185,179,204,.22);border:1px solid rgba(185,179,204,.35);border-radius:999px;font-size:12px;font-weight:900;color:var(--text);}

/* ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ */
.rate-display{background:rgba(185,179,204,.16);padding:12px;border-radius:14px;margin-top:12px;border:1px solid rgba(185,179,204,.35);color:var(--text);}
.rate-row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
.rate-edit-row{display:none;align-items:center;gap:8px;margin-top:10px;flex-wrap:wrap;}
.rate-edit-row.visible{display:flex;}
.rate-edit-row input{flex:1;min-width:80px;max-width:140px;padding:10px 14px;font-size:15px;font-weight:800;border:2px solid var(--accent-2);border-radius:12px;background:var(--surface);color:var(--text);}
.rate-edit-row input:focus{outline:none;border-color:rgba(140,147,170,.65);box-shadow:0 0 0 3px rgba(140,147,170,.12);}
.rate-edit-row button{padding:10px 16px;border:none;border-radius:12px;font-size:13px;font-weight:800;cursor:pointer;min-height:40px;}
.rate-save-btn{background:rgba(139,184,168,.35);color:var(--text);border:1px solid rgba(139,184,168,.45);}
.rate-cancel-btn{background:rgba(217,140,140,.22);color:var(--text);border:1px solid rgba(217,140,140,.32);}

/* ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
.confirm-overlay{display:none;position:fixed;inset:0;background:rgba(16,14,24,.55);z-index:2000;justify-content:center;align-items:center;padding:14px;}
.confirm-overlay.active{display:flex;}
.confirm-box{background:var(--surface);padding:28px 24px;border-radius:20px;max-width:340px;width:100%;box-shadow:var(--shadow);border:1px solid var(--line);text-align:center;}
.confirm-box p{color:var(--text);font-size:15px;line-height:1.6;margin-bottom:20px;}
.confirm-box .confirm-title{font-size:17px;font-weight:900;margin-bottom:10px;}
.confirm-actions{display:flex;gap:10px;}
.confirm-actions button{flex:1;padding:14px;border:none;border-radius:14px;font-size:15px;font-weight:800;cursor:pointer;min-height:50px;}
.confirm-ok{background:rgba(217,140,140,.35);color:var(--text);border:1px solid rgba(217,140,140,.45);}
.confirm-cancel{background:rgba(140,147,170,.18);color:var(--text);border:1px solid rgba(140,147,170,.30);}

/* ===== å€‹äººåˆ¥ã¾ã¨ã‚ ã‚«ãƒ¼ãƒ‰ ===== */
.personal-card{background:var(--surface-2);border:1px solid var(--line);border-radius:18px;margin-bottom:12px;overflow:hidden;}
.personal-card-header{display:flex;flex-direction:column;align-items:stretch;padding:12px 16px 12px;border-bottom:1px solid var(--line);gap:6px;}
.personal-card-name{font-size:16px;font-weight:900;color:var(--text);}
.personal-card-nets{display:flex;gap:7px;flex-wrap:wrap;justify-content:flex-end;}
.net-badge{padding:5px 11px;border-radius:999px;font-size:12px;font-weight:900;white-space:nowrap;}
.net-plus{background:rgba(139,184,168,.25);color:#3d6b5c;border:1px solid rgba(139,184,168,.45);}
.net-minus{background:rgba(217,140,140,.20);color:#7a3535;border:1px solid rgba(217,140,140,.38);}
.net-zero{background:rgba(140,147,170,.15);color:var(--muted);border:1px solid rgba(140,147,170,.28);}
.personal-card-body{padding:4px 0;}
.stat-row{display:grid;grid-template-columns:52px 1fr 1fr 1fr;align-items:center;gap:4px 8px;padding:11px 16px;}
.stat-row+.stat-row{border-top:1px solid var(--line);}
.stat-ccy{font-size:11px;font-weight:900;color:var(--muted);letter-spacing:.3px;}
.stat-cell{text-align:right;}
.stat-lbl{font-size:10px;color:var(--muted);font-weight:800;margin-bottom:3px;letter-spacing:.2px;}
.stat-val{font-size:13px;font-weight:900;color:var(--text);line-height:1.3;}
.stat-val .estimate{font-size:10px;font-weight:700;color:var(--muted);display:block;line-height:1.4;margin-top:1px;}
.c-recv{color:#4a7a6a;}
.c-pay{color:#7a4040;}
.c-net-p{color:#3d6b5c;}
.c-net-m{color:#7a3535;}

/* ç²¾ç®—ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚«ãƒ¼ãƒ‰ */
.sett-mode-card{
  display:flex;flex-direction:column;align-items:center;gap:4px;
  padding:14px 10px;border-radius:16px;cursor:pointer;
  background:var(--surface-2);border:2px solid var(--line);
  transition:background .15s,border-color .15s;user-select:none;
}
.sett-mode-card.active{
  background:rgba(140,147,170,.18);border-color:rgba(140,147,170,.55);
}
.sett-mode-icon{font-size:22px;line-height:1;}
.sett-mode-name{font-size:13px;font-weight:900;color:var(--text);text-align:center;}
.sett-mode-desc{font-size:11px;font-weight:700;color:var(--muted);text-align:center;}

/* toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--footer-h) + env(safe-area-inset-bottom) + 10px);background:rgba(78,74,99,.92);color:white;padding:10px 18px;border-radius:999px;font-weight:900;font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s ease,transform .2s ease;z-index:1200;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-2px);}

/* footer */
.footer-bar{position:fixed;left:0;right:0;bottom:0;z-index:999;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);border-top:1px solid var(--line);}
.footer-inner{max-width:820px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px;padding-bottom:calc(10px + env(safe-area-inset-bottom));}
.footer-actions{display:flex;gap:10px;flex:1;}
.footer-actions button{flex:1;padding:12px 10px;border-radius:16px;border:1px solid rgba(140,147,170,.22);background:rgba(140,147,170,.12);color:var(--text);font-weight:900;min-height:46px;cursor:pointer;}
.footer-actions button:active{transform:scale(.99);}
.footer-mini{width:160px;background:rgba(185,179,204,.14);border:1px solid rgba(185,179,204,.30);border-radius:16px;padding:10px 12px;text-align:right;}
.footer-mini .t{font-size:11px;color:var(--muted);font-weight:800;}
.footer-mini .v{font-size:14px;color:var(--text);font-weight:900;margin-top:2px;}

@media(max-width:560px){.footer-inner{flex-direction:column;align-items:stretch;}.footer-mini{width:100%;text-align:left;}}
@media(max-width:480px){.summary-grid{grid-template-columns:1fr;}.stat-row{grid-template-columns:42px 1fr 1fr 1fr;}.stat-val{font-size:12px;}}
</style>

<link rel="apple-touch-icon" href="916778A2-03B7-475D-96D4-2D25AD327C7B.png">

</head>
<body>
<div class="container">

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->

  <div class="header">
    <h1>ğŸ’° å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</h1>
    <p>ã‚°ãƒ«ãƒ¼ãƒ—ã®æ”¯å‡ºã‚’ç°¡å˜ç®¡ç†</p>
    <div class="action-buttons">
      <button class="btn-export" onclick="exportData()">ğŸ“¥ ä¿å­˜</button>
      <label for="importFile" class="btn-import">ğŸ“¤ èª­è¾¼</label>
      <input type="file" id="importFile" accept=".json" onchange="importData(event)">
    </div>
    <div id="rateDisplay" class="rate-display">
      <div class="rate-row">
        <span id="rateText">ğŸ’± ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ: $1 = Â¥150.00</span>
        <!-- â˜…å¤‰æ›´ãƒœã‚¿ãƒ³ â†’ ãƒ–ãƒ«ãƒ¼ã‚°ãƒ¬ãƒ¼ -->
        <button class="btn-bluegray-sm" onclick="toggleRateEdit()">å¤‰æ›´</button>
      </div>
      <div class="rate-edit-row" id="rateEditRow">
        <input type="number" id="rateInput" min="1" max="1000" step="0.01" placeholder="ä¾‹: 150">
        <button class="rate-save-btn" onclick="applyRate()">ç¢ºå®š</button>
        <button class="rate-cancel-btn" onclick="cancelRateEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ³ãƒãƒ¼ -->

  <div class="card">
    <div class="card-header" onclick="toggleCard('cardMember',this)">
      <h2>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼</h2>
      <button id="toggleMemberBtn" onclick="event.stopPropagation();toggleMemberEdit()" class="btn-bluegray-sm">ç·¨é›†</button>
      <span class="card-chevron open">â–¶</span>
    </div>
    <div class="card-body" id="cardMember">
      <div id="memberDisplay" style="padding:6px 0;"><p style="color:var(--muted);">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</p></div>
      <div id="memberEdit" style="display:none;">
        <div class="member-list" id="memberList"></div>
        <button class="btn btn-add" onclick="addMember()">+ è¿½åŠ </button>
        <button class="btn btn-primary" onclick="saveMemberEdit()" style="margin-top:10px;">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- æ”¯æ‰•ã„è¨˜éŒ² -->

  <div class="card">
    <div class="card-header" onclick="toggleCard('cardExpense',this)" id="sec-expense">
      <h2>ğŸ’° æ”¯æ‰•ã„è¨˜éŒ²</h2>
      <span class="card-chevron open">â–¶</span>
    </div>
    <div class="card-body" id="cardExpense">
    <div class="edit-banner" id="expenseEditBanner">
      <span class="edit-banner-text">âœï¸ æ”¯æ‰•ã„ã‚’ç·¨é›†ä¸­</span>
      <button class="edit-banner-cancel" onclick="cancelEditExpense()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
    <div class="currency-toggle" id="expenseCurrencyToggle">
      <button class="currency-btn active" onclick="setCurrency('JPY')">å††</button>
      <button class="currency-btn" onclick="setCurrency('USD')">ãƒ‰ãƒ«</button>
    </div>
    <div class="input-group"><label>é …ç›®å</label><input type="text" id="expenseName" placeholder="ä¾‹: ãƒ©ãƒ³ãƒä»£" maxlength="100"></div>
    <div class="input-group"><label>é‡‘é¡</label><input type="number" id="expenseAmount" placeholder="0" min="0" max="10000000" step="0.01" inputmode="decimal"></div>
    <div class="input-group"><label>æ”¯æ‰•ã£ãŸäºº</label><select id="paidBy"><option value="">é¸æŠ</option></select></div>
    <div class="input-group"><label>å‚åŠ è€…</label><div class="checkbox-group" id="participantsCheckbox"></div></div>
    <button class="btn btn-primary" id="expenseSubmitBtn" onclick="submitExpense()">è¿½åŠ </button>
    </div>
  </div>

  <!-- æ”¯æ‰•ã„ä¸€è¦§ -->

  <div class="card">
    <div class="card-header" onclick="toggleCard('cardExpenseList',this)">
      <h2>ğŸ“ æ”¯æ‰•ã„ä¸€è¦§</h2>
      <span class="card-chevron open">â–¶</span>
    </div>
    <div class="card-body" id="cardExpenseList">
      <div class="expense-list" id="expenseList"><div class="empty-state"><p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>
    </div>
  </div>

  <!-- ç²¾ç®— -->

  <div class="card">
    <div class="card-header" onclick="toggleCard('cardSettlement',this)" id="sec-settlement">
      <h2>ğŸ’³ ç²¾ç®—ï¼ˆæ”¯å‡ºã®ã¿ï¼‰</h2>
      <span class="card-chevron open">â–¶</span>
    </div>
    <div class="card-body" id="cardSettlement">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
      <label class="sett-mode-card" id="settCard-direct">
        <input type="radio" name="settMode" value="direct" onchange="setSettlementMode('direct')" style="display:none;">
        <div class="sett-mode-icon">ğŸ’³</div>
        <div class="sett-mode-name">ç«‹æ›¿è€…ã¸ç›´æ¥</div>
        <div class="sett-mode-desc">ãŠã™ã™ã‚</div>
      </label>
      <label class="sett-mode-card" id="settCard-min">
        <input type="radio" name="settMode" value="min" onchange="setSettlementMode('min')" style="display:none;">
        <div class="sett-mode-icon">ğŸ—œï¸</div>
        <div class="sett-mode-name">æœ€å°ç²¾ç®—</div>
        <div class="sett-mode-desc">é€é‡‘å›æ•°ã‚’åœ§ç¸®</div>
      </label>
    </div>
    <div id="settlementList"></div>
    </div>
  </div>

  <!-- å€‹äººåˆ¥ã¾ã¨ã‚ -->

  <div class="card">
    <div class="card-header" onclick="toggleCard('cardPersonal',this)" id="sec-personal">
      <h2>ğŸ‘¤ å€‹äººåˆ¥ã¾ã¨ã‚</h2>
      <span class="card-chevron open">â–¶</span>
    </div>
    <div class="card-body" id="cardPersonal">
      <div class="info-text" style="line-height:1.8;margin-bottom:14px;">
        <b>å—å–</b> ï¼ ç«‹ã¦æ›¿ãˆãŸåˆ†ã‚’ä»–ã®äººã‹ã‚‰å›åã™ã‚‹ãŠé‡‘<br>
        <b>æ”¯æ‰•</b> ï¼ ä»–ã®äººã«ç«‹ã¦æ›¿ãˆã¦ã‚‚ã‚‰ã£ãŸåˆ†ã‚’è¿”ã™ãŠé‡‘<br>
        <b>å·®å¼•</b> ï¼ å—å– âˆ’ æ”¯æ‰•ï¼ˆï¼‹ = å—å–è¶…éã€âˆ’ = æ”¯æ‰•è¶…éï¼‰
      </div>
      <div id="personalSummary"></div>
      <div class="hr" style="margin:16px 0;"></div>
      <div style="font-size:13px;font-weight:900;color:var(--muted);margin-bottom:10px;letter-spacing:.2px;">ğŸ“‹ ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸ã‚“ã§æ˜ç´° ï¼† ã‚·ã‚§ã‚¢</div>
      <div class="member-btn-grid" id="focusMemberBtns"></div>
      <div id="personalDetails" style="margin-top:4px;"><p style="text-align:center;color:var(--muted);padding:10px;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸ã¶ã¨æ˜ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p></div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>
<div style="margin:0 16px 8px;padding:10px 14px;background:rgba(255,193,7,.12);border:1px solid rgba(255,193,7,.35);border-radius:14px;font-size:12px;color:#7a5c00;line-height:1.6;">
  ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¶ˆã™ã¨æ¶ˆãˆã‚‹ã®ã§ã€å®šæœŸçš„ã«ã€ŒJSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚
</div>
<div style="text-align:center;padding:12px 20px 24px;font-size:11px;color:var(--muted);line-height:1.7;">
  âš ï¸ ã“ã®ã‚¢ãƒ—ãƒªã¯å€‹äººãŒè¶£å‘³ã§é–‹ç™ºã—ãŸã‚‚ã®ã§ã™ã€‚<br>è¨ˆç®—çµæœã®æ­£ç¢ºæ€§ã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚<br>å®Ÿéš›ã®ç²¾ç®—ã¯ã”è‡ªèº«ã§ã”ç¢ºèªã®ã†ãˆã€è‡ªå·±è²¬ä»»ã§ã”åˆ©ç”¨ãã ã•ã„ã€‚
</div>

<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-title" id="confirmTitle">å‰Šé™¤ã®ç¢ºèª</div>
    <p id="confirmMsg">æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
    <div class="confirm-actions">
      <button class="confirm-ok" id="confirmOkBtn">å‰Šé™¤</button>
      <button class="confirm-cancel" onclick="closeConfirm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<div class="footer-bar">
  <div class="footer-inner">
    <div class="footer-actions">
      <button onclick="scrollToSection('sec-expense')">ï¼‹ æ”¯å‡º</button>
      <button onclick="scrollToSection('sec-settlement')">ç²¾ç®—</button>
      <button onclick="scrollToSection('sec-personal')">å€‹äºº</button>
    </div>
    <div class="footer-mini">
      <div class="t">æ¦‚ç®—åˆè¨ˆï¼ˆUSDâ†’JPYï¼‰</div>
      <div class="v" id="footerTotal">Â¥0</div>
    </div>
  </div>
</div>

<script>
/* ===== å®šæ•° ===== */
const MAX_MEMBERS=10,MAX_EXPENSES=100,MAX_DEPOSITS=100,MAX_FILE_SIZE=1024*1024,MAX_STRING_LEN=200;

/* ===== çŠ¶æ…‹ ===== */
let members=[],expenses=[],deposits=[];
let currentCurrency='JPY',currentDepositCurrency='JPY';
let exchangeRate=150,settlementMode='direct';
let editingExpenseIdx=-1,editingDepositIdx=-1;
let _lastDepositRefunds=null;

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const sanitize=s=>String(s??'').substring(0,MAX_STRING_LEN);
const esc=s=>String(s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const safe=s=>esc(sanitize(s));
const validateNum=(n,min=0,max=10000000)=>{const v=parseFloat(n);return!isNaN(v)&&v>=min&&v<=max?v:null;};
function clampInt(n,min,max){const v=Number.isFinite(n)?Math.trunc(n):parseInt(n,10);if(!Number.isFinite(v))return null;if(v<min||v>max)return null;return v;}

/* ===== ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ===== */
const fmtUSD=n=>{
  const num=Number(n||0),sign=num<0?'-':'',abs=Math.abs(num);
  const usd=`${sign}$${abs.toFixed(2)}`;
  if(!exchangeRate||!isFinite(exchangeRate)||exchangeRate<=0)return usd;
  const yen=Math.round(num*exchangeRate);
  const yenStr=yen>=0?`Â¥${yen.toLocaleString()}`:`-Â¥${Math.abs(yen).toLocaleString()}`;
  return`${usd}<span class="estimate">(â‰ˆ${yenStr})</span>`;
};

/* ===== ãƒˆãƒ¼ã‚¹ãƒˆ ===== */
function showToast(msg='OK'){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  clearTimeout(window.__toastTimer);window.__toastTimer=setTimeout(()=>t.classList.remove('show'),1600);
}

/* ===== ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° ===== */
let _confirmResolve=null;
function openConfirm(title,msg){
  return new Promise(resolve=>{
    _confirmResolve=resolve;
    document.getElementById('confirmTitle').textContent=title;
    document.getElementById('confirmMsg').textContent=msg;
    document.getElementById('confirmOkBtn').onclick=()=>{
      document.getElementById('confirmOverlay').classList.remove('active');
      _confirmResolve=null;
      resolve(true);
    };
    document.getElementById('confirmOverlay').classList.add('active');
  });
}
function closeConfirm(){
  document.getElementById('confirmOverlay').classList.remove('active');
  if(_confirmResolve){_confirmResolve(false);_confirmResolve=null;}
}

/* ===== ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ ===== */
function toggleRateEdit(){
  const row=document.getElementById('rateEditRow'),inp=document.getElementById('rateInput');
  if(row.classList.contains('visible')){cancelRateEdit();}
  else{inp.value=exchangeRate;row.classList.add('visible');inp.focus();inp.select();}
}
function cancelRateEdit(){document.getElementById('rateEditRow').classList.remove('visible');}
function applyRate(){
  const v=validateNum(document.getElementById('rateInput').value,1,1000);
  if(!v){showToast('âš  1ã€œ1000 ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  exchangeRate=v;localStorage.setItem('rateUpdatedAt',new Date().toISOString());saveData();showRateDisplay();cancelRateEdit();updateDisplay();showToast('ğŸ’± ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
}
function showRateDisplay(){
  const ts=localStorage.getItem('rateUpdatedAt');
  let dateStr='';
  if(ts){const d=new Date(ts);dateStr=` (${d.getMonth()+1}/${d.getDate()} æ›´æ–°)`;}
  document.getElementById('rateText').textContent=`ğŸ’± ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ: $1 = Â¥${exchangeRate.toFixed(2)}${dateStr}`;
}

/* ===== ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ– ===== */
function normalizeData(input){
  const out={members:[''],expenses:[],deposits:[],exchangeRate};
  if(!input||typeof input!=='object')return out;
  if(Array.isArray(input.members)){const m=input.members.slice(0,MAX_MEMBERS).map(x=>sanitize(x));out.members=m.length?m:[''];}
  const mLen=out.members.length;
  if(Array.isArray(input.expenses)){
    out.expenses=input.expenses.slice(0,MAX_EXPENSES).filter(e=>e&&typeof e==='object').map(e=>{
      const name=sanitize(e.name).trim(),amount=validateNum(e.amount),currency=(e.currency==='USD')?'USD':'JPY';
      const paidBy=clampInt(e.paidBy,0,mLen-1);
      const participants=Array.isArray(e.participants)?[...new Set(e.participants.map(p=>clampInt(p,0,mLen-1)).filter(p=>p!==null))]:[];
      if(!name||amount===null||paidBy===null||participants.length===0)return null;
      return{name,amount,currency,paidBy,participants,timestamp:e.timestamp||new Date().toISOString()};
    }).filter(Boolean);
  }
  if(Array.isArray(input.deposits)){
    out.deposits=input.deposits.slice(0,MAX_DEPOSITS).filter(d=>d&&typeof d==='object').map(d=>{
      const holder=clampInt(d.holder,0,mLen-1),from=clampInt(d.from,0,mLen-1),amount=validateNum(d.amount),currency=(d.currency==='USD')?'USD':'JPY';
      if(holder===null||from===null||holder===from||!amount)return null;
      return{holder,from,amount,currency,timestamp:d.timestamp||new Date().toISOString()};
    }).filter(Boolean);
  }
  const r=validateNum(input.exchangeRate,1,1000);if(r)out.exchangeRate=r;
  return out;
}

/* ===== åˆæœŸåŒ– ===== */
window.onload=()=>{
  loadData();if(!members.length)members=[''];
  updateMemberSelects();updateMemberDisplay();updateFocusMemberSelect();showRateDisplay();
  updateSettCards();
  updateDisplay();
};

/* ===== ãƒ¡ãƒ³ãƒãƒ¼ ===== */
function toggleMemberEdit(){
  const edit=document.getElementById('memberEdit'),display=document.getElementById('memberDisplay'),btn=document.getElementById('toggleMemberBtn');
  if(edit.style.display==='none'){edit.style.display='block';display.style.display='none';btn.textContent='ã‚­ãƒ£ãƒ³ã‚»ãƒ«';}
  else{edit.style.display='none';display.style.display='block';btn.textContent='ç·¨é›†';updateMemberDisplay();}
}
function saveMemberEdit(){
  document.getElementById('memberEdit').style.display='none';document.getElementById('memberDisplay').style.display='block';document.getElementById('toggleMemberBtn').textContent='ç·¨é›†';
  updateMemberDisplay();updateFocusMemberSelect();saveData();updateDisplay();
}
function updateMemberDisplay(){
  const d=document.getElementById('memberDisplay');
  if(members.every(m=>!m)){d.innerHTML='<p style="color:var(--muted);">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>';return;}
  d.innerHTML='';
  members.forEach(m=>{if(m){const s=document.createElement('span');s.style.cssText='display:inline-block;background:var(--surface-2);border:1px solid var(--line);padding:8px 16px;margin:5px;border-radius:999px;font-size:15px;font-weight:900;';s.textContent=m;d.appendChild(s);}});
}
function addMember(){if(members.length>=MAX_MEMBERS){showToast(`âš  æœ€å¤§${MAX_MEMBERS}äººã¾ã§`);return;}members.push('');updateMemberList();updateMemberSelects();updateFocusMemberSelect();saveData();}
async function removeMember(i){
  if(members.length<=1){showToast('âš  æœ€ä½1äººå¿…è¦ã§ã™');return;}
  const ok=await openConfirm('ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤','å‰Šé™¤ã™ã‚‹ã¨æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆæ”¯å‡º/é ã‹ã‚Šé‡‘ï¼‰ã«ã‚‚å½±éŸ¿ã—ã¾ã™ã€‚æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');if(!ok)return;
  members.splice(i,1);
  expenses=(expenses||[]).map(e=>{
    if(!e||typeof e!=='object')return null;let paidBy=Number(e.paidBy);if(Number.isNaN(paidBy))paidBy=0;
    if(paidBy===i)paidBy=0;else if(paidBy>i)paidBy-=1;
    let pts=Array.isArray(e.participants)?e.participants.slice():[];
    pts=pts.map(p=>Number(p)).filter(p=>!Number.isNaN(p)&&p!==i).map(p=>p>i?p-1:p);
    pts=[...new Set(pts)].filter(p=>p>=0&&p<members.length);
    if(pts.length===0){if(paidBy>=0&&paidBy<members.length)pts=[paidBy];else return null;}
    paidBy=clampInt(paidBy,0,members.length-1)??0;return{...e,paidBy,participants:pts};
  }).filter(Boolean);
  deposits=(deposits||[]).map(d=>{
    if(!d||typeof d!=='object')return null;let holder=Number(d.holder),from=Number(d.from);
    if(Number.isNaN(holder)||Number.isNaN(from))return null;if(holder===i||from===i)return null;
    if(holder>i)holder-=1;if(from>i)from-=1;
    holder=clampInt(holder,0,members.length-1);from=clampInt(from,0,members.length-1);
    if(holder===null||from===null||holder===from)return null;return{...d,holder,from};
  }).filter(Boolean);
  updateMemberList();updateMemberSelects();updateFocusMemberSelect();saveData();updateDisplay();
}
function updateMemberName(i,v){members[i]=sanitize(v);updateMemberSelects();updateFocusMemberSelect();saveData();updateDisplay();}
function updateMemberList(){
  const d=document.getElementById('memberList');d.innerHTML='';
  members.forEach((m,i)=>{
    const div=document.createElement('div');div.className='member-item';
    const inp=document.createElement('input');inp.type='text';inp.value=m;inp.placeholder=`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`;inp.maxLength=50;inp.onchange=e=>updateMemberName(i,e.target.value);div.appendChild(inp);
    if(members.length>1){const btn=document.createElement('button');btn.textContent='å‰Šé™¤';btn.onclick=()=>removeMember(i);div.appendChild(btn);}
    d.appendChild(div);
  });
}
function updateMemberSelects(){
  const opts=[{v:'',t:'é¸æŠ'},...members.map((m,i)=>({v:i,t:m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`}))];
  ['paidBy'].forEach(id=>{
    const s=document.getElementById(id);s.innerHTML='';
    opts.forEach(o=>{const opt=document.createElement('option');opt.value=o.v;opt.textContent=sanitize(o.t);s.appendChild(opt);});
  });
  const pc=document.getElementById('participantsCheckbox');pc.innerHTML='';
  members.forEach((m,i)=>{
    const div=document.createElement('div');div.className='checkbox-item';
    const cb=document.createElement('input');cb.type='checkbox';cb.id=`participant${i}`;cb.value=i;cb.checked=true;
    const lbl=document.createElement('label');lbl.htmlFor=`participant${i}`;lbl.textContent=sanitize(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`);
    div.appendChild(cb);div.appendChild(lbl);pc.appendChild(div);
  });
}
// ç¾åœ¨ã®é¸æŠçŠ¶æ…‹ã‚’ä¿æŒ
let _focusMemberIdx = 0;

function updateFocusMemberSelect(){
  const grid=document.getElementById('focusMemberBtns');
  if(!grid) return;
  grid.innerHTML='';
  // ã€Œå…¨å“¡ã€ãƒœã‚¿ãƒ³

  // å„ãƒ¡ãƒ³ãƒãƒ¼ãƒœã‚¿ãƒ³
  members.forEach((m,i)=>{
    if(!m&&members.length===1) return;
    const btn=document.createElement('button');
    btn.className='member-btn' + (_focusMemberIdx===i?' active':'');
    btn.textContent=sanitize(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`);
    btn.onclick=()=>{ _focusMemberIdx=i; updateFocusMemberSelect(); renderPersonalViews(); };
    grid.appendChild(btn);
  });
}

/* ===== é€šè²¨ ===== */
function setCurrency(c){currentCurrency=c;document.querySelectorAll('#expenseCurrencyToggle .currency-btn').forEach((b,i)=>b.classList.toggle('active',(c==='JPY'&&i===0)||(c==='USD'&&i===1)));}


/* ===== æ”¯å‡º CRUD ===== */
function submitExpense(){editingExpenseIdx>=0?updateExpense():addExpense();}
function addExpense(){
  if(expenses.length>=MAX_EXPENSES){showToast(`âš  æœ€å¤§${MAX_EXPENSES}ä»¶ã¾ã§`);return;}
  const name=sanitize(document.getElementById('expenseName').value).trim(),amt=validateNum(document.getElementById('expenseAmount').value),paidBy=parseInt(document.getElementById('paidBy').value);
  if(!name||amt===null||isNaN(paidBy)){showToast('âš  å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const parts=[];members.forEach((_,i)=>{const cb=document.getElementById(`participant${i}`);if(cb&&cb.checked)parts.push(i);});
  if(!parts.length){showToast('âš  å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  expenses.push({name,amount:amt,currency:currentCurrency,paidBy,participants:[...new Set(parts)],timestamp:new Date().toISOString()});
  clearExpenseForm();saveData();updateDisplay();showToast('âœ… æ”¯æ‰•ã„ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}
function startEditExpense(i){
  const e=expenses[i];editingExpenseIdx=i;
  document.getElementById('expenseName').value=e.name;document.getElementById('expenseAmount').value=e.amount;document.getElementById('paidBy').value=String(e.paidBy);
  setCurrency(e.currency);members.forEach((_,j)=>{const cb=document.getElementById(`participant${j}`);if(cb)cb.checked=e.participants.includes(j);});
  document.getElementById('expenseSubmitBtn').textContent='æ›´æ–°';document.getElementById('expenseEditBanner').classList.add('visible');
  scrollToSection('sec-expense');showToast('âœï¸ æ”¯æ‰•ã„ã‚’ç·¨é›†ä¸­');
}
function updateExpense(){
  const name=sanitize(document.getElementById('expenseName').value).trim(),amt=validateNum(document.getElementById('expenseAmount').value),paidBy=parseInt(document.getElementById('paidBy').value);
  if(!name||amt===null||isNaN(paidBy)){showToast('âš  å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const parts=[];members.forEach((_,i)=>{const cb=document.getElementById(`participant${i}`);if(cb&&cb.checked)parts.push(i);});
  if(!parts.length){showToast('âš  å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  expenses[editingExpenseIdx]={...expenses[editingExpenseIdx],name,amount:amt,currency:currentCurrency,paidBy,participants:[...new Set(parts)]};
  clearExpenseForm();saveData();updateDisplay();showToast('âœ… æ”¯æ‰•ã„ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
}
function cancelEditExpense(){clearExpenseForm();showToast('ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');}
function clearExpenseForm(){
  editingExpenseIdx=-1;document.getElementById('expenseName').value='';document.getElementById('expenseAmount').value='';document.getElementById('paidBy').value='';
  members.forEach((_,i)=>{const cb=document.getElementById(`participant${i}`);if(cb)cb.checked=true;});
  document.getElementById('expenseSubmitBtn').textContent='è¿½åŠ ';document.getElementById('expenseEditBanner').classList.remove('visible');
}
async function deleteExpense(i){
  const ok=await openConfirm('æ”¯æ‰•ã„ã‚’å‰Šé™¤',`ã€Œ${expenses[i].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);if(!ok)return;
  if(editingExpenseIdx===i)clearExpenseForm();else if(editingExpenseIdx>i)editingExpenseIdx--;
  expenses.splice(i,1);saveData();updateDisplay();showToast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ');
}
function displayExpenses(){
  const l=document.getElementById('expenseList');
  if(!expenses.length){l.innerHTML='<div class="empty-state"><p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';return;}
  let html='';
  expenses.forEach((e,i)=>{
    const nm=safe(e.name),paid=safe(members[e.paidBy]||`ãƒ¡ãƒ³ãƒãƒ¼${e.paidBy+1}`);
    const parts=e.participants.map(idx=>safe(members[idx]||`ãƒ¡ãƒ³ãƒãƒ¼${idx+1}`)).join(', ');
    const amt=e.currency==='JPY'?`Â¥${e.amount.toLocaleString()}`:fmtUSD(e.amount);
    const isEd=editingExpenseIdx===i;
    html+=`<div class="expense-item${isEd?' is-editing':''}">
      <div class="expense-color-bar"></div>
      <div class="expense-body">
        <div class="expense-header">
          <div class="expense-title">${nm}</div>
          <div class="expense-amount">${amt}</div>
        </div>
        <div class="expense-meta">
          <span class="expense-meta-chip">ğŸ’³ <b>${paid}</b></span>
          <span class="expense-meta-chip">ğŸ‘¥ ${parts}</span>
        </div>
      </div>
      <div class="expense-actions">
        <button class="expense-action-edit" onclick="startEditExpense(${i})">âœï¸ ç·¨é›†</button>
        <button class="expense-action-delete" onclick="deleteExpense(${i})">ğŸ—‘ å‰Šé™¤</button>
      </div>
    </div>`;
  });
  l.innerHTML=html;
}

/* ===== ç²¾ç®—è¨ˆç®— ===== */
function calculateExpenseBalances(){
  const bj=Array(members.length).fill(0),bu=Array(members.length).fill(0);
  expenses.forEach(e=>{const per=e.amount/e.participants.length,b=e.currency==='JPY'?bj:bu;b[e.paidBy]+=e.amount;e.participants.forEach(idx=>b[idx]-=per);});
  return{bj,bu};
}

function calculateSettlementTransactions(b){
  const t=[],c=[],d=[];
  b.forEach((bal,i)=>{if(bal>0.01)c.push({idx:i,amount:bal});else if(bal<-0.01)d.push({idx:i,amount:-bal});});
  let i=0,j=0;
  while(i<c.length&&j<d.length){const cr=c[i],db=d[j],a=Math.min(cr.amount,db.amount);t.push({from:db.idx,to:cr.idx,amount:a});cr.amount-=a;db.amount-=a;if(cr.amount<0.01)i++;if(db.amount<0.01)j++;}
  return t;
}
function buildDirectMatrix(includeDeposits){
  const n=members.length,jpy=Array.from({length:n},()=>Array(n).fill(0)),usd=Array.from({length:n},()=>Array(n).fill(0));
  expenses.forEach(e=>{const per=e.amount/e.participants.length,mat=e.currency==='USD'?usd:jpy;e.participants.forEach(idx=>{if(idx!==e.paidBy)mat[idx][e.paidBy]+=per;});});
  if(includeDeposits)deposits.forEach(d=>{const mat=d.currency==='USD'?usd:jpy;if(d.holder!==d.from)mat[d.holder][d.from]+=d.amount;});
  return{jpy,usd};
}
function netMatrix(mat){
  const n=mat.length,tx=[];
  for(let i=0;i<n;i++)for(let j=i+1;j<n;j++){const a=mat[i][j]||0,b=mat[j][i]||0,diff=a-b;if(Math.abs(diff)<0.01)continue;diff>0?tx.push({from:i,to:j,amount:diff}):tx.push({from:j,to:i,amount:-diff});}
  return tx;
}
function txToPayRecv(tx){const n=members.length,pay=Array(n).fill(0),recv=Array(n).fill(0);tx.forEach(t=>{pay[t.from]+=t.amount;recv[t.to]+=t.amount;});return{pay,recv};}
function updateSettCards(){
  ['direct','min'].forEach(m=>{
    const el=document.getElementById(`settCard-${m}`);
    if(el) el.classList.toggle('active', m===settlementMode);
  });
}
function setSettlementMode(mode){
  settlementMode=mode==='min'?'min':'direct';try{localStorage.setItem('settlementMode',settlementMode);}catch(e){}
  updateSettCards();updateDisplay();
}

function calculateSettlement(){
  const{bj,bu}=calculateExpenseBalances();

  let sJ=[],sU=[];
  if(settlementMode==='direct'){const mat=buildDirectMatrix(false);sJ=netMatrix(mat.jpy);sU=netMatrix(mat.usd);}
  else{sJ=calculateSettlementTransactions(bj);sU=calculateSettlementTransactions(bu);}
  // å††ã¨USDã‚’fromâ†’toã®ã‚­ãƒ¼ã§ãƒãƒ¼ã‚¸
  const pairMap={};
  sJ.forEach(s=>{const k=`${s.from}_${s.to}`;if(!pairMap[k])pairMap[k]={from:s.from,to:s.to,jpy:null,usd:null};pairMap[k].jpy=s.amount;});
  sU.forEach(s=>{const k=`${s.from}_${s.to}`;if(!pairMap[k])pairMap[k]={from:s.from,to:s.to,jpy:null,usd:null};pairMap[k].usd=s.amount;});
  const pairs=Object.values(pairMap);
  const html=pairs.length?pairs.map(p=>{
    const jStr=p.jpy!=null?`Â¥${Math.round(p.jpy).toLocaleString()}`:'';
    const uStr=p.usd!=null?fmtUSD(p.usd):'';
    const amtHtml=jStr&&uStr
      ?`<div style="text-align:right"><div class="settlement-amount">${jStr}</div><div class="settlement-amount-sub">${uStr}</div></div>`
      :`<div class="settlement-amount">${jStr||uStr}</div>`;
    return `<div class="settlement-item"><div class="settlement-text">${safe(members[p.from])} â†’ ${safe(members[p.to])}</div>${amtHtml}</div>`;
  }).join(''):`<div class="small" style="text-align:center;color:var(--muted);padding:8px;">ãªã—</div>`;
  document.getElementById('settlementList').innerHTML=html;
  _lastDepositRefunds=null;
}

/* ===== å€‹äººåˆ¥ã¾ã¨ã‚ï¼ˆâ˜…ãƒªãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ ===== */
function renderPersonalViews(){
  const wrap=document.getElementById('personalSummary'),details=document.getElementById('personalDetails');
  const matFinal=buildDirectMatrix(false),matExp=buildDirectMatrix(false);
  const finalTxJPY=netMatrix(matFinal.jpy),finalTxUSD=netMatrix(matFinal.usd);
  const expTxJPY=netMatrix(matExp.jpy),expTxUSD=netMatrix(matExp.usd);
  const finPRJ=txToPayRecv(finalTxJPY),finPRU=txToPayRecv(finalTxUSD);

  wrap.innerHTML='';
  members.forEach((m,i)=>{
    const payJ=finPRJ.pay[i],recvJ=finPRJ.recv[i],netJ=Math.round(recvJ-payJ);
    const payU=finPRU.pay[i],recvU=finPRU.recv[i],netU=recvU-payU,netUr=Math.round(netU*100)/100;

    const nbJ=netJ>0?'net-plus':netJ<0?'net-minus':'net-zero';
    const lblJ=netJ>0?`+Â¥${netJ.toLocaleString()}`:netJ<0?`-Â¥${Math.abs(netJ).toLocaleString()}`:'Â±Â¥0';
    const nbU=netUr>0?'net-plus':netUr<0?'net-minus':'net-zero';
    const lblU=netUr>0?`+$${netUr.toFixed(2)}`:netUr<0?`-$${Math.abs(netUr).toFixed(2)}`:'Â±$0.00';

    const card=document.createElement('div');card.className='personal-card';
    card.innerHTML=`
      <div class="personal-card-header">
        <div class="personal-card-name">ğŸ‘¤ ${safe(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`)}</div>
        <div class="personal-card-nets">
          <span class="net-badge ${nbJ}">${lblJ} å††</span>
          <span class="net-badge ${nbU}">${lblU} USD</span>
        </div>
      </div>
      <div class="personal-card-body">
        <div class="stat-row">
          <div class="stat-ccy">å††</div>
          <div class="stat-cell"><div class="stat-lbl">å—å–</div><div class="stat-val c-recv">Â¥${Math.round(recvJ).toLocaleString()}</div></div>
          <div class="stat-cell"><div class="stat-lbl">æ”¯æ‰•</div><div class="stat-val c-pay">Â¥${Math.round(payJ).toLocaleString()}</div></div>
          <div class="stat-cell"><div class="stat-lbl">å·®å¼•</div><div class="stat-val ${netJ>=0?'c-net-p':'c-net-m'}">${lblJ}</div></div>
        </div>
        <div class="stat-row">
          <div class="stat-ccy">USD</div>
          <div class="stat-cell"><div class="stat-lbl">å—å–</div><div class="stat-val c-recv">${fmtUSD(recvU)}</div></div>
          <div class="stat-cell"><div class="stat-lbl">æ”¯æ‰•</div><div class="stat-val c-pay">${fmtUSD(payU)}</div></div>
          <div class="stat-cell"><div class="stat-lbl">å·®å¼•</div><div class="stat-val ${netUr>=0?'c-net-p':'c-net-m'}">${fmtUSD(netU)}</div></div>
        </div>
      </div>
    `;
    wrap.appendChild(card);
  });

  const focus=_focusMemberIdx;
  if(focus===null||focus===undefined){details.innerHTML='<p style="text-align:center;color:var(--muted);padding:10px;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸ã¶ã¨æ˜ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';return;}
  const k=parseInt(focus),filterTx=tx=>tx.filter(x=>x.from===k||x.to===k);

  // é€é‡‘ã‚¢ã‚¤ãƒ†ãƒ 1ä»¶ã®HTML
  const txItem=(x,isJPY)=>`
    <div class="detail-tx-item">
      <div class="detail-tx-route">
        <span class="detail-tx-from">${safe(members[x.from])}</span>
        <span class="detail-tx-arrow">â†’</span>
        <span class="detail-tx-to">${safe(members[x.to])}</span>
      </div>
      <div class="detail-tx-amount">${isJPY?`Â¥${Math.round(x.amount).toLocaleString()}`:fmtUSD(x.amount)}</div>
    </div>`;

  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³1ã¤ï¼ˆå††+ãƒ‰ãƒ«ã¾ã¨ã‚ã¦ï¼‰
  const renderGroup=(title,badge,txJPY,txUSD)=>{
    const jpyItems=txJPY.length?txJPY.map(x=>txItem(x,true)).join(''):`<div class="detail-none">ãªã—</div>`;
    const usdItems=txUSD.length?txUSD.map(x=>txItem(x,false)).join(''):`<div class="detail-none">ãªã—</div>`;
    return `<div class="detail-group">
      <div class="detail-section">
        <div class="detail-section-header">
          <span class="detail-section-badge">${badge}</span>
          <span class="detail-section-title">${title}</span>
          <span class="detail-section-ccy">å††</span>
        </div>
        ${jpyItems}
      </div>
      <div class="detail-section">
        <div class="detail-section-header">
          <span class="detail-section-badge">${badge}</span>
          <span class="detail-section-title">${title}</span>
          <span class="detail-section-ccy">USD</span>
        </div>
        ${usdItems}
      </div>
    </div>`;
  };

  // ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ï¼ˆã‚³ãƒ”ãƒ¼ãƒ»ã‚·ã‚§ã‚¢ç”¨ï¼‰
  const buildShareText=()=>{
    const name=members[k]||`ãƒ¡ãƒ³ãƒãƒ¼${k+1}`;
    const line=(label,tx,isJPY)=>{
      if(!tx.length) return '';
      return tx.map(x=>{
        const from=members[x.from]||`ãƒ¡ãƒ³ãƒãƒ¼${x.from+1}`;
        const to=members[x.to]||`ãƒ¡ãƒ³ãƒãƒ¼${x.to+1}`;
        const amt=isJPY?`Â¥${Math.round(x.amount).toLocaleString()}`:`$${Math.abs(x.amount).toFixed(2)}`;
        return `  ${from} â†’ ${to}ï¼š${amt}`;
      }).join('\n');
    };
    const sections=[
      ['ã€æœ€çµ‚ç²¾ç®—ï¼ˆå††ï¼‰ã€‘',filterTx(finalTxJPY),true],
      ['ã€æœ€çµ‚ç²¾ç®—ï¼ˆUSDï¼‰ã€‘',filterTx(finalTxUSD),false],


    ].map(([label,tx,isJPY])=>{
      const rows=line(label,tx,isJPY);
      return rows?`${label}\n${rows}`:'';
    }).filter(Boolean).join('\n\n');
    return `ğŸ’° å‰²ã‚Šå‹˜æ˜ç´° â€” ${name}\n${'â”€'.repeat(20)}\n${sections}\n${'â”€'.repeat(20)}\nâ€» å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒªã‚ˆã‚Š`;
  };

  details.innerHTML=
    `<div style="font-size:15px;font-weight:900;color:var(--text);margin-bottom:12px;padding:4px 0;">ğŸ” ${safe(members[k])} ã®æ˜ç´°</div>`+
    `<div class="share-bar">
      <button class="share-btn share-btn-copy" onclick="copyDetailText()">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼</button>
      <button class="share-btn share-btn-share" onclick="shareDetail()">ğŸ”— ã‚·ã‚§ã‚¢</button>
    </div>`+
    renderGroup('æœ€çµ‚ç²¾ç®—ï¼ˆç›¸æ®ºæ¸ˆã¿ï¼‰','âœ…',filterTx(finalTxJPY),filterTx(finalTxUSD));

  // ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒ
  window._currentShareText = buildShareText();
}

/* ===== ãƒ•ãƒƒã‚¿ãƒ¼ãƒ»ãƒ¡ã‚¤ãƒ³æ›´æ–° ===== */
function updateFooterTotal(){
  let j=0,u=0;(expenses||[]).forEach(e=>{if(e.currency==='JPY')j+=Number(e.amount||0);else u+=Number(e.amount||0);});
  const ft=document.getElementById('footerTotal');if(ft)ft.textContent=`Â¥${Math.round(j+u*exchangeRate).toLocaleString()}`;
}
function updateDisplay(){
  updateSettCards();
  updateMemberList();displayExpenses();calculateSettlement();renderPersonalViews();updateFooterTotal();
}

/* ===== ä¿å­˜ãƒ»èª­è¾¼ ===== */
function saveData(){
  try{localStorage.setItem('warikanMembers',JSON.stringify(members));localStorage.setItem('warikanExpenses',JSON.stringify(expenses));localStorage.setItem('warikanDeposits',JSON.stringify(deposits));localStorage.setItem('exchangeRate',String(exchangeRate));localStorage.setItem('settlementMode',settlementMode);}catch(e){console.warn(e);}
}
function loadData(){
  try{
    const sm=localStorage.getItem('warikanMembers'),se=localStorage.getItem('warikanExpenses'),sd=localStorage.getItem('warikanDeposits'),sr=localStorage.getItem('exchangeRate'),ss=localStorage.getItem('settlementMode');
    const nd=normalizeData({members:sm?JSON.parse(sm):undefined,expenses:se?JSON.parse(se):undefined,deposits:sd?JSON.parse(sd):undefined,exchangeRate:sr?Number(sr):undefined});
    members=nd.members;expenses=nd.expenses;deposits=nd.deposits;exchangeRate=nd.exchangeRate;if(ss==='min'||ss==='direct')settlementMode=ss;
  }catch(e){console.error(e);}
}

/* ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ===== */
function exportData(){
  const d={members,expenses,deposits,exchangeRate,exportDate:new Date().toISOString()};
  const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');
  a.href=u;a.download='warikan_'+new Date().toISOString().split('T')[0]+'.json';a.click();URL.revokeObjectURL(u);
}
function importData(e){
  const f=e.target.files[0];if(!f)return;
  if(f.size>MAX_FILE_SIZE){showToast('âš  ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™');e.target.value='';return;}
  const r=new FileReader();
  r.onload=ev=>{
    try{const nd=normalizeData(JSON.parse(ev.target.result));members=nd.members;expenses=nd.expenses;deposits=nd.deposits;exchangeRate=nd.exchangeRate;localStorage.setItem('rateUpdatedAt',new Date().toISOString());saveData();updateMemberSelects();updateMemberDisplay();updateFocusMemberSelect();showRateDisplay();updateDisplay();showToast('âœ… èª­ã¿è¾¼ã¿å®Œäº†');}
    catch(err){showToast('âš  èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');console.error(err);}
  };
  r.readAsText(f);e.target.value='';
}

/* ===== æ˜ç´°ã‚³ãƒ”ãƒ¼ãƒ»ã‚·ã‚§ã‚¢ ===== */
function copyDetailText(){
  const text=window._currentShareText;
  if(!text){showToast('âš  ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„');return;}
  navigator.clipboard.writeText(text).then(()=>{
    showToast('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼LINEã«è²¼ã‚Šä»˜ã‘ã¦ã­');
  }).catch(()=>{
    // fallback
    const ta=document.createElement('textarea');ta.value=text;ta.style.position='fixed';ta.style.opacity='0';
    document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
    showToast('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  });
}
function shareDetail(){
  const text=window._currentShareText;
  if(!text){showToast('âš  ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„');return;}
  if(navigator.share){
    navigator.share({title:'å‰²ã‚Šå‹˜æ˜ç´°',text}).catch(()=>{});
  } else {
    copyDetailText();
  }
}

/* ===== ã‚«ãƒ¼ãƒ‰é–‹é–‰ ===== */
function toggleCard(bodyId, headerEl){
  const body=document.getElementById(bodyId);
  const chevron=headerEl.querySelector('.card-chevron');
  const isOpen=!body.classList.contains('collapsed');
  body.classList.toggle('collapsed', isOpen);
  if(chevron) chevron.classList.toggle('open', !isOpen);
}

/* ===== ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ===== */
function scrollToSection(id){const el=document.getElementById(id);if(!el)return;window.scrollTo({top:el.getBoundingClientRect().top+window.scrollY-10,behavior:'smooth'});}
</script>

</body></html>