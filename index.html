<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 15px;
}
.container { max-width: 800px; margin: 0 auto; }
.header {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 15px;
    text-align: center;
}
.header h1 { color: #333; font-size: 24px; margin-bottom: 8px; }
.header p { color: #666; font-size: 13px; }
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
}
.action-buttons button, .action-buttons label {
    padding: 14px 16px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 48px;
}
.btn-export { background: #48bb78; color: white; }
.btn-import { background: #3182ce; color: white; display: flex; align-items: center; justify-content: center; }
.btn-settlement { background: #ed8936; color: white; }
.card {
    background: white;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 15px;
}
.card h2 {
    color: #333;
    font-size: 18px;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 2px solid #667eea;
}
.input-group { margin-bottom: 15px; }
.input-group label {
    display: block;
    margin-bottom: 6px;
    color: #555;
    font-size: 14px;
    font-weight: 600;
}
.input-group input, .input-group select, .input-group textarea {
    width: 100%;
    padding: 16px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 16px;
    transition: border-color 0.2s;
}
.input-group input:focus, .input-group select:focus {
    outline: none;
    border-color: #667eea;
}
.member-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}
.member-item {
    display: flex;
    gap: 10px;
    align-items: center;
}
.member-item input { flex: 1; padding: 16px; font-size: 16px; }
.member-item button {
    padding: 12px 16px;
    background: #f56565;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    min-height: 48px;
}
.checkbox-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 15px;
}
.checkbox-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: #f7fafc;
    border-radius: 8px;
}
.checkbox-item input[type="checkbox"] {
    width: 24px;
    height: 24px;
    cursor: pointer;
}
.checkbox-item label {
    cursor: pointer;
    color: #555;
    font-size: 15px;
}
.btn {
    padding: 16px 24px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 56px;
}
.btn-primary {
    background: #667eea;
    color: white;
    width: 100%;
}
.btn-primary:active { transform: scale(0.98); }
.btn-add {
    background: #3182ce;
    color: white;
    padding: 12px 20px;
    font-size: 15px;
    min-height: 48px;
}
.btn-secondary {
    background: #48bb78;
    color: white;
    padding: 10px 16px;
    font-size: 14px;
    min-height: 44px;
}
.btn-danger {
    background: #f56565;
    color: white;
    padding: 10px 16px;
    font-size: 14px;
    min-height: 44px;
}
.expense-list { max-height: 500px; overflow-y: auto; }
.expense-item {
    background: #f7fafc;
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 12px;
    border-left: 4px solid #667eea;
}
.expense-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.expense-title { font-weight: 600; color: #333; font-size: 16px; }
.expense-amount { font-weight: 700; color: #667eea; font-size: 18px; }
.expense-details { font-size: 14px; color: #666; margin-bottom: 6px; }
.expense-actions { display: flex; gap: 10px; margin-top: 12px; }
.category-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    margin-right: 8px;
    background: #e2e8f0;
    color: #2d3748;
}
.settlement-item {
    background: #f7fafc;
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.settlement-text { color: #333; font-size: 15px; }
.settlement-amount { font-weight: 700; color: #f56565; font-size: 17px; }
.summary-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 15px;
}
.summary-card {
    background: #f7fafc;
    padding: 16px;
    border-radius: 10px;
    text-align: center;
}
.summary-label { font-size: 13px; color: #666; margin-bottom: 6px; }
.summary-value { font-size: 20px; font-weight: 700; color: #667eea; }
.currency-toggle {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 15px;
    background: #f7fafc;
    padding: 6px;
    border-radius: 10px;
}
.currency-btn {
    padding: 12px;
    border: none;
    border-radius: 8px;
    background: transparent;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.2s;
    min-height: 48px;
}
.currency-btn.active { background: #667eea; color: white; }
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.modal.active { display: flex; }
.empty-state { text-align: center; padding: 40px 20px; color: #999; }
.category-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
}
.category-tag {
    background: #e2e8f0;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.category-tag button {
    background: none;
    border: none;
    color: #f56565;
    cursor: pointer;
    font-size: 18px;
    padding: 0;
    width: 24px;
    height: 24px;
}
.settlement-modal {
    background: white;
    padding: 25px;
    border-radius: 15px;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    width: 90%;
}
.close-modal {
    float: right;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    color: #999;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.deposit-section {
    background: #fffbeb;
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 2px solid #fbbf24;
}
.deposit-label { font-weight: 600; color: #92400e; font-size: 14px; }
.deposit-value { font-weight: 700; color: #d97706; font-size: 17px; }
input[type="file"] { display: none; }
.info-text {
    font-size: 13px;
    color: #666;
    margin-bottom: 15px;
    padding: 12px;
    background: #f7fafc;
    border-radius: 8px;
    line-height: 1.5;
}
.rate-display {
    background: #e0e7ff;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    text-align: center;
}
.hr { height: 1px; background: #e2e8f0; margin: 12px 0; }
.small { font-size: 12px; color: #666; }
.pill { display:inline-block; padding: 6px 10px; background:#e2e8f0; border-radius: 999px; font-size: 12px; font-weight: 600; color:#2d3748; }
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>ğŸ’° å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</h1>
<p>ã‚°ãƒ«ãƒ¼ãƒ—ã®æ”¯å‡ºã‚’ç°¡å˜ç®¡ç†</p>
<div class="action-buttons">
<button class="btn-export" onclick="exportData()">ğŸ“¥ ä¿å­˜</button>
<label for="importFile" class="btn-import">ğŸ“¤ èª­è¾¼</label>
<input type="file" id="importFile" accept=".json" onchange="importData(event)">
<button class="btn-settlement" onclick="showSettlementModal()">ğŸ’³ ç²¾ç®—</button>
</div>
<div id="rateDisplay" class="rate-display">
<span id="rateText"></span>
</div>
</div>

<div class="card">
<h2>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ <button id="toggleMemberBtn" onclick="toggleMemberEdit()" style="float:right;padding:8px 16px;background:#667eea;color:white;border:none;border-radius:8px;font-size:13px;cursor:pointer;">ç·¨é›†</button></h2>
<div id="memberDisplay" style="padding:10px 0;"></div>
<div id="memberEdit" style="display:none;">
<div class="member-list" id="memberList"></div>
<button class="btn btn-add" onclick="addMember()">+ è¿½åŠ </button>
<button class="btn btn-primary" onclick="saveMemberEdit()" style="margin-top:10px;">ç¢ºå®š</button>
</div>
</div>

<div class="card">
<h2>ğŸ’µ é ã‹ã‚Šé‡‘</h2>
<div class="info-text">é ã‹ã‚Šé‡‘ã¯ã€Œé ã‹ã£ãŸäººâ†’é ã‘ãŸäººã€ã¸ã®å›ºå®šè¿”é‡‘ã¨ã—ã¦æ‰±ã„ã€æ”¯å‡ºã®ç²¾ç®—ãƒ­ã‚¸ãƒƒã‚¯ã«ã¯æ··ãœã¾ã›ã‚“ã€‚</div>
<div class="input-group">
<label>èª°ãŒé ã‹ã£ãŸï¼Ÿ</label>
<select id="depositHolder"><option value="">é¸æŠ</option></select>
</div>
<div class="input-group">
<label>èª°ã‹ã‚‰é ã‹ã£ãŸï¼Ÿ</label>
<select id="depositFrom"><option value="">é¸æŠ</option></select>
</div>
<div class="input-group">
<label>é‡‘é¡</label>
<input type="number" id="depositAmount" placeholder="0" min="0" max="10000000">
</div>
<div class="currency-toggle" id="depositCurrencyToggle">
<button class="currency-btn active" onclick="setDepositCurrency('JPY')">å††</button>
<button class="currency-btn" onclick="setDepositCurrency('USD')">ãƒ‰ãƒ«</button>
</div>
<button class="btn btn-primary" onclick="addDeposit()">è¨˜éŒ²</button>
<div id="depositsList" style="margin-top:15px;"></div>
</div>

<div class="card">
<h2>ğŸ’° æ”¯æ‰•ã„è¨˜éŒ²</h2>
<div class="currency-toggle" id="expenseCurrencyToggle">
<button class="currency-btn active" onclick="setCurrency('JPY')">å††</button>
<button class="currency-btn" onclick="setCurrency('USD')">ãƒ‰ãƒ«</button>
</div>
<div class="input-group">
<label>é …ç›®å</label>
<input type="text" id="expenseName" placeholder="ä¾‹: ãƒ©ãƒ³ãƒä»£" maxlength="100">
</div>
<div class="input-group">
<label>é‡‘é¡</label>
<input type="number" id="expenseAmount" placeholder="0" min="0" max="10000000" step="0.01">
</div>
<div class="input-group">
<label>æ”¯æ‰•ã£ãŸäºº</label>
<select id="paidBy"><option value="">é¸æŠ</option></select>
</div>
<div class="input-group">
<label>å‚åŠ è€…</label>
<div class="checkbox-group" id="participantsCheckbox"></div>
</div>
<button class="btn btn-primary" onclick="addExpense()">è¿½åŠ </button>
</div>

<div class="card">
<h2>ğŸ“ æ”¯æ‰•ã„ä¸€è¦§</h2>
<div class="expense-list" id="expenseList">
<div class="empty-state"><p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>
</div>
</div>

<div class="card">
<h2>ğŸ’³ ç²¾ç®—ï¼ˆæ”¯å‡ºã®ã¿ï¼‰</h2>
<div id="depositRefundSummary"></div>
<div class="summary-grid" id="summaryGrid"></div>
<div id="settlementList" class="settlement-list"></div>
</div>

<div class="card">
<h2>ğŸ‘¤ å€‹äººåˆ¥ã¾ã¨ã‚</h2>
<div class="info-text">ã€Œæ”¯å‡ºã®ç²¾ç®—ã€ï¼‹ã€Œé ã‹ã‚Šé‡‘ã®è¿”é‡‘ã€ã‚’åˆç®—ã—ã¦ã€å„äººã®å—å–/æ”¯æ‰•/ãƒãƒƒãƒˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ã‚»ãƒ¬ã‚¯ãƒˆã§1äººã‚’é¸ã¶ã¨æ˜ç´°ã«çµã‚Œã¾ã™ã€‚</div>
<div class="input-group">
<label>å¯¾è±¡ãƒ¡ãƒ³ãƒãƒ¼</label>
<select id="focusMember" onchange="renderPersonalViews()">
<option value="">å…¨å“¡</option>
</select>
</div>
<div id="personalSummary"></div>
<div class="hr"></div>
<div id="personalDetails"></div>
</div>

</div>

<script>
const MAX_MEMBERS=10;const MAX_EXPENSES=100;const MAX_DEPOSITS=100;const MAX_FILE_SIZE=1024*1024;const MAX_STRING_LEN=200;
let members=[];let expenses=[];let deposits=[];
let currentCurrency='JPY';let currentDepositCurrency='JPY';let exchangeRate=150;
const sanitize=s=>String(s||'').substring(0,MAX_STRING_LEN);
const validateNum=(n,min=0,max=10000000)=>{const v=parseFloat(n);return !isNaN(v)&&v>=min&&v<=max?v:null};

window.onload=()=>{loadData();if(!members.length)members=[''];updateMemberSelects();updateMemberDisplay();updateFocusMemberSelect();showRateDisplay();updateDisplay();};

function toggleMemberEdit(){const edit=document.getElementById('memberEdit');const display=document.getElementById('memberDisplay');const btn=document.getElementById('toggleMemberBtn');if(edit.style.display==='none'){edit.style.display='block';display.style.display='none';btn.textContent='ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}else{edit.style.display='none';display.style.display='block';btn.textContent='ç·¨é›†';updateMemberDisplay()}}
function saveMemberEdit(){document.getElementById('memberEdit').style.display='none';document.getElementById('memberDisplay').style.display='block';document.getElementById('toggleMemberBtn').textContent='ç·¨é›†';updateMemberDisplay();updateFocusMemberSelect();saveData();updateDisplay();}

function updateMemberDisplay(){
  const d=document.getElementById('memberDisplay');
  if(members.every(m=>!m)){d.innerHTML='<p style="color:#999;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>';return}
  d.innerHTML='';
  members.forEach((m,i)=>{if(m){const span=document.createElement('span');span.style.cssText='display:inline-block;background:#e2e8f0;padding:8px 16px;margin:5px;border-radius:8px;font-size:15px;';span.textContent=m;d.appendChild(span)}})
}
function showRateDisplay(){
  const rt=document.getElementById('rateText');
  rt.textContent=`ğŸ’± ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ: $1 = Â¥${exchangeRate.toFixed(2)}`
}
function addMember(){if(members.length>=MAX_MEMBERS){alert(`æœ€å¤§${MAX_MEMBERS}äººã¾ã§`);return}members.push('');updateMemberList();updateMemberSelects();updateFocusMemberSelect();saveData();}
function removeMember(i){if(members.length<=1){alert('æœ€ä½1äººå¿…è¦');return}members.splice(i,1);updateMemberList();updateMemberSelects();updateFocusMemberSelect();saveData();updateDisplay();}
function updateMemberName(i,v){members[i]=sanitize(v);updateMemberSelects();updateFocusMemberSelect();saveData();updateDisplay();}
function updateMemberList(){
  const d=document.getElementById('memberList');d.innerHTML='';
  members.forEach((m,i)=>{const div=document.createElement('div');div.className='member-item';
    const inp=document.createElement('input');inp.type='text';inp.value=m;inp.placeholder=`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`;inp.maxLength=50;inp.onchange=e=>updateMemberName(i,e.target.value);div.appendChild(inp);
    if(members.length>1){const btn=document.createElement('button');btn.textContent='å‰Šé™¤';btn.onclick=()=>removeMember(i);div.appendChild(btn)}
    d.appendChild(div)
  })
}
function updateMemberSelects(){
  const opts=[{v:'',t:'é¸æŠ'},...members.map((m,i)=>({v:i,t:m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`}))];
  ['paidBy','depositHolder','depositFrom'].forEach(id=>{
    const s=document.getElementById(id);s.innerHTML='';
    opts.forEach(o=>{const opt=document.createElement('option');opt.value=o.v;opt.textContent=sanitize(o.t);s.appendChild(opt)})
  });
  const pc=document.getElementById('participantsCheckbox');pc.innerHTML='';
  members.forEach((m,i)=>{
    const div=document.createElement('div');div.className='checkbox-item';
    const cb=document.createElement('input');cb.type='checkbox';cb.id=`participant${i}`;cb.value=i;cb.checked=true;
    const lbl=document.createElement('label');lbl.htmlFor=`participant${i}`;lbl.textContent=sanitize(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`);
    div.appendChild(cb);div.appendChild(lbl);pc.appendChild(div)
  })
}
function updateFocusMemberSelect(){
  const s=document.getElementById('focusMember');const cur=s.value;
  s.innerHTML='';const opt0=document.createElement('option');opt0.value='';opt0.textContent='å…¨å“¡';s.appendChild(opt0);
  members.forEach((m,i)=>{const opt=document.createElement('option');opt.value=String(i);opt.textContent=sanitize(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`);s.appendChild(opt)});
  if([...s.options].some(o=>o.value===cur)) s.value=cur;
}
function setCurrency(c){currentCurrency=c;document.querySelectorAll('#expenseCurrencyToggle .currency-btn').forEach((b,i)=>{b.classList.toggle('active',(c==='JPY'&&i===0)||(c==='USD'&&i===1))})}
function setDepositCurrency(c){currentDepositCurrency=c;document.querySelectorAll('#depositCurrencyToggle .currency-btn').forEach((b,i)=>{b.classList.toggle('active',(c==='JPY'&&i===0)||(c==='USD'&&i===1))})}

function addDeposit(){
  if(deposits.length>=MAX_DEPOSITS){alert(`æœ€å¤§${MAX_DEPOSITS}ä»¶ã¾ã§`);return}
  const h=parseInt(document.getElementById('depositHolder').value);
  const f=parseInt(document.getElementById('depositFrom').value);
  const a=validateNum(document.getElementById('depositAmount').value);
  if(isNaN(h)||isNaN(f)||!a){alert('å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');return}
  if(h===f){alert('åˆ¥ã®äººã‚’é¸æŠ');return}
  deposits.push({holder:h,from:f,amount:a,currency:currentDepositCurrency,timestamp:new Date().toISOString()});
  document.getElementById('depositHolder').value='';document.getElementById('depositFrom').value='';document.getElementById('depositAmount').value='';
  saveData();updateDisplay();
}
function deleteDeposit(i){deposits.splice(i,1);saveData();updateDisplay();}
function displayDeposits(){
  const d=document.getElementById('depositsList');
  if(!deposits.length){d.innerHTML='';return}
  d.innerHTML='<h3 style="margin-bottom:10px;font-size:14px;font-weight:600;">ä¸€è¦§</h3>';
  deposits.forEach((dep,i)=>{
    const div=document.createElement('div');div.className='settlement-item';
    div.innerHTML=`<span>${sanitize(members[dep.holder]||`ãƒ¡ãƒ³ãƒãƒ¼${dep.holder+1}`)}ãŒ${sanitize(members[dep.from]||`ãƒ¡ãƒ³ãƒãƒ¼${dep.from+1}`)}ã‹ã‚‰</span>
                   <span style="display:flex;gap:10px;align-items:center;">
                     <b style="color:#d97706;">${dep.currency==='JPY'?`Â¥${dep.amount.toLocaleString()}`:`$${dep.amount.toFixed(2)}`}</b>
                     <button class="btn btn-danger" style="padding:8px 12px;font-size:12px;min-height:auto;" onclick="deleteDeposit(${i})">å‰Šé™¤</button>
                   </span>`;
    d.appendChild(div);
  })
}

function addExpense(){
  if(expenses.length>=MAX_EXPENSES){alert(`æœ€å¤§${MAX_EXPENSES}ä»¶ã¾ã§`);return}
  const name=sanitize(document.getElementById('expenseName').value).trim();
  const amt=validateNum(document.getElementById('expenseAmount').value);
  const paidBy=parseInt(document.getElementById('paidBy').value);
  if(!name||!amt||isNaN(paidBy)){alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›');return}
  const parts=[];
  members.forEach((_,i)=>{const cb=document.getElementById(`participant${i}`);if(cb&&cb.checked)parts.push(i)});
  if(!parts.length){alert('å‚åŠ è€…ã‚’é¸æŠ');return}
  expenses.push({name,amount:amt,currency:currentCurrency,paidBy,participants:parts,timestamp:new Date().toISOString()});
  document.getElementById('expenseName').value='';document.getElementById('expenseAmount').value='';document.getElementById('paidBy').value='';
  members.forEach((_,i)=>{const cb=document.getElementById(`participant${i}`);if(cb)cb.checked=true});
  saveData();updateDisplay();
}
function deleteExpense(i){expenses.splice(i,1);saveData();updateDisplay();}
function displayExpenses(){
  const l=document.getElementById('expenseList');
  if(!expenses.length){l.innerHTML='<div class="empty-state"><p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';return}
  l.innerHTML='';
  expenses.forEach((e,i)=>{
    const div=document.createElement('div');div.className='expense-item';
    div.innerHTML=`<div class="expense-header">
      <div class="expense-title">${sanitize(e.name)}</div>
      <div class="expense-amount">${e.currency==='JPY'?`Â¥${e.amount.toLocaleString()}`:`$${e.amount.toFixed(2)}`}</div>
    </div>
    <div class="expense-details">æ”¯æ‰•: ${sanitize(members[e.paidBy]||`ãƒ¡ãƒ³ãƒãƒ¼${e.paidBy+1}`)}</div>
    <div class="expense-details">å‚åŠ : ${e.participants.map(idx=>sanitize(members[idx]||`ãƒ¡ãƒ³ãƒãƒ¼${idx+1}`)).join(', ')}</div>
    <div class="expense-actions">
      <button class="btn btn-danger" onclick="deleteExpense(${i})">å‰Šé™¤</button>
    </div>`;
    l.appendChild(div);
  })
}

function calculateExpenseBalances(){
  const bj=Array(members.length).fill(0);
  const bu=Array(members.length).fill(0);
  expenses.forEach(e=>{
    const per=e.amount/e.participants.length;
    const b=e.currency==='JPY'?bj:bu;
    b[e.paidBy]+=e.amount;
    e.participants.forEach(idx=>b[idx]-=per);
  });
  return {bj,bu};
}
function calculateDepositRefunds(){
  const refundsJPY=[]; const refundsUSD=[];
  const payJ=Array(members.length).fill(0), recvJ=Array(members.length).fill(0);
  const payU=Array(members.length).fill(0), recvU=Array(members.length).fill(0);
  deposits.forEach(d=>{
    const item={from:d.holder,to:d.from,amount:d.amount};
    if(d.currency==='JPY'){refundsJPY.push(item);payJ[d.holder]+=d.amount;recvJ[d.from]+=d.amount}
    else{refundsUSD.push(item);payU[d.holder]+=d.amount;recvU[d.from]+=d.amount}
  });
  return {refundsJPY,refundsUSD,payJ,recvJ,payU,recvU};
}
function calculateSettlementTransactions(b){
  const t=[],c=[],d=[];
  b.forEach((bal,i)=>{if(bal>0.01)c.push({idx:i,amount:bal});else if(bal<-0.01)d.push({idx:i,amount:-bal})});
  let i=0,j=0;
  while(i<c.length&&j<d.length){
    const cr=c[i], db=d[j];
    const a=Math.min(cr.amount,db.amount);
    t.push({from:db.idx,to:cr.idx,amount:a});
    cr.amount-=a;db.amount-=a;
    if(cr.amount<0.01)i++;
    if(db.amount<0.01)j++;
  }
  return t;
}
function displayDepositRefundSummary(refunds){
  const box=document.getElementById('depositRefundSummary');
  if(!deposits.length){box.innerHTML='';return}
  let html='<div class="deposit-section"><h3 style="margin-bottom:10px;color:#92400e;font-size:15px;">ğŸ’µ é ã‹ã‚Šé‡‘ã®è¿”é‡‘ï¼ˆå›ºå®šï¼‰</h3>';
  refunds.refundsJPY.forEach(x=>{html+=`<div class="settlement-item" style="background:transparent;padding:10px 0;"><span class="deposit-label">${sanitize(members[x.from])} â†’ ${sanitize(members[x.to])}</span><span class="deposit-value">Â¥${x.amount.toLocaleString()}</span></div>`});
  refunds.refundsUSD.forEach(x=>{html+=`<div class="settlement-item" style="background:transparent;padding:10px 0;"><span class="deposit-label">${sanitize(members[x.from])} â†’ ${sanitize(members[x.to])}</span><span class="deposit-value">$${x.amount.toFixed(2)}</span></div>`});
  html+='</div>';
  box.innerHTML=html;
}
function calculateSettlement(){
  const {bj,bu}=calculateExpenseBalances();
  const refunds=calculateDepositRefunds();
  displayDepositRefundSummary(refunds);

  const sg=document.getElementById('summaryGrid');sg.innerHTML='';
  members.forEach((m,i)=>{
    const div=document.createElement('div');div.className='summary-card';
    div.innerHTML=`<div class="summary-label">${sanitize(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`)}</div>
                   <div class="summary-value">Â¥${Math.round(bj[i]).toLocaleString()} / $${bu[i].toFixed(2)}</div>`;
    sg.appendChild(div);
  });

  const settlementsJPY=calculateSettlementTransactions(bj);
  const settlementsUSD=calculateSettlementTransactions(bu);
  const sl=document.getElementById('settlementList');sl.innerHTML='<h3 style="margin-top:20px;margin-bottom:15px;color:#333;">ç²¾ç®—æ–¹æ³•ï¼ˆæ”¯å‡ºï¼‰</h3>';
  settlementsJPY.forEach(s=>{sl.innerHTML+=`<div class="settlement-item"><div class="settlement-text">${sanitize(members[s.from])} â†’ ${sanitize(members[s.to])}</div><div class="settlement-amount">Â¥${Math.round(s.amount).toLocaleString()}</div></div>`});
  settlementsUSD.forEach(s=>{sl.innerHTML+=`<div class="settlement-item"><div class="settlement-text">${sanitize(members[s.from])} â†’ ${sanitize(members[s.to])}</div><div class="settlement-amount">$${s.amount.toFixed(2)}</div></div>`});

  window.__lastExpenseBalances={bj,bu};
  window.__lastExpenseSettlements={settlementsJPY,settlementsUSD};
  window.__lastDepositRefunds=refunds;
}

function renderPersonalViews(){
  const wrap=document.getElementById('personalSummary');
  const details=document.getElementById('personalDetails');
  const balances=window.__lastExpenseBalances||calculateExpenseBalances();
  const refunds=window.__lastDepositRefunds||calculateDepositRefunds();
  const settlements=window.__lastExpenseSettlements||{settlementsJPY:calculateSettlementTransactions(balances.bj),settlementsUSD:calculateSettlementTransactions(balances.bu)};
  const n=members.length;

  const expPayJ=balances.bj.map(v=>v<0?-v:0), expRecvJ=balances.bj.map(v=>v>0?v:0);
  const expPayU=balances.bu.map(v=>v<0?-v:0), expRecvU=balances.bu.map(v=>v>0?v:0);

  const payJ=expPayJ.map((v,i)=>v+refunds.payJ[i]);
  const recvJ=expRecvJ.map((v,i)=>v+refunds.recvJ[i]);
  const netJ=recvJ.map((v,i)=>v-payJ[i]);

  const payU=expPayU.map((v,i)=>v+refunds.payU[i]);
  const recvU=expRecvU.map((v,i)=>v+refunds.recvU[i]);
  const netU=recvU.map((v,i)=>v-payU[i]);

  wrap.innerHTML='';
  members.forEach((m,i)=>{
    const div=document.createElement('div');div.className='settlement-item';
    div.innerHTML=`<div class="settlement-text"><b>${sanitize(m)}</b><div class="small">å—å– / æ”¯æ‰• / ãƒãƒƒãƒˆ</div></div>
      <div style="text-align:right">
        <div><span class="pill">å††</span> å—å– Â¥${Math.round(recvJ[i]).toLocaleString()} / æ”¯æ‰• Â¥${Math.round(payJ[i]).toLocaleString()} / <b>${netJ[i]>=0?'+':'-'}Â¥${Math.round(Math.abs(netJ[i])).toLocaleString()}</b></div>
        <div style="margin-top:4px"><span class="pill">ãƒ‰ãƒ«</span> å—å– $${recvU[i].toFixed(2)} / æ”¯æ‰• $${payU[i].toFixed(2)} / <b>${netU[i]>=0?'+':'-'}$${Math.abs(netU[i]).toFixed(2)}</b></div>
      </div>`;
    wrap.appendChild(div);
  });

  const focus=document.getElementById('focusMember').value;
  if(focus===''){details.innerHTML='<p style="text-align:center;color:#999;padding:10px;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸ã¶ã¨æ˜ç´°ãŒå‡ºã¾ã™</p>';return;}
  const k=parseInt(focus);
  const makeList=(arr,label,isRefund)=>{
    const hit=arr.filter(x=>x.from===k||x.to===k);
    let h=`<div style="margin-top:12px;margin-bottom:8px;font-weight:700;">${label}</div>`;
    if(!hit.length) return h+`<div class="small" style="text-align:center;color:#999;padding:8px;">ãªã—</div>`;
    hit.forEach(x=>{
      h+=`<div class="settlement-item"><div class="settlement-text">${sanitize(members[x.from])} â†’ ${sanitize(members[x.to])}${isRefund?'ï¼ˆè¿”é‡‘ï¼‰':''}</div>
          <div class="settlement-amount">${label.includes('å††')?`Â¥${Math.round(x.amount).toLocaleString()}`:`$${x.amount.toFixed(2)}`}</div></div>`;
    });
    return h;
  };
  details.innerHTML=`<h3 style="margin-bottom:10px;color:#333;">ğŸ” ${sanitize(members[k])} ã®æ˜ç´°</h3>` +
    makeList(settlements.settlementsJPY,'ğŸ’³ æ”¯å‡ºã®ç²¾ç®—ï¼ˆå††ï¼‰',false) +
    makeList(settlements.settlementsUSD,'ğŸ’³ æ”¯å‡ºã®ç²¾ç®—ï¼ˆãƒ‰ãƒ«ï¼‰',false) +
    makeList(refunds.refundsJPY,'ğŸ’µ é ã‹ã‚Šé‡‘ï¼ˆå††ï¼‰',true) +
    makeList(refunds.refundsUSD,'ğŸ’µ é ã‹ã‚Šé‡‘ï¼ˆãƒ‰ãƒ«ï¼‰',true);
}

function updateDisplay(){
  updateMemberList();
  displayDeposits();
  displayExpenses();
  calculateSettlement();
  renderPersonalViews();
}

function exportData(){
  const d={members,expenses,deposits,exchangeRate,exportDate:new Date().toISOString()};
  const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const u=URL.createObjectURL(b);
  const l=document.createElement('a');
  l.href=u;l.download='warikan_'+new Date().toISOString().split('T')[0]+'.json';
  l.click();URL.revokeObjectURL(u);
}
function importData(e){
  const f=e.target.files[0];if(!f)return;
  if(f.size>MAX_FILE_SIZE){alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™');e.target.value='';return}
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      members=(d.members||members).map(sanitize);
      expenses=(d.expenses||expenses);
      deposits=(d.deposits||deposits);
      exchangeRate=Number(d.exchangeRate)||exchangeRate;
      saveData();updateMemberSelects();updateMemberDisplay();updateFocusMemberSelect();showRateDisplay();updateDisplay();
      alert('èª­ã¿è¾¼ã¿å®Œäº†');
    }catch(err){alert('èª­ã¿è¾¼ã¿å¤±æ•—');console.error(err)}
  };
  r.readAsText(f);e.target.value='';
}
function saveData(){
  localStorage.setItem('warikanMembers',JSON.stringify(members));
  localStorage.setItem('warikanExpenses',JSON.stringify(expenses));
  localStorage.setItem('warikanDeposits',JSON.stringify(deposits));
  localStorage.setItem('exchangeRate',String(exchangeRate));
}
function loadData(){
  try{
    const sm=localStorage.getItem('warikanMembers');if(sm)members=JSON.parse(sm);
    const se=localStorage.getItem('warikanExpenses');if(se)expenses=JSON.parse(se);
    const sd=localStorage.getItem('warikanDeposits');if(sd)deposits=JSON.parse(sd);
    const sr=localStorage.getItem('exchangeRate');if(sr)exchangeRate=Number(sr)||exchangeRate;
  }catch(e){console.error(e)}
}
</script>
</body>
</html>
