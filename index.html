<html lang="ja"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 15px;
}
.container { max-width: 800px; margin: 0 auto; }
.header {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 15px;
    text-align: center;
}
.header h1 { color: #333; font-size: 24px; margin-bottom: 8px; }
.header p { color: #666; font-size: 13px; }
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
}
.action-buttons button, .action-buttons label {
    padding: 14px 16px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 48px;
}
.btn-export { background: #48bb78; color: white; }
.btn-import { background: #3182ce; color: white; display: flex; align-items: center; justify-content: center; }
.card {
    background: white;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 15px;
}
.card h2 {
    color: #333;
    font-size: 18px;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 2px solid #667eea;
}
.input-group { margin-bottom: 15px; }
.input-group label {
    display: block;
    margin-bottom: 6px;
    color: #555;
    font-size: 14px;
    font-weight: 600;
}
.input-group input, .input-group select {
    width: 100%;
    padding: 16px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 16px;
    transition: border-color 0.2s;
}
.input-group input:focus, .input-group select:focus {
    outline: none;
    border-color: #667eea;
}
.member-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}
.member-item {
    display: flex;
    gap: 10px;
    align-items: center;
}
.member-item input { flex: 1; padding: 16px; font-size: 16px; }
.member-item button {
    padding: 12px 16px;
    background: #f56565;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    min-height: 48px;
}
.checkbox-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 15px;
}
.checkbox-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: #f7fafc;
    border-radius: 8px;
}
.checkbox-item input[type="checkbox"] {
    width: 24px;
    height: 24px;
    cursor: pointer;
}
.checkbox-item label {
    cursor: pointer;
    color: #555;
    font-size: 15px;
}
.btn {
    padding: 16px 24px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 56px;
}
.btn-primary {
    background: #667eea;
    color: white;
    width: 100%;
}
.btn-primary:active { transform: scale(0.98); }
.btn-add {
    background: #3182ce;
    color: white;
    padding: 12px 20px;
    font-size: 15px;
    min-height: 48px;
}
.btn-danger {
    background: #f56565;
    color: white;
    padding: 10px 16px;
    font-size: 14px;
    min-height: 44px;
}
.expense-list { max-height: 500px; overflow-y: auto; }
.expense-item {
    background: #f7fafc;
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 12px;
    border-left: 4px solid #667eea;
}
.expense-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.expense-title { font-weight: 600; color: #333; font-size: 16px; }
.expense-amount { font-weight: 700; color: #667eea; font-size: 18px; }
.expense-details { font-size: 14px; color: #666; margin-bottom: 6px; }
.expense-actions { display: flex; gap: 10px; margin-top: 12px; }
.settlement-item {
    background: #f7fafc;
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.settlement-text { color: #333; font-size: 15px; }
.settlement-amount { font-weight: 700; color: #f56565; font-size: 17px; }
.summary-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 15px;
}
.summary-card {
    background: #f7fafc;
    padding: 16px;
    border-radius: 10px;
    text-align: center;
}
.summary-label { font-size: 13px; color: #666; margin-bottom: 6px; }
.summary-value { font-size: 20px; font-weight: 700; color: #667eea; }
.currency-toggle {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 15px;
    background: #f7fafc;
    padding: 6px;
    border-radius: 10px;
}
.currency-btn {
    padding: 12px;
    border: none;
    border-radius: 8px;
    background: transparent;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.2s;
    min-height: 48px;
}
.currency-btn.active { background: #667eea; color: white; }
.empty-state { text-align: center; padding: 40px 20px; color: #999; }
.deposit-section {
    background: #fffbeb;
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 2px solid #fbbf24;
}
.deposit-label { font-weight: 600; color: #92400e; font-size: 14px; }
.deposit-value { font-weight: 700; color: #d97706; font-size: 17px; }
input[type="file"] { display: none; }
.info-text {
    font-size: 13px;
    color: #666;
    margin-bottom: 15px;
    padding: 12px;
    background: #f7fafc;
    border-radius: 8px;
    line-height: 1.5;
}
.rate-display {
    background: #e0e7ff;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    text-align: center;
}
.hr { height: 1px; background: #e2e8f0; margin: 12px 0; }
.small { font-size: 12px; color: #666; }
.pill { display:inline-block; padding: 6px 10px; background:#e2e8f0; border-radius: 999px; font-size: 12px; font-weight: 600; color:#2d3748; }
.estimate { font-size:11px; color:#999; margin-left:6px; }

.copy-row {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin: 8px 0 12px;
}
.copy-btn {
  padding: 10px 14px;
  border: none;
  border-radius: 10px;
  background: #3182ce;
  color: white;
  font-weight: 700;
  cursor: pointer;
  min-height: 42px;
  font-size: 13px;
  white-space: nowrap;
}
.copy-btn:active { transform: scale(0.98); }
.toast {
  position: fixed;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%);
  background: rgba(17, 24, 39, 0.92);
  color: white;
  padding: 10px 14px;
  border-radius: 999px;
  font-size: 13px;
  z-index: 9999;
  display: none;
}
.toast.show { display:block; }

.copy-row{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:10px;}
@media (max-width:420px){.summary-grid{grid-template-columns:1fr;}}
.settlement-item{align-items:flex-start;gap:10px;}

</style>

<style>
.copy-row { display:flex !important; flex-wrap:wrap; justify-content:space-between; gap:10px; margin:10px 0; }
.copy-btn { display:inline-block !important; background:#3182ce; color:#fff; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
</style>

</head>

<body>
<div class="container">
  <div class="header">
    <h1>ğŸ’° å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</h1>
    <p>ã‚°ãƒ«ãƒ¼ãƒ—ã®æ”¯å‡ºã‚’ç°¡å˜ç®¡ç†</p>
    <div class="action-buttons">
      <button class="btn-export" onclick="exportData()">ğŸ“¥ ä¿å­˜</button>
      <label for="importFile" class="btn-import">ğŸ“¤ èª­è¾¼</label>
      <input type="file" id="importFile" accept=".json" onchange="importData(event)">
    </div>
    <div id="rateDisplay" class="rate-display">
      <span id="rateText"><span>ğŸ’± ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ: $1 = Â¥150.00 <button style="margin-left: 10px; padding: 4px 8px; background: rgb(102, 126, 234); color: white; border: medium; border-radius: 6px; font-size: 12px; cursor: pointer;">å¤‰æ›´</button></span></span>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼
      <button id="toggleMemberBtn" onclick="toggleMemberEdit()" style="float:right;padding:8px 16px;background:#667eea;color:white;border:none;border-radius:8px;font-size:13px;cursor:pointer;">
        ç·¨é›†
      </button>
    </h2>
    <div id="memberDisplay" style="padding:10px 0;"><p style="color:#999;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</p></div>
    <div id="memberEdit" style="display:none;">
      <div class="member-list" id="memberList"><div class="member-item"><input type="text" placeholder="ãƒ¡ãƒ³ãƒãƒ¼1" maxlength="50"></div></div>
      <button class="btn btn-add" onclick="addMember()">+ è¿½åŠ </button>
      <button class="btn btn-primary" onclick="saveMemberEdit()" style="margin-top:10px;">ç¢ºå®š</button>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ’µ é ã‹ã‚Šé‡‘</h2>
    <div class="info-text">é ã‹ã‚Šé‡‘ã¯ã€Œé ã‹ã£ãŸäººâ†’é ã‘ãŸäººã€ã¸ã®å›ºå®šè¿”é‡‘ã¨ã—ã¦æ‰±ã„ã€æ”¯å‡ºã®ç²¾ç®—ãƒ­ã‚¸ãƒƒã‚¯ã«ã¯æ··ãœã¾ã›ã‚“ã€‚</div>
    <div class="input-group">
      <label>èª°ãŒé ã‹ã£ãŸï¼Ÿ</label>
      <select id="depositHolder"><option value="">é¸æŠ</option><option value="0">ãƒ¡ãƒ³ãƒãƒ¼1</option></select>
    </div>
    <div class="input-group">
      <label>èª°ã‹ã‚‰é ã‹ã£ãŸï¼Ÿ</label>
      <select id="depositFrom"><option value="">é¸æŠ</option><option value="0">ãƒ¡ãƒ³ãƒãƒ¼1</option></select>
    </div>
    <div class="input-group">
      <label>é‡‘é¡</label>
      <input type="number" id="depositAmount" placeholder="0" min="0" max="10000000">
    </div>
    <div class="currency-toggle" id="depositCurrencyToggle">
      <button class="currency-btn active" onclick="setDepositCurrency('JPY')">å††</button>
      <button class="currency-btn" onclick="setDepositCurrency('USD')">ãƒ‰ãƒ«</button>
    </div>
    <button class="btn btn-primary" onclick="addDeposit()">è¨˜éŒ²</button>
    <div id="depositsList" style="margin-top:15px;"></div>
  </div>

  <div class="card">
    <h2>ğŸ’° æ”¯æ‰•ã„è¨˜éŒ²</h2>
    <div class="currency-toggle" id="expenseCurrencyToggle">
      <button class="currency-btn active" onclick="setCurrency('JPY')">å††</button>
      <button class="currency-btn" onclick="setCurrency('USD')">ãƒ‰ãƒ«</button>
    </div>
    <div class="input-group">
      <label>é …ç›®å</label>
      <input type="text" id="expenseName" placeholder="ä¾‹: ãƒ©ãƒ³ãƒä»£" maxlength="100">
    </div>
    <div class="input-group">
      <label>é‡‘é¡</label>
      <input type="number" id="expenseAmount" placeholder="0" min="0" max="10000000" step="0.01">
    </div>
    <div class="input-group">
      <label>æ”¯æ‰•ã£ãŸäºº</label>
      <select id="paidBy"><option value="">é¸æŠ</option><option value="0">ãƒ¡ãƒ³ãƒãƒ¼1</option></select>
    </div>
    <div class="input-group">
      <label>å‚åŠ è€…</label>
      <div class="checkbox-group" id="participantsCheckbox"><div class="checkbox-item"><input type="checkbox" id="participant0" value="0"><label for="participant0">ãƒ¡ãƒ³ãƒãƒ¼1</label></div></div>
    </div>
    <button class="btn btn-primary" onclick="addExpense()">è¿½åŠ </button>
  </div>

  <div class="card">
    <h2>ğŸ“ æ”¯æ‰•ã„ä¸€è¦§</h2>
    <div class="expense-list" id="expenseList"><div class="empty-state"><p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>
  </div>

  <div class="card">
    <h2>ğŸ’³ ç²¾ç®—ï¼ˆæ”¯å‡ºã®ã¿ï¼‰</h2>
    <div class="info-text" style="margin-top:10px;">
      <b>ç²¾ç®—ã®è¡¨ç¤º</b>ï¼š
      <label style="margin-left:10px;cursor:pointer;"><input type="radio" name="settMode" value="direct" onchange="setSettlementMode('direct')" style="margin-right:6px;">ç«‹æ›¿è€…ã¸ç›´æ¥ï¼ˆãŠã™ã™ã‚ï¼‰</label>
      <label style="margin-left:10px;cursor:pointer;"><input type="radio" name="settMode" value="min" onchange="setSettlementMode('min')" style="margin-right:6px;">æœ€å°ç²¾ç®—ï¼ˆé€é‡‘å›æ•°ã‚’åœ§ç¸®ï¼‰</label>
      <div class="small" style="margin-top:6px;">ã€Œç›´æ¥ã€ã¯ã€<span class="pill">å‚åŠ è€…â†’æ”¯æ‰•è€…</span> ã‚’ãã®ã¾ã¾å‡ºã—ã¾ã™ï¼ˆMIYUãŒæ¬²ã—ã„ã‚„ã¤ï¼‰ã€‚ã€Œæœ€å°ç²¾ç®—ã€ã¯çµŒè·¯ãŒå¤‰ã‚ã‚‹ã®ã§ã€è¦‹ãŸç›®ãŒç›´æ„Ÿã¨ã‚ºãƒ¬ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</div>
    </div>
    <div id="depositRefundSummary"></div>
    <div class="summary-grid" id="summaryGrid">
      <div class="summary-card">
        <div class="summary-label">ãƒ¡ãƒ³ãƒãƒ¼1</div>
        <div class="summary-value">Â¥0 / $0.00<span class="estimate">(â‰ˆÂ¥0)</span></div>
      </div>
    </div>
    <div id="settlementList" class="settlement-list"><h3 style="margin-top:20px;margin-bottom:15px;color:#333;">ç²¾ç®—æ–¹æ³•ï¼ˆæ”¯å‡ºï¼‰ â€” ç«‹æ›¿è€…ã¸ç›´æ¥</h3><div class="small" style="margin-bottom:8px;color:#666;">â€»é ã‹ã‚Šé‡‘ã¯ã“ã®ã€Œæ”¯å‡ºã®ç²¾ç®—ã€ã«ã¯å«ã‚ãšã€ä¸Šã®ã€Œé ã‹ã‚Šé‡‘ã®è¿”é‡‘ï¼ˆå›ºå®šï¼‰ã€ã«å‡ºã—ã¾ã™ã€‚</div><div style="font-weight:700;margin:10px 0 6px;">å††</div><div class="small" style="text-align:center;color:#999;padding:8px;">ãªã—</div><div style="font-weight:700;margin:14px 0 6px;">ãƒ‰ãƒ«</div><div class="small" style="text-align:center;color:#999;padding:8px;">ãªã—</div></div>
  </div>

  <div class="card">
    <h2>ğŸ‘¤ å€‹äººåˆ¥ã¾ã¨ã‚</h2>
    <div class="info-text">ã€Œæ”¯å‡ºã®ç²¾ç®—ã€ï¼‹ã€Œé ã‹ã‚Šé‡‘ã®è¿”é‡‘ã€ã‚’åˆç®—ã—ã¦ã€å„äººã®å—å–/æ”¯æ‰•/ãƒãƒƒãƒˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ã‚»ãƒ¬ã‚¯ãƒˆã§1äººã‚’é¸ã¶ã¨æ˜ç´°ã«çµã‚Œã¾ã™ã€‚</div>
    <div class="input-group">
      <label>å¯¾è±¡ãƒ¡ãƒ³ãƒãƒ¼</label>
      <select id="focusMember" onchange="renderPersonalViews()"><option value="">å…¨å“¡</option><option value="0">ãƒ¡ãƒ³ãƒãƒ¼1</option></select>
    </div>
    <div id="personalSummary"><div class="settlement-item">
      <div class="settlement-text">
        <b>ãƒ¡ãƒ³ãƒãƒ¼1</b>
        <div class="small">å—å– / æ”¯æ‰• / ãƒãƒƒãƒˆï¼ˆé ã‹ã‚Šé‡‘è¾¼ã¿ï¼‰</div>
      </div>
      <div style="text-align:right">
        <div><span class="pill">å††</span> å—å– Â¥0 / æ”¯æ‰• Â¥0 / <b>+Â¥0</b></div>
        <div style="margin-top:4px"><span class="pill">ãƒ‰ãƒ«</span> å—å– $0.00<span class="estimate">(â‰ˆÂ¥0)</span> / æ”¯æ‰• $0.00<span class="estimate">(â‰ˆÂ¥0)</span> / <b>+$0.00<span class="estimate">(â‰ˆÂ¥0)</span></b></div>
      </div>
    </div></div>
    <div class="hr"></div>
    <div id="personalDetails"><p style="text-align:center;color:#999;padding:10px;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸ã¶ã¨ã€ãã®äººã®ã€Œèª°â†’èª°ã€æ˜ç´°ã ã‘è¡¨ç¤ºã—ã¾ã™</p></div>
  </div>
</div>

<div id="toast" class="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

<script>
const MAX_MEMBERS=10;
const MAX_EXPENSES=100;
const MAX_DEPOSITS=100;
const MAX_FILE_SIZE=1024*1024;
const MAX_STRING_LEN=200;

let members=[];
let expenses=[];
let deposits=[];

let currentCurrency='JPY';
let currentDepositCurrency='JPY';
let exchangeRate=150;
let settlementMode='direct';

const sanitize = s => String(s ?? '').substring(0, MAX_STRING_LEN);
const esc = s => String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const safe = s => esc(sanitize(s));

const validateNum=(n,min=0,max=10000000)=>{
  const v=parseFloat(n);
  return !isNaN(v)&&v>=min&&v<=max?v:null
};

const fmtJPY = (n)=>`Â¥${Math.round(Number(n||0)).toLocaleString()}`;
const fmtUSD = (n)=>{
  const num = Number(n||0);
  const usd = `$${num.toFixed(2)}`;
  if(!exchangeRate || !isFinite(exchangeRate) || exchangeRate<=0) return usd;
  const yen = Math.round(num*exchangeRate);
  const yenStr = (yen>=0?`Â¥${yen.toLocaleString()}`:`-Â¥${Math.abs(yen).toLocaleString()}`);
  return `${usd}<span class="estimate">(â‰ˆ${yenStr})</span>`;
};

function clampInt(n, min, max){
  const v = Number.isFinite(n) ? Math.trunc(n) : parseInt(n,10);
  if(!Number.isFinite(v)) return null;
  if(v < min || v > max) return null;
  return v;
}

function showToast(msg='ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  clearTimeout(window.__toastTimer);
  window.__toastTimer=setTimeout(()=>t.classList.remove('show'), 1200);
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  }catch(e){
    try{
      const ta=document.createElement('textarea');
      ta.value=text;
      ta.style.position='fixed';
      ta.style.left='-9999px';
      ta.style.top='0';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    }catch(err){
      alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ã®å¯èƒ½æ€§ï¼‰');
      console.error(err);
    }
  }
}

function normalizeData(input){
  const out = { members:[''], expenses:[], deposits:[], exchangeRate: exchangeRate };
  if(!input || typeof input !== 'object') return out;

  if(Array.isArray(input.members)){
    const m = input.members.slice(0, MAX_MEMBERS).map(x => sanitize(x));
    out.members = (m.length ? m : ['']);
  }
  const mLen = out.members.length;

  if(Array.isArray(input.expenses)){
    out.expenses = input.expenses
      .slice(0, MAX_EXPENSES)
      .filter(e => e && typeof e === 'object')
      .map(e => {
        const name = sanitize(e.name).trim();
        const amount = validateNum(e.amount);
        const currency = (e.currency === 'USD') ? 'USD' : 'JPY';
        const paidBy = clampInt(e.paidBy, 0, mLen-1);
        const participants = Array.isArray(e.participants)
          ? [...new Set(e.participants.map(p => clampInt(p, 0, mLen-1)).filter(p => p !== null))]
          : [];
        if(!name || !amount || paidBy === null || participants.length === 0) return null;
        return { name, amount, currency, paidBy, participants, timestamp: e.timestamp || new Date().toISOString() };
      })
      .filter(Boolean);
  }

  if(Array.isArray(input.deposits)){
    out.deposits = input.deposits
      .slice(0, MAX_DEPOSITS)
      .filter(d => d && typeof d === 'object')
      .map(d => {
        const holder = clampInt(d.holder, 0, mLen-1);
        const from = clampInt(d.from, 0, mLen-1);
        const amount = validateNum(d.amount);
        const currency = (d.currency === 'USD') ? 'USD' : 'JPY';
        if(holder === null || from === null || holder === from || !amount) return null;
        return { holder, from, amount, currency, timestamp: d.timestamp || new Date().toISOString() };
      })
      .filter(Boolean);
  }

  const r = validateNum(input.exchangeRate, 1, 1000);
  if(r) out.exchangeRate = r;

  return out;
}

window.onload=()=>{
  loadData();
  if(!members.length) members=[''];
  updateMemberSelects();
  updateMemberDisplay();
  updateFocusMemberSelect();
  showRateDisplay();
  // ãƒ©ã‚¸ã‚ªåæ˜ 
  document.querySelectorAll('input[name="settMode"]').forEach(r=>{ r.checked = (r.value===settlementMode); });
  updateDisplay();
};

function toggleMemberEdit(){
  const edit=document.getElementById('memberEdit');
  const display=document.getElementById('memberDisplay');
  const btn=document.getElementById('toggleMemberBtn');
  if(edit.style.display==='none'){
    edit.style.display='block';
    display.style.display='none';
    btn.textContent='ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
  }else{
    edit.style.display='none';
    display.style.display='block';
    btn.textContent='ç·¨é›†';
    updateMemberDisplay();
  }
}
function saveMemberEdit(){
  document.getElementById('memberEdit').style.display='none';
  document.getElementById('memberDisplay').style.display='block';
  document.getElementById('toggleMemberBtn').textContent='ç·¨é›†';
  updateMemberDisplay();
  updateFocusMemberSelect();
  saveData();
  updateDisplay();
}

function updateMemberDisplay(){
  const d=document.getElementById('memberDisplay');
  if(members.every(m=>!m)){
    d.innerHTML='<p style="color:#999;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>';
    return;
  }
  d.innerHTML='';
  members.forEach((m,i)=>{
    if(m){
      const span=document.createElement('span');
      span.style.cssText='display:inline-block;background:#e2e8f0;padding:8px 16px;margin:5px;border-radius:8px;font-size:15px;';
      span.textContent=m;
      d.appendChild(span);
    }
  });
}

function showRateDisplay(){
  const rt=document.getElementById('rateText');
  rt.textContent='';
  const span=document.createElement('span');
  span.textContent = `ğŸ’± ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ: $1 = Â¥${exchangeRate.toFixed(2)} `;
  const btn=document.createElement('button');
  btn.textContent='å¤‰æ›´';
  btn.style.cssText='margin-left:10px;padding:4px 8px;background:#667eea;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;';
  btn.onclick=setManualRate;
  span.appendChild(btn);
  rt.appendChild(span);
}


function setSettlementMode(mode){
  settlementMode = (mode==='min') ? 'min' : 'direct';
  try{ localStorage.setItem('settlementMode', settlementMode); }catch(e){}
  // ãƒ©ã‚¸ã‚ªåæ˜ 
  document.querySelectorAll('input[name="settMode"]').forEach(r=>{ r.checked = (r.value===settlementMode); });
  updateDisplay();
}

function setManualRate(){
  const r=prompt('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 150ï¼‰', String(exchangeRate));
  const v=validateNum(r, 1, 1000);
  if(v){
    exchangeRate=v;
    saveData();
    showRateDisplay();
    updateDisplay();
    alert('ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  }
}

function addMember(){
  if(members.length>=MAX_MEMBERS){alert(`æœ€å¤§${MAX_MEMBERS}äººã¾ã§`);return}
  members.push('');
  updateMemberList();
  updateMemberSelects();
  updateFocusMemberSelect();
  saveData();
}
function removeMember(i){
  if(members.length<=1){alert('æœ€ä½1äººå¿…è¦');return}
  if(!confirm('å‰Šé™¤ã™ã‚‹ã¨æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆæ”¯å‡º/é ã‹ã‚Šé‡‘ï¼‰ã‚‚å½±éŸ¿ã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;

  // å…ˆã«é…åˆ—ã‹ã‚‰å‰Šé™¤ï¼ˆæ–°ã—ã„members.lengthã‚’åŸºæº–ã«æ•´åˆã‚’å–ã‚‹ï¼‰
  members.splice(i,1);

  // æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è©°ã‚ç›´ã™
  expenses = (expenses||[]).map(e=>{
    if(!e || typeof e!=='object') return null;
    let paidBy = Number(e.paidBy);
    if(Number.isNaN(paidBy)) paidBy = 0;
    if(paidBy === i) paidBy = 0;
    else if(paidBy > i) paidBy -= 1;

    let participants = Array.isArray(e.participants) ? e.participants.slice() : [];
    participants = participants
      .map(p=>Number(p))
      .filter(p=>!Number.isNaN(p))
      .filter(p=>p !== i)
      .map(p=> (p > i) ? (p-1) : p);

    participants = [...new Set(participants)].filter(p=>p>=0 && p<members.length);

    // å‚åŠ è€…ãŒç©ºã«ãªã£ãŸã‚‰ã€æ”¯æ‰•è€…ã‚’å‚åŠ è€…ã«å…¥ã‚Œã¦ä¿å…¨ï¼ˆãã‚Œã‚‚ç„¡ç†ãªã‚‰æ¨ã¦ã‚‹ï¼‰
    if(participants.length===0){
      if(paidBy>=0 && paidBy<members.length) participants=[paidBy];
      else return null;
    }
    paidBy = clampInt(paidBy, 0, members.length-1) ?? 0;

    return { ...e, paidBy, participants };
  }).filter(Boolean);

  // é ã‹ã‚Šé‡‘ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è©°ã‚ç›´ã™ï¼ˆå‰Šé™¤ã•ã‚ŒãŸäººãŒçµ¡ã‚€ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯é™¤å¤–ï¼‰
  deposits = (deposits||[]).map(d=>{
    if(!d || typeof d!=='object') return null;
    let holder = Number(d.holder);
    let from = Number(d.from);
    if(Number.isNaN(holder) || Number.isNaN(from)) return null;
    if(holder === i || from === i) return null;
    if(holder > i) holder -= 1;
    if(from > i) from -= 1;
    holder = clampInt(holder, 0, members.length-1);
    from = clampInt(from, 0, members.length-1);
    if(holder===null || from===null || holder===from) return null;
    return { ...d, holder, from };
  }).filter(Boolean);

  updateMemberList();
  updateMemberSelects();
  updateFocusMemberSelect();
  saveData();
  updateDisplay();
}
function updateMemberName(i,v){
  members[i]=sanitize(v);
  updateMemberSelects();
  updateFocusMemberSelect();
  saveData();
  updateDisplay();
}
function updateMemberList(){
  const d=document.getElementById('memberList');
  d.innerHTML='';
  members.forEach((m,i)=>{
    const div=document.createElement('div');
    div.className='member-item';

    const inp=document.createElement('input');
    inp.type='text';
    inp.value=m;
    inp.placeholder=`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`;
    inp.maxLength=50;
    inp.onchange=e=>updateMemberName(i,e.target.value);
    div.appendChild(inp);

    if(members.length>1){
      const btn=document.createElement('button');
      btn.textContent='å‰Šé™¤';
      btn.onclick=()=>removeMember(i);
      div.appendChild(btn);
    }
    d.appendChild(div);
  });
}
function updateMemberSelects(){
  const opts=[{v:'',t:'é¸æŠ'},...members.map((m,i)=>({v:i,t:m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`}))];

  ['paidBy','depositHolder','depositFrom'].forEach(id=>{
    const s=document.getElementById(id);
    s.innerHTML='';
    opts.forEach(o=>{
      const opt=document.createElement('option');
      opt.value=o.v;
      opt.textContent=sanitize(o.t);
      s.appendChild(opt);
    });
  });

  const pc=document.getElementById('participantsCheckbox');
  pc.innerHTML='';
  members.forEach((m,i)=>{
    const div=document.createElement('div');
    div.className='checkbox-item';
    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.id=`participant${i}`;
    cb.value=i;
    cb.checked=true;
    const lbl=document.createElement('label');
    lbl.htmlFor=`participant${i}`;
    lbl.textContent=sanitize(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`);
    div.appendChild(cb);
    div.appendChild(lbl);
    pc.appendChild(div);
  });
}

function updateFocusMemberSelect(){
  const s=document.getElementById('focusMember');
  const cur=s.value;
  s.innerHTML='';
  const opt0=document.createElement('option');
  opt0.value='';
  opt0.textContent='å…¨å“¡';
  s.appendChild(opt0);

  members.forEach((m,i)=>{
    const opt=document.createElement('option');
    opt.value=String(i);
    opt.textContent=sanitize(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`);
    s.appendChild(opt);
  });

  if([...s.options].some(o=>o.value===cur)) s.value=cur;
}

function setCurrency(c){
  currentCurrency=c;
  document.querySelectorAll('#expenseCurrencyToggle .currency-btn').forEach((b,i)=>{
    b.classList.toggle('active',(c==='JPY'&&i===0)||(c==='USD'&&i===1));
  });
}
function setDepositCurrency(c){
  currentDepositCurrency=c;
  document.querySelectorAll('#depositCurrencyToggle .currency-btn').forEach((b,i)=>{
    b.classList.toggle('active',(c==='JPY'&&i===0)||(c==='USD'&&i===1));
  });
}

function addDeposit(){
  if(deposits.length>=MAX_DEPOSITS){alert(`æœ€å¤§${MAX_DEPOSITS}ä»¶ã¾ã§`);return}
  const h=parseInt(document.getElementById('depositHolder').value);
  const f=parseInt(document.getElementById('depositFrom').value);
  const a=validateNum(document.getElementById('depositAmount').value);
  if(isNaN(h)||isNaN(f)||!a){alert('å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');return}
  if(h===f){alert('åˆ¥ã®äººã‚’é¸æŠ');return}
  deposits.push({holder:h,from:f,amount:a,currency:currentDepositCurrency,timestamp:new Date().toISOString()});
  document.getElementById('depositHolder').value='';
  document.getElementById('depositFrom').value='';
  document.getElementById('depositAmount').value='';
  saveData();
  updateDisplay();
}
function deleteDeposit(i){
  deposits.splice(i,1);
  saveData();
  updateDisplay();
}
function displayDeposits(){
  const d=document.getElementById('depositsList');
  if(!deposits.length){d.innerHTML='';return}
  let html = '<h3 style="margin-bottom:10px;font-size:14px;font-weight:600;">ä¸€è¦§</h3>';
  deposits.forEach((dep,i)=>{
    const holderName = safe(members[dep.holder]||`ãƒ¡ãƒ³ãƒãƒ¼${dep.holder+1}`);
    const fromName = safe(members[dep.from]||`ãƒ¡ãƒ³ãƒãƒ¼${dep.from+1}`);
    const amt = dep.currency==='JPY' ? `Â¥${dep.amount.toLocaleString()}` : fmtUSD(dep.amount);
    html += `
      <div class="settlement-item">
        <span>${holderName}ãŒ${fromName}ã‹ã‚‰</span>
        <span style="display:flex;gap:10px;align-items:center;">
          <b style="color:#d97706;">${amt}</b>
          <button class="btn btn-danger" style="padding:8px 12px;font-size:12px;min-height:auto;" onclick="deleteDeposit(${i})">å‰Šé™¤</button>
        </span>
      </div>
    `;
  });
  d.innerHTML = html;
}

function addExpense(){
  if(expenses.length>=MAX_EXPENSES){alert(`æœ€å¤§${MAX_EXPENSES}ä»¶ã¾ã§`);return}
  const name=sanitize(document.getElementById('expenseName').value).trim();
  const amt=validateNum(document.getElementById('expenseAmount').value);
  const paidBy=parseInt(document.getElementById('paidBy').value);
  if(!name||!amt||isNaN(paidBy)){alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›');return}

  const parts=[];
  members.forEach((_,i)=>{
    const cb=document.getElementById(`participant${i}`);
    if(cb&&cb.checked) parts.push(i);
  });
  if(!parts.length){alert('å‚åŠ è€…ã‚’é¸æŠ');return}
  const uniqParts = [...new Set(parts)];

  expenses.push({name,amount:amt,currency:currentCurrency,paidBy,participants:uniqParts,timestamp:new Date().toISOString()});
  document.getElementById('expenseName').value='';
  document.getElementById('expenseAmount').value='';
  document.getElementById('paidBy').value='';
  members.forEach((_,i)=>{const cb=document.getElementById(`participant${i}`);if(cb)cb.checked=true});
  saveData();
  updateDisplay();
}
function deleteExpense(i){
  expenses.splice(i,1);
  saveData();
  updateDisplay();
}
function displayExpenses(){
  const l=document.getElementById('expenseList');
  if(!expenses.length){
    l.innerHTML='<div class="empty-state"><p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    return;
  }
  let html='';
  expenses.forEach((e,i)=>{
    const nm = safe(e.name);
    const paid = safe(members[e.paidBy]||`ãƒ¡ãƒ³ãƒãƒ¼${e.paidBy+1}`);
    const parts = e.participants.map(idx => safe(members[idx]||`ãƒ¡ãƒ³ãƒãƒ¼${idx+1}`)).join(', ');
    const amt = e.currency==='JPY' ? `Â¥${e.amount.toLocaleString()}` : fmtUSD(e.amount);
    html += `
      <div class="expense-item">
        <div class="expense-header">
          <div class="expense-title">${nm}</div>
          <div class="expense-amount">${amt}</div>
        </div>
        <div class="expense-details">æ”¯æ‰•: ${paid}</div>
        <div class="expense-details">å‚åŠ : ${parts}</div>
        <div class="expense-actions">
          <button class="btn btn-danger" onclick="deleteExpense(${i})">å‰Šé™¤</button>
        </div>
      </div>
    `;
  });
  l.innerHTML = html;
}

function calculateExpenseBalances(){
  const bj=Array(members.length).fill(0);
  const bu=Array(members.length).fill(0);
  expenses.forEach(e=>{
    const per=e.amount/e.participants.length;
    const b=e.currency==='JPY'?bj:bu;
    b[e.paidBy]+=e.amount;
    e.participants.forEach(idx=>b[idx]-=per);
  });
  return {bj,bu};
}

function calculateDepositRefunds(){
  const refundsJPY=[]; const refundsUSD=[];
  const payJ=Array(members.length).fill(0), recvJ=Array(members.length).fill(0);
  const payU=Array(members.length).fill(0), recvU=Array(members.length).fill(0);

  deposits.forEach(d=>{
    const item={from:d.holder,to:d.from,amount:d.amount};
    if(d.currency==='JPY'){
      refundsJPY.push(item);
      payJ[d.holder]+=d.amount;
      recvJ[d.from]+=d.amount;
    } else {
      refundsUSD.push(item);
      payU[d.holder]+=d.amount;
      recvU[d.from]+=d.amount;
    }
  });
  return {refundsJPY,refundsUSD,payJ,recvJ,payU,recvU};
}

function calculateSettlementTransactions(b){
  const t=[],c=[],d=[];
  b.forEach((bal,i)=>{
    if(bal>0.01) c.push({idx:i,amount:bal});
    else if(bal<-0.01) d.push({idx:i,amount:-bal});
  });
  let i=0,j=0;
  while(i<c.length&&j<d.length){
    const cr=c[i], db=d[j];
    const a=Math.min(cr.amount,db.amount);
    t.push({from:db.idx,to:cr.idx,amount:a});
    cr.amount-=a; db.amount-=a;
    if(cr.amount<0.01) i++;
    if(db.amount<0.01) j++;
  }
  return t;
}

function buildDirectMatrix(includeDeposits){
  const n = members.length;
  const jpy = Array.from({length:n}, ()=>Array(n).fill(0));
  const usd = Array.from({length:n}, ()=>Array(n).fill(0));

  // æ”¯å‡ºï¼šå‚åŠ è€…â†’æ”¯æ‰•è€…
  expenses.forEach(e=>{
    const per = e.amount / e.participants.length;
    const mat = (e.currency==='USD') ? usd : jpy;
    e.participants.forEach(idx=>{
      if(idx===e.paidBy) return;
      mat[idx][e.paidBy] += per;
    });
  });

  if(includeDeposits){
    // é ã‹ã‚Šé‡‘ï¼šé ã‹ã£ãŸäººâ†’é ã‘ãŸäººï¼ˆè¿”é‡‘ï¼‰
    deposits.forEach(d=>{
      const mat = (d.currency==='USD') ? usd : jpy;
      if(d.holder===d.from) return;
      mat[d.holder][d.from] += d.amount;
    });
  }
  return {jpy, usd};
}

function netMatrix(mat){
  const n = mat.length;
  const tx = [];
  for(let i=0;i<n;i++){
    for(let j=i+1;j<n;j++){
      const a = mat[i][j] || 0;
      const b = mat[j][i] || 0;
      const diff = a - b;
      if(Math.abs(diff) < 0.01) continue;
      if(diff > 0) tx.push({from:i,to:j,amount:diff});
      else tx.push({from:j,to:i,amount:-diff});
    }
  }
  return tx;
}

function txToPayRecv(tx){
  const n = members.length;
  const pay = Array(n).fill(0);
  const recv = Array(n).fill(0);
  tx.forEach(t=>{
    pay[t.from] += t.amount;
    recv[t.to] += t.amount;
  });
  return {pay, recv};
}


function displayDepositRefundSummary(refunds){
  const box=document.getElementById('depositRefundSummary');
  if(!deposits.length){box.innerHTML='';return}
  let html='<div class="deposit-section"><h3 style="margin-bottom:10px;color:#92400e;font-size:15px;">ğŸ’µ é ã‹ã‚Šé‡‘ã®è¿”é‡‘ï¼ˆå›ºå®šï¼‰</h3>';
  refunds.refundsJPY.forEach(x=>{
    html+=`<div class="settlement-item" style="background:transparent;padding:10px 0;">
      <span class="deposit-label">${safe(members[x.from])} â†’ ${safe(members[x.to])}</span>
      <span class="deposit-value">Â¥${x.amount.toLocaleString()}</span>
    </div>`;
  });
  refunds.refundsUSD.forEach(x=>{
    html+=`<div class="settlement-item" style="background:transparent;padding:10px 0;">
      <span class="deposit-label">${safe(members[x.from])} â†’ ${safe(members[x.to])}</span>
      <span class="deposit-value">${fmtUSD(x.amount)}</span>
    </div>`;
  });
  html+='</div>';
  box.innerHTML=html;
}

function calculateSettlement(){
  const {bj,bu}=calculateExpenseBalances();
  const refunds=calculateDepositRefunds();
  displayDepositRefundSummary(refunds);

  // ã‚µãƒãƒªãƒ¼ï¼ˆæ”¯å‡ºã®ã¿ã®åæ”¯ãƒãƒ©ãƒ³ã‚¹ï¼‰
  const sg=document.getElementById('summaryGrid');
  let sgHtml='';
  members.forEach((m,i)=>{
    sgHtml += `
      <div class="summary-card">
        <div class="summary-label">${safe(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`)}</div>
        <div class="summary-value">Â¥${Math.round(bj[i]).toLocaleString()} / ${fmtUSD(bu[i])}</div>
      </div>
    `;
  });
  sg.innerHTML = sgHtml;

  // ç²¾ç®—ãƒªã‚¹ãƒˆï¼ˆæ”¯å‡ºã®ã¿ï¼‰
  let settlementsJPY=[], settlementsUSD=[];
  if(settlementMode==='direct'){
    const mat = buildDirectMatrix(false);
    settlementsJPY = netMatrix(mat.jpy);
    settlementsUSD = netMatrix(mat.usd);
  }else{
    settlementsJPY = calculateSettlementTransactions(bj);
    settlementsUSD = calculateSettlementTransactions(bu);
  }

  const sl=document.getElementById('settlementList');
  let slHtml = `<h3 style="margin-top:20px;margin-bottom:15px;color:#333;">ç²¾ç®—æ–¹æ³•ï¼ˆæ”¯å‡ºï¼‰ â€” ${settlementMode==='direct'?'ç«‹æ›¿è€…ã¸ç›´æ¥':'æœ€å°ç²¾ç®—'}</h3>`;
  const renderTx=(tx,isJPY)=>{
    tx.forEach(s=>{
      slHtml += `<div class="settlement-item">
        <div class="settlement-text">${safe(members[s.from])} â†’ ${safe(members[s.to])}</div>
        <div class="settlement-amount">${isJPY?`Â¥${Math.round(s.amount).toLocaleString()}`:fmtUSD(s.amount)}</div>
      </div>`;
    });
    if(!tx.length){
      slHtml += `<div class="small" style="text-align:center;color:#999;padding:8px;">ãªã—</div>`;
    }
  };
  slHtml += `<div class="small" style="margin-bottom:8px;color:#666;">â€»é ã‹ã‚Šé‡‘ã¯ã“ã®ã€Œæ”¯å‡ºã®ç²¾ç®—ã€ã«ã¯å«ã‚ãšã€ä¸Šã®ã€Œé ã‹ã‚Šé‡‘ã®è¿”é‡‘ï¼ˆå›ºå®šï¼‰ã€ã«å‡ºã—ã¾ã™ã€‚</div>`;
  slHtml += `<div style="font-weight:700;margin:10px 0 6px;">å††</div>`;
  renderTx(settlementsJPY,true);
  slHtml += `<div style="font-weight:700;margin:14px 0 6px;">ãƒ‰ãƒ«</div>`;
  renderTx(settlementsUSD,false);
  sl.innerHTML = slHtml;

  window.__lastExpenseBalances={bj,bu};
  window.__lastExpenseSettlements={settlementsJPY,settlementsUSD,mode:settlementMode};
  window.__lastDepositRefunds=refunds;
}


function renderPersonalViews(){
  const wrap=document.getElementById('personalSummary');
  const details=document.getElementById('personalDetails');

  const refunds=window.__lastDepositRefunds||calculateDepositRefunds();

  // ç›´æ¥ç²¾ç®—ï¼ˆæ”¯å‡ºã®ã¿ / é ã‹ã‚Šé‡‘è¾¼ã¿ï¼‰
  const matExp = buildDirectMatrix(false);
  const matFinal = buildDirectMatrix(true);
  const expTxJPY = netMatrix(matExp.jpy);
  const expTxUSD = netMatrix(matExp.usd);
  const finalTxJPY = netMatrix(matFinal.jpy);
  const finalTxUSD = netMatrix(matFinal.usd);

  const expPRJ = txToPayRecv(expTxJPY);
  const expPRU = txToPayRecv(expTxUSD);
  const finPRJ = txToPayRecv(finalTxJPY);
  const finPRU = txToPayRecv(finalTxUSD);

  // å€‹äººåˆ¥ã¾ã¨ã‚ï¼ˆæœ€çµ‚ç²¾ç®—ãƒ™ãƒ¼ã‚¹ï¼‰
  wrap.innerHTML='';
  members.forEach((m,i)=>{
    const payJ = finPRJ.pay[i], recvJ = finPRJ.recv[i], netJ = recvJ - payJ;
    const payU = finPRU.pay[i], recvU = finPRU.recv[i], netU = recvU - payU;

    const div=document.createElement('div');
    div.className='settlement-item';
    div.innerHTML = `
      <div class="settlement-text">
        <b>${safe(m||`ãƒ¡ãƒ³ãƒãƒ¼${i+1}`)}</b>
        <div class="small">å—å– / æ”¯æ‰• / ãƒãƒƒãƒˆï¼ˆé ã‹ã‚Šé‡‘è¾¼ã¿ï¼‰</div>
      </div>
      <div style="text-align:right">
        <div><span class="pill">å††</span> å—å– Â¥${Math.round(recvJ).toLocaleString()} / æ”¯æ‰• Â¥${Math.round(payJ).toLocaleString()} / <b>${netJ>=0?'+':'-'}Â¥${Math.round(Math.abs(netJ)).toLocaleString()}</b></div>
        <div style="margin-top:4px"><span class="pill">ãƒ‰ãƒ«</span> å—å– ${fmtUSD(recvU)} / æ”¯æ‰• ${fmtUSD(payU)} / <b>${netU>=0?'+':'-'}${fmtUSD(Math.abs(netU))}</b></div>
      </div>
    `;
    wrap.appendChild(div);
  });

  const focus=document.getElementById('focusMember').value;
  if(focus===''){
    details.innerHTML='<p style="text-align:center;color:#999;padding:10px;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸ã¶ã¨ã€ãã®äººã®ã€Œèª°â†’èª°ã€æ˜ç´°ã ã‘è¡¨ç¤ºã—ã¾ã™</p>';
    return;
  }
  const k=parseInt(focus);

  const filterTx = (tx)=>tx.filter(x=>x.from===k||x.to===k);

  const renderSection = (title, tx, isJPY, badge)=>{
    let h = `<div style="margin-top:14px;margin-bottom:8px;font-weight:800;">${badge} ${title}</div>`;
    if(!tx.length) return h + `<div class="small" style="text-align:center;color:#999;padding:8px;">ãªã—</div>`;
    tx.forEach(x=>{
      h += `<div class="settlement-item">
        <div class="settlement-text">${safe(members[x.from])} â†’ ${safe(members[x.to])}</div>
        <div class="settlement-amount">${isJPY?`Â¥${Math.round(x.amount).toLocaleString()}`:`${fmtUSD(x.amount)}`}</div>
      </div>`;
    });
    return h;
  };

  details.innerHTML =
    `<h3 style="margin-bottom:10px;color:#333;">ğŸ” ${safe(members[k])} ã®æ˜ç´°</h3>` +
    renderSection('æœ€çµ‚ç²¾ç®—ï¼ˆé ã‹ã‚Šé‡‘è¾¼ã¿ãƒ»ç›¸æ®ºæ¸ˆã¿ï¼‰ã€å††ã€‘', filterTx(finalTxJPY), true, 'âœ…') +
    renderSection('æœ€çµ‚ç²¾ç®—ï¼ˆé ã‹ã‚Šé‡‘è¾¼ã¿ãƒ»ç›¸æ®ºæ¸ˆã¿ï¼‰ã€ãƒ‰ãƒ«ã€‘', filterTx(finalTxUSD), false, 'âœ…') +
    '<div class="hr"></div>' +
    renderSection('æ”¯å‡ºã®ç²¾ç®—ï¼ˆç«‹æ›¿è€…ã¸ç›´æ¥ï¼‰ã€å††ã€‘', filterTx(expTxJPY), true, 'ğŸ§¾') +
    renderSection('æ”¯å‡ºã®ç²¾ç®—ï¼ˆç«‹æ›¿è€…ã¸ç›´æ¥ï¼‰ã€ãƒ‰ãƒ«ã€‘', filterTx(expTxUSD), false, 'ğŸ§¾') +
    '<div class="hr"></div>' +
    renderSection('é ã‹ã‚Šé‡‘ï¼ˆå›ºå®šè¿”é‡‘ï¼‰ã€å††ã€‘', filterTx(refunds.refundsJPY), true, 'ğŸ’µ') +
    renderSection('é ã‹ã‚Šé‡‘ï¼ˆå›ºå®šè¿”é‡‘ï¼‰ã€ãƒ‰ãƒ«ã€‘', filterTx(refunds.refundsUSD), false, 'ğŸ’µ');
}


function updateDisplay(){
  // ãƒ©ã‚¸ã‚ªåæ˜ 
  document.querySelectorAll('input[name="settMode"]').forEach(r=>{ r.checked = (r.value===settlementMode); });
  updateMemberList();
  displayDeposits();
  displayExpenses();
  calculateSettlement();
  renderPersonalViews();
}

function exportData(){
  const d={members,expenses,deposits,exchangeRate,exportDate:new Date().toISOString()};
  const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const u=URL.createObjectURL(b);
  const a=document.createElement('a');
  a.href=u;
  a.download='warikan_'+new Date().toISOString().split('T')[0]+'.json';
  a.click();
  URL.revokeObjectURL(u);
}

function importData(e){
  const f=e.target.files[0];
  if(!f) return;
  if(f.size>MAX_FILE_SIZE){ alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™'); e.target.value=''; return; }

  const r=new FileReader();
  r.onload=ev=>{
    try{
      const raw=JSON.parse(ev.target.result);
      const nd = normalizeData(raw);
      members = nd.members;
      expenses = nd.expenses;
      deposits = nd.deposits;
      exchangeRate = nd.exchangeRate;

      saveData();
      updateMemberSelects();
      updateMemberDisplay();
      updateFocusMemberSelect();
      showRateDisplay();
      updateDisplay();
      alert('èª­ã¿è¾¼ã¿å®Œäº†');
    }catch(err){
      alert('èª­ã¿è¾¼ã¿å¤±æ•—');
      console.error(err);
    }
  };
  r.readAsText(f);
  e.target.value='';
}

function saveData(){
  localStorage.setItem('warikanMembers',JSON.stringify(members));
  localStorage.setItem('warikanExpenses',JSON.stringify(expenses));
  localStorage.setItem('warikanDeposits',JSON.stringify(deposits));
  localStorage.setItem('exchangeRate',String(exchangeRate));
}

function loadData(){
  try{
    const sm=localStorage.getItem('warikanMembers');
    const se=localStorage.getItem('warikanExpenses');
    const sd=localStorage.getItem('warikanDeposits');
    const sr=localStorage.getItem('exchangeRate');

    const raw = {
      members: sm ? JSON.parse(sm) : undefined,
      expenses: se ? JSON.parse(se) : undefined,
      deposits: sd ? JSON.parse(sd) : undefined,
      exchangeRate: sr ? Number(sr) : undefined
    };
    const nd = normalizeData(raw);

    members = nd.members;
    expenses = nd.expenses;
    deposits = nd.deposits;
    exchangeRate = nd.exchangeRate;
  }catch(e){
    console.error(e);
  }
}
</script>


</body></html>