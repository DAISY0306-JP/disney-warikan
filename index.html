<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .header {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        text-align: center;
    }

    .header h1 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
    }

    .header p {
        color: #666;
        font-size: 14px;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .action-buttons button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-export {
        background: #48bb78;
        color: white;
    }

    .btn-import {
        background: #3182ce;
        color: white;
    }

    .btn-settlement {
        background: #ed8936;
        color: white;
    }

    .btn-screenshot {
        background: #9f7aea;
        color: white;
    }

    .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
        }
    }

    .card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
        color: #333;
        font-size: 20px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
    }

    .input-group {
        margin-bottom: 15px;
    }

    .input-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-size: 14px;
        font-weight: 500;
    }

    .input-group input,
    .input-group select,
    .input-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .input-group input:focus,
    .input-group select:focus,
    .input-group textarea:focus {
        outline: none;
        border-color: #667eea;
    }

    .member-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
    }

    .member-item {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .member-item input {
        flex: 1;
    }

    .member-item button {
        padding: 8px 12px;
        background: #f56565;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
    }

    .checkbox-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .checkbox-item label {
        cursor: pointer;
        color: #555;
        font-size: 14px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #667eea;
        color: white;
        width: 100%;
    }

    .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
        background: #48bb78;
        color: white;
        margin-right: 10px;
    }

    .btn-secondary:hover {
        background: #38a169;
    }

    .btn-danger {
        background: #f56565;
        color: white;
    }

    .btn-danger:hover {
        background: #e53e3e;
    }

    .btn-add {
        background: #3182ce;
        color: white;
        padding: 8px 16px;
        font-size: 13px;
    }

    .expense-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .expense-item {
        background: #f7fafc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
    }

    .expense-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .expense-title {
        font-weight: 600;
        color: #333;
        font-size: 16px;
    }

    .expense-amount {
        font-weight: 700;
        color: #667eea;
        font-size: 18px;
    }

    .expense-details {
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
    }

    .expense-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .expense-actions button {
        padding: 6px 12px;
        font-size: 12px;
    }

    .category-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-right: 8px;
        background: #e2e8f0;
        color: #2d3748;
    }

    .settlement-list {
        margin-top: 20px;
    }

    .settlement-item {
        background: #f7fafc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .settlement-text {
        color: #333;
        font-size: 14px;
    }

    .settlement-amount {
        font-weight: 700;
        color: #f56565;
        font-size: 16px;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 20px;
    }

    .summary-card {
        background: #f7fafc;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }

    .summary-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
    }

    .summary-value {
        font-size: 20px;
        font-weight: 700;
        color: #667eea;
    }

    .currency-toggle {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        background: #f7fafc;
        padding: 5px;
        border-radius: 8px;
    }

    .currency-btn {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 6px;
        background: transparent;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .currency-btn.active {
        background: #667eea;
        color: white;
    }

    .receipt-preview {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        margin-top: 10px;
        cursor: pointer;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        max-width: 90%;
        max-height: 90%;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 15px;
        opacity: 0.3;
    }

    .category-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
    }

    .category-tag {
        background: #e2e8f0;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .category-tag button {
        background: none;
        border: none;
        color: #f56565;
        cursor: pointer;
        font-size: 16px;
        padding: 0;
        line-height: 1;
    }

    .settlement-modal {
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        width: 90%;
    }

    .close-modal {
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #999;
    }

    .close-modal:hover {
        color: #333;
    }

    @media print {
        body {
            background: white;
        }
        .header, .action-buttons, .close-modal {
            display: none;
        }
    }

    .deposit-section {
        background: #fffbeb;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px solid #fbbf24;
    }

    .deposit-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .deposit-label {
        font-weight: 600;
        color: #92400e;
    }

    .deposit-value {
        font-weight: 700;
        color: #d97706;
        font-size: 16px;
    }

    input[type="file"] {
        display: none;
    }

    .file-label {
        display: inline-block;
        padding: 10px 20px;
        background: #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        color: #2d3748;
    }

    .file-label:hover {
        background: #cbd5e0;
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</h1>
            <p>ã‚°ãƒ«ãƒ¼ãƒ—ã®æ”¯å‡ºã‚’ç°¡å˜ç®¡ç†</p>
            <div class="action-buttons">
                <button class="btn-export" onclick="exportData()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
                <label for="importFile" class="btn-import" style="padding: 10px 20px; display: inline-block; cursor: pointer; border-radius: 8px;">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿èª­è¾¼</label>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                <button class="btn-settlement" onclick="showSettlementModal()">ğŸ’³ ç²¾ç®—ç”»é¢</button>
                <button class="btn-screenshot" onclick="downloadSettlement()">ğŸ“¸ ç”»åƒä¿å­˜</button>
            </div>
        </div>

```
    <div class="main-content">
        <!-- ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š -->
        <div class="card">
            <h2>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š</h2>
            <div class="member-list" id="memberList"></div>
            <button class="btn btn-add" onclick="addMember()">+ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>
        </div>

        <!-- é ã‹ã‚Šé‡‘ -->
        <div class="card">
            <h2>ğŸ’µ é ã‹ã‚Šé‡‘</h2>
            <div class="input-group">
                <label>ãƒ¡ãƒ³ãƒãƒ¼</label>
                <select id="depositMember">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
            </div>
            <div class="input-group">
                <label>é‡‘é¡</label>
                <input type="number" id="depositAmount" placeholder="0" min="0">
            </div>
            <div class="currency-toggle">
                <button class="currency-btn active" onclick="setDepositCurrency('JPY')">å†† (JPY)</button>
                <button class="currency-btn" onclick="setDepositCurrency('USD')">ãƒ‰ãƒ« (USD)</button>
            </div>
            <button class="btn btn-primary" onclick="addDeposit()">é ã‹ã‚Šé‡‘ã‚’è¨˜éŒ²</button>
            
            <div id="depositsList" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- ã‚«ãƒ†ã‚´ãƒªç®¡ç† -->
    <div class="card" style="margin-bottom: 20px;">
        <h2>ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªç®¡ç†</h2>
        <div class="category-list" id="categoryList"></div>
        <div class="input-group">
            <input type="text" id="newCategory" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªå">
        </div>
        <button class="btn btn-add" onclick="addCategory()">+ ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button>
    </div>

    <!-- æ”¯æ‰•ã„è¿½åŠ  -->
    <div class="card" style="margin-bottom: 20px;">
        <h2>ğŸ’° æ”¯æ‰•ã„è¨˜éŒ²ã‚’è¿½åŠ </h2>
        
        <div class="currency-toggle">
            <button class="currency-btn active" onclick="setCurrency('JPY')">å†† (JPY)</button>
            <button class="currency-btn" onclick="setCurrency('USD')">ãƒ‰ãƒ« (USD)</button>
        </div>

        <div class="input-group">
            <label>é …ç›®å</label>
            <input type="text" id="expenseName" placeholder="ä¾‹: ãƒ©ãƒ³ãƒä»£">
        </div>

        <div class="input-group">
            <label>é‡‘é¡</label>
            <input type="number" id="expenseAmount" placeholder="0" min="0" step="0.01">
        </div>

        <div class="input-group">
            <label>ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="expenseCategory"></select>
        </div>

        <div class="input-group">
            <label>æ”¯æ‰•ã£ãŸäºº</label>
            <select id="paidBy">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
        </div>

        <div class="input-group">
            <label>å‚åŠ è€…ï¼ˆã“ã®æ”¯æ‰•ã„ã‚’å‰²ã‚Šå‹˜ã™ã‚‹äººï¼‰</label>
            <div class="checkbox-group" id="participantsCheckbox"></div>
        </div>

        <div class="input-group">
            <label>ãƒ¬ã‚·ãƒ¼ãƒˆå†™çœŸï¼ˆä»»æ„ï¼‰</label>
            <input type="file" id="receiptImage" accept="image/*">
        </div>

        <div class="input-group">
            <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="expenseMemo" rows="2" placeholder="è¿½åŠ ãƒ¡ãƒ¢"></textarea>
        </div>

        <button class="btn btn-primary" onclick="addExpense()">æ”¯æ‰•ã„ã‚’è¿½åŠ </button>
    </div>

    <!-- æ”¯æ‰•ã„ä¸€è¦§ -->
    <div class="card">
        <h2>ğŸ“ æ”¯æ‰•ã„ä¸€è¦§</h2>
        <div class="expense-list" id="expenseList">
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p>ã¾ã æ”¯æ‰•ã„è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </div>
    </div>

    <!-- ç²¾ç®— -->
    <div class="main-content" style="margin-top: 20px;">
        <div class="card">
            <h2>ğŸ’³ ç²¾ç®—æƒ…å ±</h2>
            <div id="depositSummary"></div>
            <div class="summary-grid" id="summaryGrid"></div>
            <div class="settlement-list" id="settlementList"></div>
        </div>

        <div class="card">
            <h2>ğŸ“Š çµ±è¨ˆ</h2>
            <div id="statistics"></div>
        </div>
    </div>
</div>

<!-- ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="imageModal" onclick="closeModal()">
    <img class="modal-content" id="modalImage">
</div>

<!-- ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="settlementModal" onclick="closeSettlementModal(event)">
    <div class="settlement-modal" id="settlementContent" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="closeSettlementModal()">&times;</span>
        <div id="settlementDisplay"></div>
    </div>
</div>

<script>
    let members = [];
    let expenses = [];
    let deposits = [];
    let categories = ['é£Ÿäº‹', 'ãƒã‚±ãƒƒãƒˆ', 'ãŠåœŸç”£', 'äº¤é€šè²»', 'ãã®ä»–'];
    let currentCurrency = 'JPY';
    let currentDepositCurrency = 'JPY';
    let editingIndex = -1;

    window.onload = function() {
        loadData();
        initializeMembers();
        updateDisplay();
    };

    function initializeMembers() {
        if (members.length === 0) {
            members = [''];
        }
        updateMemberList();
        updateMemberSelects();
        updateCategoryList();
        updateCategorySelect();
    }

    function addMember() {
        members.push('');
        updateMemberList();
        updateMemberSelects();
        saveData();
    }

    function removeMember(index) {
        if (members.length <= 1) {
            alert('æœ€ä½1äººã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå¿…è¦ã§ã™');
            return;
        }
        if (confirm('ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            members.splice(index, 1);
            updateMemberList();
            updateMemberSelects();
            saveData();
            updateDisplay();
        }
    }

    function updateMemberName(index, value) {
        members[index] = value;
        updateMemberSelects();
        saveData();
        updateDisplay();
    }

    function updateMemberList() {
        const listDiv = document.getElementById('memberList');
        listDiv.innerHTML = members.map((member, index) => `
            <div class="member-item">
                <input type="text" value="${member}" placeholder="ãƒ¡ãƒ³ãƒãƒ¼${index + 1}" 
                       onchange="updateMemberName(${index}, this.value)">
                ${members.length > 1 ? `<button onclick="removeMember(${index})">å‰Šé™¤</button>` : ''}
            </div>
        `).join('');
    }

    function updateMemberSelects() {
        const paidBySelect = document.getElementById('paidBy');
        const depositMemberSelect = document.getElementById('depositMember');
        const participantsDiv = document.getElementById('participantsCheckbox');
        
        const options = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' + 
            members.map((member, index) => 
                `<option value="${index}">${member || 'ãƒ¡ãƒ³ãƒãƒ¼' + (index + 1)}</option>`
            ).join('');
        
        paidBySelect.innerHTML = options;
        depositMemberSelect.innerHTML = options;
        
        participantsDiv.innerHTML = members.map((member, index) => `
            <div class="checkbox-item">
                <input type="checkbox" id="participant${index}" value="${index}" checked>
                <label for="participant${index}">${member || 'ãƒ¡ãƒ³ãƒãƒ¼' + (index + 1)}</label>
            </div>
        `).join('');
    }

    function addCategory() {
        const newCat = document.getElementById('newCategory').value.trim();
        if (!newCat) {
            alert('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        if (categories.includes(newCat)) {
            alert('ã“ã®ã‚«ãƒ†ã‚´ãƒªã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
            return;
        }
        categories.push(newCat);
        document.getElementById('newCategory').value = '';
        updateCategoryList();
        updateCategorySelect();
        saveData();
    }

    function removeCategory(cat) {
        if (confirm(`ã‚«ãƒ†ã‚´ãƒªã€Œ${cat}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            categories = categories.filter(c => c !== cat);
            updateCategoryList();
            updateCategorySelect();
            saveData();
        }
    }

    function updateCategoryList() {
        const listDiv = document.getElementById('categoryList');
        listDiv.innerHTML = categories.map(cat => `
            <div class="category-tag">
                ${cat}
                <button onclick="removeCategory('${cat}')">&times;</button>
            </div>
        `).join('');
    }

    function updateCategorySelect() {
        const select = document.getElementById('expenseCategory');
        select.innerHTML = categories.map(cat => 
            `<option value="${cat}">${cat}</option>`
        ).join('');
    }

    function setCurrency(currency) {
        currentCurrency = currency;
        document.querySelectorAll('.currency-toggle .currency-btn').forEach((btn, idx) => {
            btn.classList.remove('active');
            if ((currency === 'JPY' && idx === 0) || (currency === 'USD' && idx === 1)) {
                btn.classList.add('active');
            }
        });
    }

    function setDepositCurrency(currency) {
        currentDepositCurrency = currency;
        const buttons = document.querySelectorAll('.card:nth-child(2) .currency-toggle .currency-btn');
        buttons.forEach((btn, idx) => {
            btn.classList.remove('active');
            if ((currency === 'JPY' && idx === 0) || (currency === 'USD' && idx === 1)) {
                btn.classList.add('active');
            }
        });
    }

    function addDeposit() {
        const memberIdx = parseInt(document.getElementById('depositMember').value);
        const amount = parseFloat(document.getElementById('depositAmount').value);
        
        if (isNaN(memberIdx) || !amount || amount <= 0) {
            alert('ãƒ¡ãƒ³ãƒãƒ¼ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        deposits.push({
            member: memberIdx,
            amount: amount,
            currency: currentDepositCurrency,
            timestamp: new Date().toISOString()
        });

        document.getElementById('depositMember').value = '';
        document.getElementById('depositAmount').value = '';
        
        saveData();
        updateDisplay();
        displayDeposits();
    }

    function displayDeposits() {
        const div = document.getElementById('depositsList');
        if (deposits.length === 0) {
            div.innerHTML = '';
            return;
        }

        div.innerHTML = '<h3 style="margin-bottom: 10px; font-size: 14px;">é ã‹ã‚Šé‡‘ä¸€è¦§</h3>' +
            deposits.map((dep, idx) => {
                const memberName = members[dep.member] || 'ãƒ¡ãƒ³ãƒãƒ¼' + (dep.member + 1);
                const amountDisplay = dep.currency === 'JPY' 
                    ? `Â¥${dep.amount.toLocaleString()}` 
                    : `$${dep.amount.toFixed(2)}`;
                
                return `
                    <div class="settlement-item" style="margin-bottom: 8px;">
                        <span>${memberName}</span>
                        <span style="font-weight: 700; color: #d97706;">${amountDisplay}</span>
                    </div>
                `;
            }).join('');
    }

    async function addExpense() {
        const name = document.getElementById('expenseName').value.trim();
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        const category = document.getElementById('expenseCategory').value;
        const paidBy = parseInt(document.getElementById('paidBy').value);
        const memo = document.getElementById('expenseMemo').value.trim();
        const imageFile = document.getElementById('receiptImage').files[0];

        if (!name || !amount || amount <= 0 || isNaN(paidBy)) {
            alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        const participants = [];
        members.forEach((_, index) => {
            const checkbox = document.getElementById(`participant${index}`);
            if (checkbox && checkbox.checked) {
                participants.push(index);
            }
        });

        if (participants.length === 0) {
            alert('å°‘ãªãã¨ã‚‚1äººã®å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        let imageData = null;
        if (imageFile) {
            imageData = await readFileAsDataURL(imageFile);
        }

        const expense = {
            name,
            amount,
            currency: currentCurrency,
            category,
            paidBy,
            participants,
            memo,
            image: imageData,
            timestamp: new Date().toISOString()
        };

        if (editingIndex >= 0) {
            expenses[editingIndex] = expense;
            editingIndex = -1;
        } else {
            expenses.push(expense);
        }

        saveData();
        clearForm();
        updateDisplay();
    }

    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function clearForm() {
        document.getElementById('expenseName').value = '';
        document.getElementById('expenseAmount').value = '';
        document.getElementById('expenseCategory').value = categories[0];
        document.getElementById('paidBy').value = '';
        document.getElementById('expenseMemo').value = '';
        document.getElementById('receiptImage').value = '';
        
        members.forEach((_, index) => {
            const checkbox = document.getElementById(`participant${index}`);
            if (checkbox) checkbox.checked = true;
        });
    }

    function editExpense(index) {
        const expense = expenses[index];
        editingIndex = index;

        document.getElementById('expenseName').value = expense.name;
        document.getElementById('expenseAmount').value = expense.amount;
        document.getElementById('expenseCategory').value = expense.category;
        document.getElementById('paidBy').value = expense.paidBy;
        document.getElementById('expenseMemo').value = expense.memo || '';

        currentCurrency = expense.currency;
        setCurrency(expense.currency);

        members.forEach((_, idx) => {
            const checkbox = document.getElementById(`participant${idx}`);
            if (checkbox) {
                checkbox.checked = expense.participants.includes(idx);
            }
        });

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteExpense(index) {
        if (confirm('ã“ã®æ”¯æ‰•ã„è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            expenses.splice(index, 1);
            saveData();
            updateDisplay();
        }
    }

    function updateDisplay() {
        displayExpenses();
        calculateSettlement();
        displayStatistics();
        displayDeposits();
    }

    function displayExpenses() {
        const listDiv = document.getElementById('expenseList');
        
        if (expenses.length === 0) {
            listDiv.innerHTML = `
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>ã¾ã æ”¯æ‰•ã„è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            `;
            return;
        }

        listDiv.innerHTML = expenses.map((exp, index) => {
            const participantNames = exp.participants.map(idx => members[idx] || 'ãƒ¡ãƒ³ãƒãƒ¼' + (idx + 1)).join(', ');
            const amountDisplay = exp.currency === 'JPY' 
                ? `Â¥${exp.amount.toLocaleString()}` 
                : `$${exp.amount.toFixed(2)}`;
            const paidByName = members[exp.paidBy] || 'ãƒ¡ãƒ³ãƒãƒ¼' + (exp.paidBy + 1);

            return `
                <div class="expense-item">
                    <div class="expense-header">
                        <div class="expense-title">${exp.name}</div>
                        <div class="expense-amount">${amountDisplay}</div>
                    </div>
                    <div class="expense-details">
                        <span class="category-badge">${exp.category}</span>
                        æ”¯æ‰•ã„: ${paidByName}
                    </div>
                    <div class="expense-details">
                        å‚åŠ è€…: ${participantNames}
                    </div>
                    ${exp.memo ? `<div class="expense-details">ãƒ¡ãƒ¢: ${exp.memo}</div>` : ''}
                    ${exp.image ? `<img src="${exp.image}" class="receipt-preview" onclick="showImage('${exp.image}')">` : ''}
                    <div class="expense-actions">
                        <button class="btn btn-secondary" onclick="editExpense(${index})">ç·¨é›†</button>
                        <button class="btn btn-danger" onclick="deleteExpense(${index})">å‰Šé™¤</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function showImage(src) {
        document.getElementById('modalImage').src = src;
        document.getElementById('imageModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('imageModal').classList.remove('active');
    }

    function calculateSettlement() {
        if (members.length === 0) {
            document.getElementById('summaryGrid').innerHTML = '';
            document.getElementById('settlementList').innerHTML = '';
            document.getElementById('depositSummary').innerHTML = '';
            return;
        }

        const balanceJPY = Array(members.length).fill(0);
        const balanceUSD = Array(members.length).fill(0);
        const depositJPY = Array(members.length).fill(0);
        const depositUSD = Array(members.length).fill(0);

        // é ã‹ã‚Šé‡‘ã‚’è¨ˆç®—
        deposits.forEach(dep => {
            if (dep.currency === 'JPY') {
                depositJPY[dep.member] += dep.amount;
            } else {
                depositUSD[dep.member] += dep.amount;
            }
        });

        // æ”¯æ‰•ã„ã‚’è¨ˆç®—
        expenses.forEach(exp => {
            const perPerson = exp.amount / exp.participants.length;
            const balance = exp.currency === 'JPY' ? balanceJPY : balanceUSD;

            balance[exp.paidBy] += exp.amount;
            exp.participants.forEach(idx => {
                balance[idx] -= perPerson;
            });
        });

        // é ã‹ã‚Šé‡‘ã‚’å·®ã—å¼•ã
        for (let i = 0; i < members.length; i++) {
            balanceJPY[i] -= depositJPY[i];
            balanceUSD[i] -= depositUSD[i];
        }

        // é ã‹ã‚Šé‡‘ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        displayDepositSummary(depositJPY, depositUSD);

        // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        const summaryDiv = document.getElementById('summaryGrid');
        summaryDiv.innerHTML = members.map((member, idx) => {
            const jpy = balanceJPY[idx];
            const usd = balanceUSD[idx];
            const displayBalance = jpy !== 0 
                ? `Â¥${Math.round(jpy).toLocaleString()}` 
                : usd !== 0 ? `$${usd.toFixed(2)}` : 'Â¥0';
            
            return `
                <div class="summary-card">
                    <div class="summary-label">${member || 'ãƒ¡ãƒ³ãƒãƒ¼' + (idx + 1)}</div>
                    <div class="summary-value">${displayBalance}</div>
                </div>
            `;
        }).join('');

        // ç²¾ç®—ãƒªã‚¹ãƒˆä½œæˆ
        const settlementDiv = document.getElementById('settlementList');
        let settlementHTML = '<h3 style="margin-top: 20px; margin-bottom: 15px; color: #333;">ç²¾ç®—æ–¹æ³•</h3>';

        const settlementsJPY = calculateSettlementTransactions(balanceJPY);
        if (settlementsJPY.length > 0) {
            settlementHTML += '<div style="margin-bottom: 15px; font-weight: 600; color: #667eea;">å†† (JPY)</div>';
            settlementsJPY.forEach(s => {
                const fromName = members[s.from] || 'ãƒ¡ãƒ³ãƒãƒ¼' + (s.from + 1);
                const toName = members[s.to] || 'ãƒ¡ãƒ³ãƒãƒ¼' + (s.to + 1);
                settlementHTML += `
                    <div class="settlement-item">
                        <div class="settlement-text">
                            ${fromName} â†’ ${toName}
                        </div>
                        <div class="settlement-amount">Â¥${Math.round(s.amount).toLocaleString()}</div>
                    </div>
                `;
            });
        }

        const settlementsUSD = calculateSettlementTransactions(balanceUSD);
        if (settlementsUSD.length > 0) {
            settlementHTML += '<div style="margin-top: 20px; margin-bottom: 15px; font-weight: 600; color: #667eea;">ãƒ‰ãƒ« (USD)</div>';
            settlementsUSD.forEach(s => {
                const fromName = members[s.from] || 'ãƒ¡ãƒ³ãƒãƒ¼' + (s.from + 1);
                const toName = members[s.to] || 'ãƒ¡ãƒ³ãƒãƒ¼' + (s.to + 1);
                settlementHTML += `
                    <div class="settlement-item">
                        <div class="settlement-text">
                            ${fromName} â†’ ${toName}
                        </div>
                        <div class="settlement-amount">$${s.amount.toFixed(2)}</div>
                    </div>
                `;
            });
        }

        if (settlementsJPY.length === 0 && settlementsUSD.length === 0) {
            settlementHTML += '<p style="text-align: center; color: #999; padding: 20px;">ç²¾ç®—ã®å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }

        settlementDiv.innerHTML = settlementHTML;
    }

    function displayDepositSummary(depositJPY, depositUSD) {
        const div = document.getElementById('depositSummary');
        const hasDeposits = deposits.length > 0;
        
        if (!hasDeposits) {
            div.innerHTML = '';
            return;
        }

        let html = '<div class="deposit-section"><h3 style="margin-bottom: 10px; color: #92400e;">ğŸ’µ é ã‹ã‚Šé‡‘åˆè¨ˆ</h3>';
        
        members.forEach((member, idx) => {
            if (depositJPY[idx] > 0 || depositUSD[idx] > 0) {
                const memberName = member || 'ãƒ¡ãƒ³ãƒãƒ¼' + (idx + 1);
                html += '<div class="deposit-item">';
                html += `<span class="deposit-label">${memberName}</span>`;
                html += '<div>';
                if (depositJPY[idx] > 0) {
                    html += `<div class="deposit-value">Â¥${depositJPY[idx].toLocaleString()}</div>`;
                }
                if (depositUSD[idx] > 0) {
                    html += `<div class="deposit-value">$${depositUSD[idx].toFixed(2)}</div>`;
                }
                html += '</div></div>';
            }
        });
        
        html += '</div>';
        div.innerHTML = html;
    }

    function calculateSettlementTransactions(balances) {
        const transactions = [];
        const creditors = [];
        const debtors = [];

        balances.forEach((balance, idx) => {
            if (balance > 0.01) {
                creditors.push({ idx, amount: balance });
            } else if (balance < -0.01) {
                debtors.push({ idx, amount: -balance });
            }
        });

        let i = 0, j = 0;
        while (i < creditors.length && j < debtors.length) {
            const creditor = creditors[i];
            const debtor = debtors[j];
            const amount = Math.min(creditor.amount, debtor.amount);

            transactions.push({
                from: debtor.idx,
                to: creditor.idx,
                amount: amount
            });

            creditor.amount -= amount;
            debtor.amount -= amount;

            if (creditor.amount < 0.01) i++;
            if (debtor.amount < 0.01) j++;
        }

        return transactions;
    }

    function displayStatistics() {
        const statsDiv = document.getElementById('statistics');
        
        if (expenses.length === 0) {
            statsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }

        const categoryTotals = {};
        categories.forEach(cat => {
            categoryTotals[cat] = { jpy: 0, usd: 0 };
        });

        let totalJPY = 0;
        let totalUSD = 0;

        expenses.forEach(exp => {
            if (!categoryTotals[exp.category]) {
                categoryTotals[exp.category] = { jpy: 0, usd: 0 };
            }
            
            if (exp.currency === 'JPY') {
                categoryTotals[exp.category].jpy += exp.amount;
                totalJPY += exp.amount;
            } else {
                categoryTotals[exp.category].usd += exp.amount;
                totalUSD += exp.amount;
            }
        });

        let html = '<div style="margin-bottom: 20px;">';
        html += `<h3 style="margin-bottom: 15px; color: #333;">ç·æ”¯å‡º</h3>`;
        if (totalJPY > 0) {
            html += `<div class="summary-card" style="margin-bottom: 10px;"><div class="summary-label">å†† (JPY)</div><div class="summary-value">Â¥${totalJPY.toLocaleString()}</div></div>`;
        }
        if (totalUSD > 0) {
            html += `<div class="summary-card"><div class="summary-label">ãƒ‰ãƒ« (USD)</div><div class="summary-value">$${totalUSD.toFixed(2)}</div></div>`;
        }
        html += '</div>';

        html += '<h3 style="margin-bottom: 15px; color: #333;">ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡º</h3>';
        
        for (const [key, value] of Object.entries(categoryTotals)) {
            if (value.jpy > 0 || value.usd > 0) {
                html += `<div class="settlement-item" style="margin-bottom: 8px;">`;
                html += `<div class="settlement-text">${key}</div>`;
                html += `<div>`;
                if (value.jpy > 0) {
                    html += `<div style="font-weight: 600; color: #667eea;">Â¥${value.jpy.toLocaleString()}</div>`;
                }
                if (value.usd > 0) {
                    html += `<div style="font-weight: 600; color: #667eea;">$${value.usd.toFixed(2)}</div>`;
                }
                html += `</div></div>`;
            }
        }

        statsDiv.innerHTML = html;
    }

    function showSettlementModal() {
        const modal = document.getElementById('settlementModal');
        const display = document.getElementById('settlementDisplay');
        
        let html = '<h2 style="margin-bottom: 20px;">ğŸ’³ ç²¾ç®—æƒ…å ±</h2>';
        html += document.getElementById('depositSummary').innerHTML;
        html += '<div class="summary-grid">' + document.getElementById('summaryGrid').innerHTML + '</div>';
        html += document.getElementById('settlementList').innerHTML;
        
        display.innerHTML = html;
        modal.classList.add('active');
    }

    function closeSettlementModal(event) {
        if (!event || event.target.id === 'settlementModal' || event.target.classList.contains('close-modal')) {
            document.getElementById('settlementModal').classList.remove('active');
        }
    }

    function downloadSettlement() {
        showSettlementModal();
        setTimeout(() => {
            const content = document.getElementById('settlementContent');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const scale = 2;
            canvas.width = content.offsetWidth * scale;
            canvas.height = content.offsetHeight * scale;
            ctx.scale(scale, scale);
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const closeBtn = content.querySelector('.close-modal');
            if (closeBtn) closeBtn.style.display = 'none';
            
            html2canvas(content, {
                canvas: canvas,
                scale: scale,
                backgroundColor: '#ffffff',
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'ç²¾ç®—æƒ…å ±_' + new Date().toISOString().split('T')[0] + '.png';
                link.href = canvas.toDataURL();
                link.click();
                
                if (closeBtn) closeBtn.style.display = 'block';
            }).catch(err => {
                console.error('Screenshot failed:', err);
                alert('ç”»åƒä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                if (closeBtn) closeBtn.style.display = 'block';
            });
        }, 100);
    }

    function exportData() {
        const data = {
            members,
            expenses,
            deposits,
            categories,
            exportDate: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'warikan_data_' + new Date().toISOString().split('T')[0] + '.json';
        link.click();
        URL.revokeObjectURL(url);
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if (data.members) members = data.members;
                if (data.expenses) expenses = data.expenses;
                if (data.deposits) deposits = data.deposits;
                if (data.categories) categories = data.categories;
                
                saveData();
                updateMemberList();
                updateMemberSelects();
                updateCategoryList();
                updateCategorySelect();
                updateDisplay();
                
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
            } catch (err) {
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                console.error(err);
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    function saveData() {
        localStorage.setItem('warikanMembers', JSON.stringify(members));
        localStorage.setItem('warikanExpenses', JSON.stringify(expenses));
        localStorage.setItem('warikanDeposits', JSON.stringify(deposits));
        localStorage.setItem('warikanCategories', JSON.stringify(categories));
    }

    function loadData() {
        const savedMembers = localStorage.getItem('warikanMembers');
        const savedExpenses = localStorage.getItem('warikanExpenses');
        const savedDeposits = localStorage.getItem('warikanDeposits');
        const savedCategories = localStorage.getItem('warikanCategories');

        if (savedMembers) members = JSON.parse(savedMembers);
        if (savedExpenses) expenses = JSON.parse(savedExpenses);
        if (savedDeposits) deposits = JSON.parse(savedDeposits);
        if (savedCategories) categories = JSON.parse(savedCategories);
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
```

</body>
</html>